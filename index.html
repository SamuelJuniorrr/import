<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protótipo do Portal Fluig - Import/Export</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fundo cinza claro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        /* O .container é para o layout geral da aplicação e não para o card de login */
        .container {
            background-color: #ffffff; /* Ajuste para ser o fundo geral dos conteúdos das telas, se necessário */
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 24px; /* Ajuste para ser mais compacto, como o login */
            max-width: 400px; /* Largura mais estreita para o cartão de login e modais */
            width: 100%;
        }
        /* Novo wrapper para conteúdo principal de telas maiores */
        .app-content-wrapper {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 32px;
            max-width: 2400px; /* Mais largo para as telas principais, conforme solicitado */
            width: 100%;
            margin: 0 auto; /* Centraliza o wrapper */
        }

        .header {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        /* Estilo para inputs de formulário padrão */
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px; /* Cantos arredondados para inputs */
            font-size: 1rem;
            color: #374151;
        }
        /* Estilo específico para inputs de login com ícones, imitando image_1e26c4.png */
        .login-input-group {
            display: flex;
            align-items: center;
            border: 1px solid #d1d5db; /* Borda para todo o grupo de input */
            border-radius: 4px; /* Cantos menos arredondados para o grupo, combinando com a imagem */
            padding: 8px 12px; /* Preenchimento dentro do grupo */
            margin-bottom: 15px; /* Espaço entre inputs de login */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #ffffff; /* Fundo explicitamente branco */
        }
        .login-input-group:focus-within {
            border-color: #3b82f6; /* Borda azul no foco */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25); /* Sombra sutil no foco */
            background-color: #ffffff; /* Manter branco no foco */
        }
        .login-input-group .icon-svg {
            color: #9ca3af; /* Cor cinza para ícones */
            margin-right: 8px;
            flex-shrink: 0; /* Impedir que o ícone encolha */
        }
        .login-input-group input {
            flex-grow: 1; /* Input ocupa o espaço restante */
            padding: 0; /* Sem preenchimento para o próprio input, tratado pelo pai */
            border: none; /* Sem borda individual para o input */
            outline: none; /* Remover contorno no foco */
            background-color: transparent; /* Fundo transparente, permitindo o branco do pai */
            font-size: 1rem;
            color: #333;
        }
        .login-input-group input::placeholder {
            color: #9ca3af;
        }

        /* Campo de descrição não editável */
        #productDescriptionDisplayHK, #mappedProductCodeDisplayHK, #productValueHK, #totalM3DisplayHK, #productDescriptionDisplayCOL, #productStockCOL, #valorUnitCOLDisplay, #productCodeCOLDisplay {
            padding: 10px 12px; /* Preenchimento ajustado para combinar com a altura do input */
            border: 1px solid #d1d5db; /* Borda cinza clara */
            border-radius: 8px;
            background-color: #f9fafb; /* Fundo ligeiramente diferente para distinção visual */
            color: #4b5563; /* Texto cinza mais escuro */
            font-size: 1rem;
            min-height: 42px; /* Garantir que corresponda à altura de outros inputs */
            display: flex;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 4px; /* Cantos menos arredondados para botões, combinando com a imagem */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .btn-primary {
            background-color: #3b82f6; /* Azul */
            color: #ffffff;
            border: none;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Azul mais escuro no hover */
        }
        .btn-secondary {
            background-color: #f3f4f6; /* Cinza claro */
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb; /* Cinza claro mais escuro no hover */
        }
        .product-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            background-color: #f9fafb;
        }
        .message-box {
            background-color: #dbeafe; /* Azul claro */
            border: 1px solid #93c5fd; /* Azul médio */
            color: #1e40af; /* Azul escuro */
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .error-message {
            background-color: #fee2e2; /* Vermelho claro */
            border: 1px solid #ef4444; /* Vermelho */
            color: #b91c1c; /* Vermelho escuro */
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: 500;
        }
        /* Estilo para feedback de MOQ ao vivo */
        .moq-feedback-ok {
            color: #16a34a; /* Verde */
            font-size: 0.875rem;
            margin-top: 4px;
        }
        .moq-feedback-error {
            color: #dc2626; /* Vermelho */
            font-size: 0.875rem;
            margin-top: 4px;
        }
        /* Estilo da tabela */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .data-table th, .data-table td {
            padding: 12px 16px; /* Preenchimento aumentado para melhor legibilidade */
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase; /* Combinar com a tabela da central de tarefas */
            font-size: 0.85rem; /* Ligeiramente menor para cabeçalhos de tabela */
            white-space: nowrap; /* Impede quebra de linha em cabeçalhos */
        }
        .data-table td {
             white-space: nowrap; /* Impede quebra de linha em células de dados por padrão */
        }
        .data-table tbody tr:last-child td {
            border-bottom: none; /* Remover a borda inferior para a última linha */
        }
        .data-table tbody tr:hover {
            background-color: #f3f4f6; /* Efeito de hover para linhas da tabela */
        }

        /* Garantir que .hidden esconda elementos definitivamente */
        .hidden {
            display: none !important;
        }
        /* Layout Específico da Tela de Login e Estilo do Cartão - Corresponde a image_1e26c4.png */
        #loginScreen {
            width: 100%;
            height: 100vh; /* Ocupa a altura total da viewport */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f3f4f6; /* Fundo cinza */
        }
        .login-card {
            background-color: #ffffff; /* Fundo branco para o cartão */
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 320px; /* Largura mais estreita para o cartão */
            width: 100%;
            text-align: center;
        }
        .login-logo {
            margin-bottom: 25px; /* Espaço abaixo do logo */
            text-align: center;
        }
        .login-logo img {
            max-width: 120px;
            display: inline-block;
            margin: 0 auto;
        }
        .forgot-password-link {
            font-size: 0.85rem;
            color: #3b82f6;
            margin-top: 15px;
            display: block;
            text-decoration: none;
            text-align: center;
        }
        .forgot-password-link:hover {
            text-decoration: underline;
        }

        /* Removendo o cabeçalho padrão do .container para a tela de login */
        #loginScreen .header {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        /* Estilo para input de quantidade dentro da tabela de produtos */
        .product-quantity-input {
            width: 80px; /* Largura fixa para input de quantidade */
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
        }
        .add-to-cart-btn {
            background-color: #22c55e; /* Botão verde */
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .add-to-cart-btn:hover {
            background-color: #16a34a; /* Verde mais escuro no hover */
        }

        /* Estilos para a Tela da Central de Pedidos (baseado na Central de Tarefas) */
        #orderCenterScreen {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh; /* Ocupa a altura total da viewport */
            box-shadow: none; /* Remove sombra do container se aplicada aqui */
            padding: 0; /* Remove preenchimento do container se aplicado aqui */
            margin: 0; /* Remove margem do container se aplicado aqui */
            background-color: #f3f4f6; /* Define o fundo do corpo, não do container */
            overflow: auto; /* Permite rolagem se o conteúdo exceder */
        }
        #orderCenterScreen .header { /* Usar o estilo de cabeçalho geral */
            padding-top: 20px;
            margin-bottom: 16px;
        }
        #orderCenterScreen .btn-primary {
            padding: 8px 16px;
            border-radius: 8px;
        }
        #orders-table-container { /* Aplicar estilo semelhante à tela de resumo */
            flex-grow: 1; /* Permite que a tabela ocupe o espaço restante */
            overflow-x: auto; /* Adiciona scroll horizontal apenas à tabela se necessário */
        }
        #orderCenterTable {
            width: 100%; /* Garante que a tabela use toda a largura disponível */
            min-width: 1100px; /* Define uma largura mínima para evitar encolhimento excessivo */
        }
        #orderCenterTable .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        /* Nova categorização de cores para os status atualizados */
        #orderCenterTable .status-indicator.green { background-color: #22c55e; } /* Aprovado, Carga Pronta, Entregue, Carga Entregue */
        #orderCenterTable .status-indicator.red { background-color: #ef4444; } /* Rejeitado */
        #orderCenterTable .status-indicator.yellow { background-color: #eab308; } /* Pendente, Aguardando Aprovação, Em Negociação */
        #orderCenterTable .status-indicator.blue { background-color: #3b82f6; } /* Em Processamento (genérico), Em Separação, Em Conferência, Em Rota de Entrega */
        #orderCenterTable .status-indicator.gray { background-color: #6b7280; } /* Cancelado */


        #orderCenterTable tbody tr:hover {
            background-color: #f3f4f6; /* Cinza claro mais escuro no hover para todas as linhas */
        }
        /* Estilo para número de pedido clicável */
        #orderCenterTable tbody tr td a.order-link {
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
        }
        #orderCenterTable tbody tr td a.order-link:hover {
            color: #2563eb;
        }
        /* Estilo da imagem da bandeira */
        .flag-icon {
            width: 24px; /* Ajustar tamanho conforme necessário */
            height: auto;
            border-radius: 2px; /* Cantos ligeiramente arredondados para bandeiras */
            vertical-align: middle; /* Alinhar com o texto */
            margin-right: 0px; /* Margem direita removida, pois há apenas a bandeira */
            box-shadow: 0 0 2px rgba(0,0,0,0.2); /* Sombra sutil para bandeiras */
        }

        /* Tela de Detalhes do Pedido */
        #orderDetailsScreen .detail-item {
            padding: 10px 0;
            border-bottom: 1px dashed #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #orderDetailsScreen .detail-item:last-child {
            border-bottom: none;
        }
        #orderDetailsScreen .detail-item strong {
            color: #4b5563;
        }
        #orderDetailsScreen .detail-item span {
            color: #1f2937;
        }
        #orderDetailsScreen .product-details-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        #orderDetailsScreen .product-details-table th,
        #orderDetailsScreen .product-details-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
        }
        #orderDetailsScreen .product-details-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        #orderDetailsScreen .product-details-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        /* Estilos para o Tracking do Pedido */
        .tracking-steps {
            display: flex;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            justify-content: space-between;
            margin-top: 20px;
            padding: 20px 0;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }

        .tracking-step {
            flex: 1; /* Distribui o espaço igualmente */
            min-width: 120px; /* Largura mínima para cada etapa */
            text-align: center;
            position: relative;
            padding-top: 30px; /* Espaço para o círculo e linha */
            color: #9ca3af; /* Cor padrão para inativo/futuro */
            font-size: 0.875rem;
            font-weight: 500;
        }
        .tracking-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            left: calc(50% + 15px); /* Inicia após o círculo */
            width: calc(100% - 30px); /* Largura da linha entre os círculos */
            height: 2px;
            background-color: #e5e7eb; /* Cor da linha para status futuros */
            z-index: 0;
        }
        .tracking-step .circle {
            width: 30px;
            height: 30px;
            background-color: #e5e7eb; /* Cor padrão para inativo/futuro */
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: bold;
            z-index: 1; /* Para ficar acima da linha */
        }

        /* Estilos para o status atual e anteriores */
        .tracking-step.completed {
            color: #1f2937; /* Texto escuro para concluído */
        }
        .tracking-step.completed .circle {
            background-color: #22c55e; /* Verde para concluído */
        }
        .tracking-step.completed:not(:last-child)::after {
            background-color: #22c55e; /* Linha verde para concluído */
        }
        .tracking-step.active {
            color: #3b82f6; /* Azul para ativo */
            font-weight: 600;
        }
        .tracking-step.active .circle {
            background-color: #3b82f6; /* Azul para ativo */
            border: 2px solid #2563eb; /* Borda mais escura para destaque */
            transform: translateX(-50%) scale(1.1); /* Um pouco maior */
        }
        /* Estilos para Rejeitado/Cancelado quando são o status ATUAL */
        .tracking-step.rejected.active, .tracking-step.cancelled.active {
            color: #dc2626; /* Vermelho para rejeitado/cancelado */
            font-weight: 600;
        }
        .tracking-step.rejected.active .circle, .tracking-step.cancelled.active .circle {
            background-color: #dc2626; /* Vermelho para rejeitado/cancelado */
            border: 2px solid #b91c1c;
        }

        /* Cores específicas para os círculos quando ATIVOS ou COMPLETED */
        /* Hong Kong Specific */
        .tracking-step.negotiation.active .circle,
        .tracking-step.negotiation.completed .circle {
            background-color: #eab308; /* Amarelo para Em Negociação */
            border-color: #b45309;
        }
        .tracking-step.waiting-approval.active .circle,
        .tracking-step.waiting-approval.completed .circle {
            background-color: #f97316; /* Laranja para Aguardando Aprovação */
            border-color: #c2410c;
        }
        .tracking-step.approved.active .circle,
        .tracking-step.approved.completed .circle { /* Aprovado pode ser completo ou ativo */
            background-color: #22c55e; /* Verde */
            border-color: #16a34a;
        }
        .tracking-step.ready-cargo.active .circle,
        .tracking-step.ready-cargo.completed .circle {
            background-color: #06b6d4; /* Ciano para Carga Pronta */
            border-color: #0891b2;
        }
        .tracking-step.in-transit.active .circle,
        .tracking-step.in-transit.completed .circle {
            background-color: #8b5cf6; /* Roxo para Carga Em rota de Entrega / Em Rota de Entrega */
            border-color: #7c3aed;
        }
        .tracking-step.delivered.active .circle,
        .tracking-step.delivered.completed .circle {
            background-color: #22c55e; /* Verde para Carga Entregue / Entregue */
            border-color: #16a34a;
        }
        /* Colombia Specific (ERP-like) */
        .tracking-step.separation.active .circle,
        .tracking-step.separation.completed .circle {
            background-color: #a78bfa; /* Light purple for Em Separação */
            border-color: #9333ea;
        }
        .tracking-step.conference.active .circle,
        .tracking-step.conference.completed .circle {
            background-color: #6d28d9; /* Darker purple for Em Conferência */
            border-color: #5b21b6;
        }
        
        /* Estilos específicos do modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 24px; /* Ajuste aqui também para modais */
            max-width: 400px; /* Ajustado para o tamanho do pop-up, para seguir o container */
            width: 90%; /* Largura responsiva */
            text-align: center;
        }
        /* Corrigido: Modal de Seleção de Filial deve ser mais compacto */
        #filialSelectionModal .modal-content {
            max-width: 400px; /* Mantém a largura compacta como os outros modais */
        }


        /* Estilos específicos para o modal do catálogo de produtos */
        #productCatalogModal .modal-content {
            max-width: 700px;
            text-align: left;
        }
        #productCatalogSearchInput {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            width: 100%;
            margin-bottom: 16px;
        }
        #productCatalogList {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 10px;
            background-color: #fff;
        }
        /* Estilo da tabela do catálogo de produtos */
        #productCatalogList .data-table th,
        #productCatalogList .data-table td {
            padding: 10px 12px;
        }
        #productCatalogList .data-table tbody tr {
            cursor: pointer;
        }
        #productCatalogList .data-table tbody tr:hover {
            background-color: #f3f4f6;
        }
        #productCatalogList .data-table .product-code-display {
            font-weight: 600;
            color: #1f2937;
        }
        #productCatalogList .data-table .product-description-display {
            color: #374151;
        }
        #productCatalogList .data-table .product-line-display {
            color: #6b7280;
            font-size: 0.85rem;
        }

        .input-with-icon {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-with-icon input {
            padding-right: 40px; /* Espaço para o ícone */
        }
        .input-with-icon .search-icon {
            position: absolute;
            right: 12px;
            cursor: pointer;
            color: #9ca3af;
        }
        .add-product-message {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.875rem;
            text-align: center;
        }
        .add-product-message.success {
            background-color: #d1fae5; /* Verde claro */
            color: #065f46; /* Verde escuro */
        }
        .add-product-message.error {
            background-color: #fee2e2; /* Vermelho claro */
            border: 1px solid #ef4444; /* Vermelho */
            color: #b91c1c; /* Vermelho escuro */
        }
        .add-product-message.info {
            background-color: #e0f2fe; /* Azul claro */
            color: #0c4a6e; /* Azul escuro */
        }

        /* Estilos para a Tela de Resumo para combinar com a Central de Pedidos */
        #hongKongSummaryScreen {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
            box-shadow: none;
            padding: 0;
            margin: 0;
            background-color: #f3f4f6;
        }
        #hongKongSummaryScreen .header {
            padding-top: 20px;
            margin-bottom: 16px;
        }
        /* Estilos específicos para a tela de Aprovação do Renato */
        #renatoApprovalScreen {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
            background-color: #f3f4f6;
            padding: 20px; /* Adiciona padding ao redor do conteúdo principal */
            box-sizing: border-box; /* Inclui padding na largura e altura */
        }
        #renatoApprovalScreen .content-area {
            background-color: #ffffff; /* Fundo branco para o conteúdo principal */
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 32px;
            text-align: left; /* Alinhar texto à esquerda */
            max-width: 2400px; /* Define largura máxima para a área de conteúdo, conforme solicitado */
            width: 100%;
            margin: 0 auto; /* Centraliza a área de conteúdo */
        }

        #renatoApprovalScreen .supplier-summary-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative; /* Para o indicador de status */
        }

        .price-difference-positive {
            color: #dc2626; /* Vermelho para aumento de custo */
            font-weight: 700;
        }

        .price-difference-negative {
            color: #16a34a; /* Verde para economia */
            font-weight: 700;
        }

        .supplier-status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        /* Estilos para a tela de carregamento da análise */
        #analysisLoadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Fundo escuro para destacar */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Acima de outros modais */
            color: #ffffff;
            text-align: center;
        }
        #analysisLoadingScreen .spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #3b82f6; /* Cor azul do tema */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #analysisLoadingScreen .message {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        #analysisLoadingScreen .sub-message {
            font-size: 1rem;
            color: #d1d5db;
        }

        /* Estilos para as abas */
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-weight: 600;
            color: #6b7280;
            position: relative;
            bottom: -1px; /* Para sobrepor a borda inferior */
        }
        .tab-button.active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }
        .tab-content {
            padding-top: 20px;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        .collapsible-header:hover {
            color: #1f2937;
        }
        .collapsible-content {
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 10px;
        }
        .collapsible-content:last-child {
            border-bottom: none;
        }
        .collapsible-icon {
            transition: transform 0.3s ease;
        }
        .collapsible-header.open .collapsible-icon {
            transform: rotate(180deg);
        }

        /* Estilos para os botões de aprovação/negociação/rejeição */
        .approval-buttons-group .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem; /* Menor para caber na tabela */
            border-radius: 4px;
            margin: 2px; /* Pequena margem entre os botões */
        }
        .approval-buttons-group .btn-approve {
            background-color: #22c55e; /* Verde */
            color: white;
        }
        .approval-buttons-group .btn-approve.selected {
            outline: 2px solid #16a34a; /* Borda mais escura para selecionado */
            outline-offset: 1px;
        }
        .approval-buttons-group .btn-negotiate {
            background-color: #eab308; /* Amarelo */
            color: white;
        }
        .approval-buttons-group .btn-negotiate.selected {
            outline: 2px solid #b45309;
            outline-offset: 1px;
        }
        .approval-buttons-group .btn-reject {
            background-color: #ef4444; /* Vermelho */
            color: white;
        }
        .approval-buttons-group .btn-reject.selected {
            outline: 2px solid #be123c;
            outline-offset: 1px;
        }
        /* Status display for each product in Renato's screen */
        .product-approval-status {
            font-weight: 600;
        }
        .product-approval-status.Pendente {
            color: #6b7280; /* Cinza */
        }
        .product-approval-status.Aprovado {
            color: #16a34a; /* Verde */
        }
        .product-approval-status.Negociar {
            color: #d97706; /* Laranja */
        }
        .product-approval-status.Rejeitado {
            color: #dc2626; /* Vermelho */
        }
        /* Estilo específico para a tabela de produtos adicionados (Hong Kong/Colômbia) */
        #productListHK .data-table,
        #productListCOL .data-table {
            min-width: 950px; /* Largura mínima para evitar quebra de linha */
        }
    </style>
</head>
<body>
    <div id="app" class="w-full flex justify-center items-center min-h-screen">
        <!-- Tela de Login -->
        <div id="loginScreen" class="screen">
            <div class="login-card"> <!-- Removido a classe 'container' daqui para usar o estilo mais específico do .login-card -->
                <div class="login-logo">
                    <!--  -->
                    <img src="https://placehold.co/120x40/FFFFFF/000000?text=TOTVS+FLUIG" alt="Logo TOTVS Fluig">
                </div>
                <div class="space-y-4">
                    <div class="login-input-group">
                        <!-- Ícone de Usuário -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-svg"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <input type="text" id="username" placeholder="Usuário">
                    </div>
                    <div class="login-input-group">
                        <!-- Ícone de Cadeado -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-svg"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <input type="password" id="password" placeholder="Senha">
                    </div>
                    <button onclick="login()" class="btn btn-primary w-full mt-6">ACESSAR</button>
                </div>
                <a href="#" onclick="showMessage('Funcionalidade: Esqueceu sua senha?', 'Esta é uma funcionalidade simulada.')" class="forgot-password-link">Esqueceu sua senha?</a>
            </div>
        </div>

        <!-- Central de Pedidos -->
        <div id="orderCenterScreen" class="screen hidden">
            <div class="app-content-wrapper"> <!-- Usando o novo wrapper para conteúdo principal -->
                <div class="header flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Central de Pedidos</h1>
                    <button class="btn-primary" onclick="openFilialSelectionModal()">
                        Nova Solicitação
                    </button>
                </div>

                <!-- Seção de Filtro -->
                <div class="flex flex-wrap items-end gap-3 mb-4"> <!-- Use flex-wrap for responsiveness -->
                    <div class="flex-1 min-w-[150px]">
                        <label for="statusFilter" class="block text-sm font-medium text-gray-700">Status:</label>
                        <select id="statusFilter" class="rounded-lg p-2 border border-gray-300 w-full" onchange="renderOrdersTable()">
                            <option value="">Todos</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Em Processamento">Em Processamento</option>
                            <option value="Aprovado">Aprovado</option>
                            <option value="Rejeitado">Rejeitado</option>
                            <option value="Cancelado">Cancelado</option>
                            <!-- Adicionar opções para novos status HK -->
                            <option value="Em Negociação">Em Negociação</option>
                            <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                            <option value="Carga Pronta">Carga Pronta</option>
                            <option value="Carga Em rota de Entrega">Carga Em rota de Entrega</option>
                            <option value="Carga Entregue">Carga Entregue</option>
                            <!-- Adicionar opções para novos status Colômbia -->
                            <option value="Em Separação">Em Separação</option>
                            <option value="Em Conferência">Em Conferência</option>
                            <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                            <option value="Entregue">Entregue</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label for="supplierFilter" class="block text-sm font-medium text-gray-700">Fornecedor:</label>
                        <select id="supplierFilter" class="rounded-lg p-2 border border-gray-300 w-full" onchange="renderOrdersTable()">
                            <option value="">Todos</option>
                            <!-- Fornecedores serão carregados dinamicamente aqui por JS -->
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label for="originCountryFilter" class="block text-sm font-medium text-gray-700">País Origem:</label>
                        <select id="originCountryFilter" class="rounded-lg p-2 border border-gray-300 w-full" onchange="renderOrdersTable()">
                            <option value="">Todos</option>
                            <!-- Países serão carregados dinamicamente aqui por JS -->
                        </select>
                    </div>
                    <div class="relative flex items-center flex-1 min-w-[200px] mt-6 sm:mt-0"> <!-- Adjust margin for alignment on small screens -->
                        <label for="orderSearch" class="sr-only">Buscar por Nº Pedido ou Cliente</label>
                        <input type="text" id="orderSearch" placeholder="Buscar por Nº Pedido ou Cliente"
                               class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               oninput="renderOrdersTable()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 0 0010.607 10.607z" />
                        </svg>
                    </div>
                </div>

                <!-- Contêiner da Tabela de Pedidos -->
                <div id="orders-table-container" class="overflow-x-auto"> <!-- Adicionado overflow-x aqui -->
                    <table id="orderCenterTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Id Solicitação Principal</th> <!-- Título atualizado para clareza -->
                                <th>Nº Pedido</th> 
                                <th>Origem</th>
                                <th>País Origem</th>
                                <th>Fornecedor</th> 
                                <th>Valor Total</th>
                                <th>Status do Pedido</th>
                                <th>Data Solicitação/Criação</th>
                                <th>Data Última Alteração</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Pedidos serão carregados dinamicamente aqui por JS -->
                        </tbody>
                    </table>
                </div>
                <button onclick="logout()" class="btn btn-secondary w-full mt-6">Sair (Logout)</button>
            </div>
        </div>

        <!-- Tela de Detalhes do Pedido -->
        <div id="orderDetailsScreen" class="screen hidden app-content-wrapper"> <!-- Ajustado para app-content-wrapper -->
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Detalhes do Pedido <span id="currentOrderId"></span></h1>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
                <h3 class="font-semibold text-lg mb-4">Informações Gerais</h3>
                <div class="space-y-2">
                    <div class="detail-item">
                        <strong>Nº Pedido:</strong> <span id="detailOrderId"></span>
                    </div>
                    <div class="detail-item">
                        <strong>ID Principal:</strong> <span id="detailParentOrderId"></span> <!-- Renomeado -->
                    </div>
                    <div class="detail-item">
                        <strong>Origem:</strong> <span id="detailOriginDisplay"></span> <!-- Campo de origem atualizado -->
                    </div>
                    <div class="detail-item">
                        <strong>Fornecedor:</strong> <span id="detailSupplier"></span> <!-- Novo campo Fornecedor -->
                    </div>
                    <div class="detail-item">
                        <strong>Valor Total:</strong> <span id="detailTotalValue"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Status do Pedido:</strong> <span id="detailStatus"></span> <!-- Ainda exibe o status direto -->
                    </div>
                    <div class="detail-item">
                        <strong>Data Solicitação/Criação:</strong> <span id="detailRequestDate"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Data Última Alteração:</strong> <span id="detailLastUpdateDate"></span>
                    </div>
                </div>

                <h3 class="font-semibold text-lg mt-6 mb-4">Status de Rastreamento</h3>
                <div id="orderTrackingSection">
                    <!-- Tracking steps will be rendered here dynamically -->
                </div>

                <h3 class="font-semibold text-lg mt-6 mb-4">Produtos do Pedido</h3>
                <div class="table-container border border-gray-200 rounded-lg overflow-hidden">
                    <table class="product-details-table">
                        <thead>
                            <tr>
                                <th>Código Produto</th>
                                <th>Descrição</th>
                                <th>Quantidade</th>
                                <th>Valor Unitário</th>
                                <th>Valor Total Item</th>
                            </tr>
                        </thead>
                        <tbody id="orderDetailsProductsTableBody">
                            <!-- Detalhes do produto serão carregados dinamicamente aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
            <button onclick="backToOrderCenter()" class="btn btn-secondary w-full mt-6">Voltar para Central de Pedidos</button>
        </div>


        <!-- Modal de Seleção de Filial -->
        <div id="filialSelectionModal" class="modal-overlay hidden">
            <div class="modal-content"> <!-- Corrigido: Removida a classe 'container' e ajustado max-width para o estilo do modal -->
                <div class="header">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Escolha a Filial</h1>
                    <p class="text-gray-600">Para qual filial você deseja enviar a solicitação?</p>
                </div>
                <div class="flex flex-col md:flex-row gap-6 justify-center">
                    <button onclick="selectFilial('colombia')" class="btn btn-primary md:w-1/2">Colômbia</button>
                    <button onclick="selectFilial('hongkong')" class="btn btn-primary md:w-1/2">Hong Kong</button>
                </div>
                <button onclick="closeFilialSelectionModal()" class="btn btn-secondary w-full mt-6">Voltar</button>
            </div>
        </div>

        <!-- Hong Kong Flow Screens -->
        <div id="hongKongFormScreen" class="screen hidden">
            <div class="app-content-wrapper"> <!-- Usando o novo wrapper para conteúdo principal -->
                <div class="header">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Solicitação de Compra - Hong Kong</h1>
                    <p class="text-gray-600">Por favor, preencha os detalhes dos produtos desejados.</p>
                </div>

                <!-- Campo opcional: Número do Pedido do Cliente -->
                <div class="mb-4">
                    <label for="clientOrderNumberHK" class="block text-sm font-medium text-gray-700">Número do Pedido (Opcional):</label>
                    <input type="text" id="clientOrderNumberHK" placeholder="Seu número de referência do pedido"
                        class="rounded-lg p-2 border border-gray-300 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="tab-buttons" id="hkTabButtons">
                    <!-- Pedido Fácil vem primeiro agora -->
                    <button class="tab-button active" onclick="switchTab('hongkong', 'easy')">Pedido Fácil</button>
                    <button class="tab-button" onclick="switchTab('hongkong', 'manual')">Pedido Manual</button>
                </div>

                <!-- Pedido Fácil Tab Content (agora vem antes) -->
                <div id="hongKongEasyOrderTab" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedido Fácil</h2>
                    <p class="text-gray-600 mb-6">Escolha uma das opções abaixo para adicionar os produtos ao carrinho de compras</p>

                    <!-- Upload de Planilha -->
                    <div class="border p-4 rounded-lg bg-gray-50 mb-6">
                        <div class="collapsible-header" onclick="toggleCollapsible(this, 'uploadSheetContentHK')">
                            <h3 class="font-semibold text-gray-700">Upload de Planilha</h3>
                            <svg class="collapsible-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="uploadSheetContentHK" class="collapsible-content hidden">
                            <p class="mb-4 text-gray-600">Selecione o arquivo no seu computador para fazer o upload.</p>
                            <div class="flex items-center gap-4 mb-4">
                                <input type="file" id="fileUploadHK" accept=".csv" class="hidden" onchange="displayFileName('fileUploadHK', 'fileNameDisplayHK')">
                                <button onclick="document.getElementById('fileUploadHK').click()" class="btn btn-secondary">Selecionar arquivo</button>
                                <span id="fileNameDisplayHK" class="text-gray-600 italic">Nenhum arquivo selecionado</span>
                            </div>
                            <p class="text-sm text-gray-500 mb-4">O tamanho do arquivo não deve ultrapassar 5MB. Formato aceito: .csv</p>
                            <button onclick="handleFileUpload('hongkong')" class="btn btn-primary w-full">Fazer Upload</button>
                        </div>
                    </div>

                    <!-- Copiar e Colar Códigos -->
                    <div class="border p-4 rounded-lg bg-gray-50 mb-6">
                        <div class="collapsible-header" onclick="toggleCollapsible(this, 'copyPasteContentHK')">
                            <h3 class="font-semibold text-gray-700">Copiar e Colar Códigos</h3>
                            <svg class="collapsible-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="copyPasteContentHK" class="collapsible-content hidden">
                            <p class="mb-4 text-gray-600">Cole os códigos de produto e quantidades (um por linha, ex: COD1,5):</p>
                            <textarea id="pasteCodesHK" rows="5" class="w-full p-2 border rounded-lg mb-4"></textarea>
                            <button onclick="processPastedCodes('hongkong')" class="btn btn-primary w-full">Adicionar Códigos</button>
                        </div>
                    </div>

                    <!-- Saiba como utilizar nosso modelo de planilha -->
                    <div class="mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Saiba como utilizar nosso modelo de planilha</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/e0f2fe/0c4a6e?text=c%C3%B3digo+comercial" alt="Passo 1" class="mx-auto mb-4">
                                <p class="font-semibold text-lg mb-2">Passo 1</p>
                                <p class="text-gray-600">Faça o download do modelo de planilha. Abra a planilha no seu computador e preencha com o código comercial e a quantidade do produto desejado. Máximo de 50 linhas de produtos por pedido.</p>
                                <button onclick="downloadSpreadsheetModel()" class="text-blue-600 hover:underline mt-2 inline-block">Modelo de Planilha</button>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/e0f2fe/0c4a6e?text=%2B5MB" alt="Passo 2" class="mx-auto mb-4">
                                <p class="font-semibold text-lg mb-2">Passo 2</p>
                                <p class="text-gray-600">Com sua planilha pronta e salva no seu computador, clique em Selecionar arquivo. Em seguida, clique em Fazer upload. O tamanho da planilha não deve ultrapassar 5MB de tamanho.</p>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/e0f2fe/0c4a6e?text=%F0%9F%9B%92+50" alt="Passo 3" class="mx-auto mb-4">
                                <p class="font-semibold text-lg mb-2">Passo 3</p>
                                <p class="text-gray-600">Com sua planilha pronta e salva no seu computador, clique em Selecionar arquivo. Em seguida, clique em Fazer upload. O tamanho da planilha não deve ultrapassar 5MB de tamanho.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pedido Manual Tab Content (agora vem depois do Pedido Fácil) -->
                <div id="hongKongManualOrderTab" class="tab-content hidden">
                    <!-- Seção para adicionar um novo produto, imitando a linha única da imagem -->
                    <div class="mb-6 border p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-gray-700 mb-4">Adicionar Produtos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div class="col-span-1">
                                <label for="clientProductCodeHK" class="block text-sm font-medium text-gray-700">Cód Prod Cliente:</label>
                                <div class="input-with-icon">
                                    <input type="text" id="clientProductCodeHK" placeholder="Cód Cliente"
                                        oninput="updateProductDetailsOnClientCodeChangeHK()"
                                        class="rounded-lg p-2 border border-gray-300 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <svg onclick="openProductCatalogModal('hongkong')" class="search-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label for="mappedProductCodeDisplayHK" class="block text-sm font-medium text-gray-700">Cód Produto:</label>
                                <div id="mappedProductCodeDisplayHK" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    --
                                </div>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <label for="productDescriptionDisplayHK" class="block text-sm font-medium text-gray-700">Descrição:</label>
                                <div id="productDescriptionDisplayHK" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    --
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label for="productQuantityHK" class="block text-sm font-medium text-gray-700">Qtd.:</label>
                                <input type="number" id="productQuantityHK" min="1" value="1"
                                    oninput="checkMoqLiveHK(); calculateTotalM3HK();"
                                    class="rounded-lg p-2 border border-gray-300 w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="col-span-1">
                                <label for="productValueHK" class="block text-sm font-medium text-gray-700">Valor Unit.:</label>
                                <div id="productValueHK" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    R$ 0,00
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label for="totalM3DisplayHK" class="block text-sm font-medium text-gray-700">M³ Total:</label>
                                <div id="totalM3DisplayHK" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    0.00 m³
                                </div>
                            </div>
                            <div class="col-span-full flex justify-end">
                                <button onclick="addProductHK()" class="btn btn-secondary">Adicionar Produto</button>
                            </div>
                        </div>
                        <div id="addProductMessageHK" class="add-product-message hidden"></div>
                    </div>
                    <div id="moqLiveFeedbackHK" class="text-xs mt-1"></div> <!-- Feedback de MOQ abaixo da lista de produtos -->
                </div>
                
                <!-- Produtos Adicionados na Solicitação (fora das abas, para ser comum) -->
                <div id="productListHK" class="mt-4 border p-4 rounded-lg bg-gray-50 max-h-80 overflow-y-auto">
                    <h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados na Solicitação:</h3>
                    <div id="noProductsAddedHK" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>
                    <!-- Produtos serão listados aqui em uma tabela -->
                </div>

                <div class="flex flex-col md:flex-row gap-4 mt-6">
                    <button onclick="backToFilialSelectionFromForm()" class="btn btn-secondary flex-1">Voltar</button>
                    <button onclick="submitHongKongForm()" class="btn btn-primary flex-1">Enviar Solicitação</button>
                </div>
            </div>
        </div>

        <div id="hongKongSummaryScreen" class="screen hidden">
            <div class="app-content-wrapper"> <!-- Usando o novo wrapper para conteúdo principal -->
                <div class="header flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Resumo da Solicitação - Hong Kong</h1>
                    <button onclick="backToProductEntry()" class="btn btn-secondary">Voltar e Ajustar</button>
                </div>
                <div class="summary-content-wrapper"> <!-- Novo wrapper para conteúdo -->
                    <div id="moqValidationResult"></div>
                    <div id="supplierSplitResult" class="mt-4"></div>
                    <!-- <div id="cubagemPricePrediction" class="mt-4"></div> REMOVIDO DAQUI -->
                    <div class="mt-6 flex gap-4 justify-between" id="hkSummaryButtons">
                        <button onclick="generatePO()" class="btn btn-primary flex-1">Salvar Solicitação</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="purchaseOrderScreen" class="screen hidden container">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Solicitação Gerada</h1>
                <p class="text-gray-600 mb-4">A solicitação foi gerada e enviada para Compras Internacionais.</p>
            </div>
            <div id="poDetails" class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <!-- Detalhes da PO serão injetados aqui -->
            </div>
            <div class="mt-6 text-center text-gray-600">
                <p>Aguardando negociação de Compras Internacionais e aprovação do Renato.</p>
                <button onclick="simulateRenatoApprovalScreen()" class="btn btn-primary mt-4">Simular Aprovação do Renato</button>
            </div>
        </div>

        <div id="renatoApprovalScreen" class="screen hidden">
            <div class="app-content-wrapper content-area">
                <div class="header">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Aprovação de Preços - Gerencial</h1>
                    <p class="text-gray-600 mb-4">Análise das diferenças de preço por fornecedor para aprovação final.</p>
                </div>
                <!-- Step 1: List of Pending Parent Orders -->
                <div id="pendingOrdersList">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos Pendentes de Aprovação</h2>
                    <div class="overflow-x-auto"> <!-- Added for horizontal scroll if table overflows -->
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Id Solicitação Principal</th> 
                                    <th>Nº Pedido</th> 
                                    <th>Cliente</th>
                                    <th>Fornecedor (Nome)</th>
                                    <th>Valor Total do Pedido</th>
                                    <th>Data Inclusão</th>
                                    <th>Data Última Atualização</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="pendingOrdersTableBody">
                                <!-- Pending individual POs will be listed here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Step 2: Detailed Approval View (initially hidden) -->
                <div id="detailedApprovalView" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="backToPendingOrdersList()" class="btn btn-secondary">← Voltar para a Lista</button>
                        <p class="font-semibold text-lg">Análise Detalhada para Pedido: <strong id="currentDetailedParentOrderIdDisplay"></strong></p>
                    </div>

                    <div id="overallComparisonSummary" class="mb-6 p-4 border rounded-lg bg-blue-50 text-blue-800 shadow-sm">
                        <p class="font-semibold text-lg mb-2">Análise de Preço Detalhada:</p>
                        <p>Aqui está a análise de preço para o pedido selecionado. Por favor, decida o status para cada produto antes de gravar.</p>
                    </div>
                    <div id="supplierApprovalCards">
                        <!-- Cards de aprovação por fornecedor serão injetados aqui (agora apenas 1 por vez) -->
                    </div>
                    <div id="globalDifferenceSummary" class="mt-6 p-4 rounded-lg bg-gray-100 border border-gray-300 text-center hidden">
                        <p class="text-xl font-bold text-gray-800">
                            Diferença Total Geral do Pedido: <span id="globalDifferenceValue"></span>
                        </p>
                        <p class="text-sm text-gray-600">Este é o impacto financeiro total em relação aos preços internos atuais.</p>
                    </div>
                    <div class="mt-6 flex justify-center gap-4">
                        <button onclick="saveApprovalDecisions()" class="btn btn-primary max-w-xs hidden" id="saveApprovalBtn" disabled>Gravar Análise</button>
                        <button onclick="displayRenatoFinalSummary()" class="btn btn-primary max-w-xs hidden" id="finalizeApprovalBtn" disabled>Finalizar Aprovação</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="hongKongFinalScreen" class="screen hidden container">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4" id="hongKongFinalTitle"></h1>
                <p class="text-gray-600" id="hongKongFinalMessage"></p>
            </div>
            <div class="message-box" id="finalDetailsHK">
                <!-- Detalhes finais com base na aprovação/rejeição -->
            </div>
            <button onclick="restartFlow()" class="btn btn-primary w-full mt-6">Iniciar Nova Solicitação</button>
        </div>

        <!-- Telas do Fluxo Colômbia -->
        <div id="colombiaFormScreen" class="screen hidden">
            <div class="app-content-wrapper"> <!-- Usando o novo wrapper para conteúdo principal -->
                <div class="header">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Solicitação de Compra - Colômbia</h1>
                    <p class="text-gray-600">Por favor, preencha os detalhes dos produtos desejados.</p>
                </div>

                <!-- Campo opcional: Número do Pedido do Cliente -->
                <div class="mb-4">
                    <label for="clientOrderNumberCOL" class="block text-sm font-medium text-gray-700">Número do Pedido (Opcional):</label>
                    <input type="text" id="clientOrderNumberCOL" placeholder="Seu número de referência do pedido"
                        class="rounded-lg p-2 border border-gray-300 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="tab-buttons" id="colTabButtons">
                    <!-- Pedido Fácil vem primeiro agora -->
                    <button class="tab-button active" onclick="switchTab('colombia', 'easy')">Pedido Fácil</button>
                    <button class="tab-button" onclick="switchTab('colombia', 'manual')">Pedido Manual</button>
                </div>

                <!-- Pedido Fácil Tab Content (agora vem antes) -->
                <div id="colombiaEasyOrderTab" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedido Fácil</h2>
                    <p class="text-gray-600 mb-6">Escolha uma das opções abaixo para adicionar os produtos ao carrinho de compras</p>

                    <!-- Upload de Planilha -->
                    <div class="border p-4 rounded-lg bg-gray-50 mb-6">
                        <div class="collapsible-header" onclick="toggleCollapsible(this, 'uploadSheetContentCOL')">
                            <h3 class="font-semibold text-gray-700">Upload de Planilha</h3>
                            <svg class="collapsible-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="uploadSheetContentCOL" class="collapsible-content hidden">
                            <p class="mb-4 text-gray-600">Selecione o arquivo no seu computador para fazer o upload.</p>
                            <div class="flex items-center gap-4 mb-4">
                                <input type="file" id="fileUploadCOL" accept=".csv" class="hidden" onchange="displayFileName('fileUploadCOL', 'fileNameDisplayCOL')">
                                <button onclick="document.getElementById('fileUploadCOL').click()" class="btn btn-secondary">Selecionar arquivo</button>
                                <span id="fileNameDisplayCOL" class="text-gray-600 italic">Nenhum arquivo selecionado</span>
                            </div>
                            <p class="text-sm text-gray-500 mb-4">O tamanho do arquivo não deve ultrapassar 5MB. Formato aceito: .csv</p>
                            <button onclick="handleFileUpload('colombia')" class="btn btn-primary w-full">Fazer Upload</button>
                        </div>
                    </div>

                    <!-- Copiar e Colar Códigos -->
                    <div class="border p-4 rounded-lg bg-gray-50 mb-6">
                        <div class="collapsible-header" onclick="toggleCollapsible(this, 'copyPasteContentCOL')">
                            <h3 class="font-semibold text-gray-700">Copiar e Colar Códigos</h3>
                            <svg class="collapsible-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="copyPasteContentCOL" class="collapsible-content hidden">
                            <p class="mb-4 text-gray-600">Cole os códigos de produto e quantidades (um por linha, ex: COD1,5):</p>
                            <textarea id="pasteCodesCOL" rows="5" class="w-full p-2 border rounded-lg mb-4"></textarea>
                            <button onclick="processPastedCodes('colombia')" class="btn btn-primary w-full">Adicionar Códigos</button>
                        </div>
                    </div>
                    
                    <!-- Saiba como utilizar nosso modelo de planilha -->
                    <div class="mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Saiba como utilizar nosso modelo de planilha</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/e0f2fe/0c4a6e?text=c%C3%B3digo+comercial" alt="Passo 1" class="mx-auto mb-4">
                                <p class="font-semibold text-lg mb-2">Passo 1</p>
                                <p class="text-gray-600">Faça o download do modelo de planilha. Abra a planilha no seu computador e preencha com o código comercial e a quantidade do produto desejado. Máximo de 50 linhas de produtos por pedido.</p>
                                <button onclick="downloadSpreadsheetModel()" class="text-blue-600 hover:underline mt-2 inline-block">Modelo de Planilha</button>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/e0f2fe/0c4a6e?text=%2B5MB" alt="Passo 2" class="mx-auto mb-4">
                                <p class="font-semibold text-lg mb-2">Passo 2</p>
                                <p class="text-gray-600">Com sua planilha pronta e salva no seu computador, clique em Selecionar arquivo. Em seguida, clique em Fazer upload. O tamanho da planilha não deve ultrapassar 5MB de tamanho.</p>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/e0f2fe/0c4a6e?text=%F0%9F%9B%92+50" alt="Passo 3" class="mx-auto mb-4">
                                <p class="font-semibold text-lg mb-2">Passo 3</p>
                                <p class="text-gray-600">Com sua planilha pronta e salva no seu computador, clique em Selecionar arquivo. Em seguida, clique em Fazer upload. O tamanho da planilha não deve ultrapassar 5MB de tamanho.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pedido Manual Tab Content (agora vem depois do Pedido Fácil) -->
                <div id="colombiaManualOrderTab" class="tab-content hidden">
                    <!-- Seção para adicionar um novo produto, imitando a linha única da imagem -->
                    <div class="mb-6 border p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-gray-700 mb-4">Adicionar Produtos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div class="col-span-1">
                                <label for="clientProductCodeCOL" class="block text-sm font-medium text-gray-700">Cód Prod Cliente:</label>
                                <div class="input-with-icon">
                                    <input type="text" id="clientProductCodeCOL" placeholder="Cód Cliente"
                                        oninput="updateProductDetailsOnClientCodeChangeCOL()"
                                        class="rounded-lg p-2 border border-gray-300 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <svg onclick="openProductCatalogModal('colombia')" class="search-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label for="productCodeCOLDisplay" class="block text-sm font-medium text-gray-700">Cód Produto:</label>
                                <div id="productCodeCOLDisplay" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    --
                                </div>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <label for="productDescriptionDisplayCOL" class="block text-sm font-medium text-gray-700">Descrição:</label>
                                <div id="productDescriptionDisplayCOL" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    --
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label for="productQuantityCOL" class="block text-sm font-medium text-gray-700">Qtd.:</label>
                                <input type="number" id="productQuantityCOL" min="1" value="1"
                                    class="rounded-lg p-2 border border-gray-300 w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="col-span-1">
                                <label for="valorUnitCOLDisplay" class="block text-sm font-medium text-gray-700">Valor Unit.:</label>
                                <div id="valorUnitCOLDisplay" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    R$ 0,00
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label for="productStockCOL" class="block text-sm font-medium text-gray-700">Estoque:</label>
                                <div id="productStockCOL" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center font-bold">
                                    --
                                </div>
                            </div>
                            <div class="col-span-full flex justify-end">
                                <button onclick="addProductCOL()" class="btn btn-secondary">Adicionar Produto</button>
                            </div>
                        </div>
                        <div id="addProductMessageCOL" class="add-product-message hidden"></div>
                    </div>
                </div>

                <!-- Produtos Adicionados na Solicitação (fora das abas, para ser comum) -->
                <div id="productListCOL" class="mt-4 border p-4 rounded-lg bg-gray-50 max-h-80 overflow-y-auto">
                    <h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados na Solicitação:</h3>
                    <div id="noProductsAddedCOL" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>
                    <!-- Produtos serão listados aqui em uma tabela -->
                </div>

                <div class="flex flex-col md:flex-row gap-4 mt-6">
                    <button onclick="backToFilialSelectionFromForm()" class="btn btn-secondary flex-1">Voltar</button>
                    <button onclick="submitColombiaForm()" class="btn btn-primary flex-1">Enviar Solicitação para SAP</button>
                </div>
            </div>
        </div>

        <div id="colombiaInvoiceScreen" class="screen hidden container">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Faturamento e Nota Fiscal - Colômbia</h1>
                <p class="text-gray-600">Seu pedido foi faturado e a Nota Fiscal está disponível.</p>
            </div>
            <div class="message-box">
                <p class="font-semibold">Nota Fiscal Eletrônica (NF-e) gerada com sucesso!</p>
                <p>Número da NF-e: <span id="nfeNumber">NF-20250624-001</span></p>
                <p>Valor Total: <span id="nfeValue">R$ 0,00</span></p>
                <p class="mt-4">
                    <a href="#" onclick="showNfePdf()" class="text-blue-600 hover:underline">Visualizar PDF da NF-e</a>
                </p>
            </div>
            <div id="nfePdfViewer" class="hidden mt-6 bg-gray-100 p-4 rounded-lg border border-gray-200">
                <p class="text-gray-700">Simulação de PDF da Nota Fiscal:</p>
                <pre class="bg-white p-4 rounded-md border border-gray-300 text-sm overflow-auto max-h-96 mt-2">
                    ----------------------------------------------------
                    |                NOTA FISCAL ELETRÔNICA            |
                    | Nº: NF-20250624-001                                |
                    | Data de Emissão: 24/06/2025                        |
                    |                                                    |
                    | REMETENTE: EMPRESA XYZ DO BRASIL                   |
                    | CNPJ: 00.000.000/0001-00                           |
                    | ENDEREÇO: RUA EXEMPLO, 123 - SÃO PAULO/SP          |
                    |                                                    |
                    | DESTINATÁRIO: CLIENTE INTERNACIONAL COLÔMBIA       |
                    | ENDEREÇO: CALLE 45, 7-30 - BOGOTÁ/COLÔMBIA         |
                    |                                                    |
                    | PRODUTOS:                                          |
                    | -------------------------------------------------- |
                    | ID | DESCRIÇÃO           | QTD | VALOR UNIT | TOTAL |
                    |----|---------------------|-----|------------|-------|
                    | 001| Produto Colômbia A  | 10  | R$ 100,00  | R$ 1000,00 |
                    | 002| Produto Colômbia B  | 5   | R$ 100,00  | R$ 500,00  |
                    |--------------------------------------------------|
                    | VALOR TOTAL:                                R$ 0,00 |
                    ----------------------------------------------------
                    (Este é um exemplo simulado de NF-e.)
                </pre>
            </div>
            <button onclick="restartFlow()" class="btn btn-primary w-full mt-6">Iniciar Nova Solicitação</button>
        </div>

        <!-- Caixa de Mensagem Genérica (para alertas, confirmações) -->
        <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                <h3 id="messageModalTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <p id="messageModalContent" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end gap-3">
                    <button id="messageModalConfirmBtn" class="btn btn-primary hidden">Confirmar</button>
                    <button id="messageModalCancelBtn" class="btn btn-secondary hidden">Cancelar</button>
                    <button id="messageModalCloseBtn" class="btn btn-primary">Ok</button>
                </div>
            </div>
        </div>

        <!-- Modal de Catálogo de Produtos -->
        <div id="productCatalogModal" class="modal-overlay hidden">
            <div class="modal-content container">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Catálogo de Produtos</h3>
                <input type="text" id="productCatalogSearchInput" placeholder="Pesquisar por Código ou Descrição..." oninput="filterProductCatalog()">
                <div id="productCatalogList">
                    <!-- Lista de produtos será renderizada aqui -->
                </div>
                <button onclick="closeProductCatalogModal()" class="btn btn-secondary w-full mt-6">Fechar</button>
            </div>
        </div>

        <!-- Nova Tela de Carregamento da Análise -->
        <div id="analysisLoadingScreen" class="hidden">
            <div class="spinner"></div>
            <p class="message">Realizando Análise de Preços...</p>
            <p class="sub-message">Validando dados, comparando valores e otimizando custos.</p>
        </div>

    </div>

    <script>
        // --- Gerenciamento de Estado ---
        let currentScreen = 'loginScreen';
        let selectedFilial = '';
        let hongKongProducts = []; // Atua como o "carrinho" para Hong Kong
        let colombiaProducts = [];
        let generatedPurchaseOrders = [ // Armazena detalhes de MÚLTIPLAS POs simuladas
            {
                parentOrderId: 'SOL-001', id: 'PED-001', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-20',
                products: [
                    { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 10, unitPrice: 150.00, currentInternalUnitPrice: 160.00, newSupplierUnitPrice: 155.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (10 * 155).toFixed(2), currentInternalPriceTotal: (10 * 160).toFixed(2), overallApprovalStatus: 'Pendente'
            },
            { // Alterado para SOL-009 para consistência de origem
                parentOrderId: 'SOL-009', id: 'PED-002', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-21',
                products: [
                    { code: 'PROD007', name: 'Cadeira Ergonômica', quantity: 2, unitPrice: 600.00, currentInternalUnitPrice: 630.00, newSupplierUnitPrice: 600.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (2 * 600).toFixed(2), currentInternalPriceTotal: (2 * 630).toFixed(2), overallApprovalStatus: 'Pendente'
            },
            {
                parentOrderId: 'SOL-003', id: 'PED-005', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-24',
                products: [
                    { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 2, unitPrice: 150.00, currentInternalUnitPrice: 158.00, newSupplierUnitPrice: 152.00, approvalStatus: 'Pendente' },
                    { code: 'PROD003', name: 'Fone Bluetooth Max', quantity: 3, unitPrice: 45.00, currentInternalUnitPrice: 48.00, newSupplierUnitPrice: 46.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (2 * 152 + 3 * 46).toFixed(2), currentInternalPriceTotal: (2 * 158 + 3 * 48).toFixed(2), overallApprovalStatus: 'Pendente'
            },
            {
                parentOrderId: 'SOL-005', id: 'PED-010', supplier: 'Fornecedor C', supplierCode: '44', date: '2025-06-26',
                products: [
                    { code: 'PROD005', name: 'Câmera Digital Ultra HD', quantity: 3, unitPrice: 320.00, currentInternalUnitPrice: 335.00, newSupplierUnitPrice: 320.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (3 * 320).toFixed(2), currentInternalPriceTotal: (3 * 335).toFixed(2), overallApprovalStatus: 'Pendente'
            },
            // Adicionado manualmente para simular múltiplos pedidos para SOL-008
            {
                parentOrderId: 'SOL-008', id: 'PED-015', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-29',
                products: [
                    { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 5, unitPrice: 150.00, currentInternalUnitPrice: 158.00, newSupplierUnitPrice: 152.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (5 * 152).toFixed(2), currentInternalPriceTotal: (5 * 158).toFixed(2), overallApprovalStatus: 'Pendente'
            },
            {
                parentOrderId: 'SOL-008', id: 'PED-016', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-29',
                products: [
                    { code: 'PROD002', name: 'Tablet Pro Z', quantity: 2, unitPrice: 250.00, currentInternalUnitPrice: 260.00, newSupplierUnitPrice: 255.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (2 * 255).toFixed(2), currentInternalPriceTotal: (2 * 260).toFixed(2), overallApprovalStatus: 'Pendente'
            }
        ];
        let simulatedSupplierOrders = {}; // Para armazenar a divisão dos produtos por fornecedor
        let currentOrderDetails = null; // Para armazenar detalhes do pedido selecionado
        let currentUserClientName = "Cliente Prototipo"; // Definido globalmente para o usuário "prototipo"

        // Variáveis para controlar os sequenciais de IDs
        let nextParentRequestCounter = 1; // Para SOL-001, SOL-002...
        let nextPurchaseOrderIdCounter = 0; // Para PED-001, PED-002... será inicializado com orders.length + 1
        let currentParentOrderId = null; // Armazena o ID da solicitação "pai" atual (SOL-XXX)

        // Variável para armazenar os POs atualmente exibidos na visualização de aprovação detalhada
        let currentViewingPO = null; // Agora armazena o OBJETO PO completo que está sendo visualizado

        // --- Constantes para Capacidades de Contêiner (em m³) ---
        const MAX_CUBAGE_20HC = 37.4;
        const MAX_CUBAGE_40HC = 76.0;

        // --- Banco de Dados de Produtos Simulados (Código, Descrição, MOQ, Preço Unitário Simulado, Linha do Produto) ---
        const productDatabase = {
            // Produtos universais com códigos sequenciais
            "PROD001": { code: "PROD001", clientCode: "SKU-001", description: "Smartphone Premium X1", moq: 3, unitPrice: 150.00, tableValue: 160.00, cubageUnit: 0.005, simulatedStock: 100, productLine: 'Eletrônicos', supplier: 'Fornecedor A' },
            "PROD002": { code: "PROD002", clientCode: "SKU-002", description: "Tablet Pro Z", moq: 2, unitPrice: 250.00, tableValue: 265.00, cubageUnit: 0.008, simulatedStock: 50, productLine: 'Eletrônicos', supplier: 'Fornecedor B' },
            "PROD003": { code: "PROD003", clientCode: "SKU-003", description: "Fone Bluetooth Max", moq: 5, unitPrice: 45.00, tableValue: 50.00, cubageUnit: 0.001, simulatedStock: 200, productLine: 'Acessórios', supplier: 'Fornecedor C' },
            "PROD004": { code: "PROD004", clientCode: "SKU-004", description: "Smartwatch Sport Y", moq: 1, unitPrice: 80.00, tableValue: 85.00, cubageUnit: 0.002, simulatedStock: 120, productLine: 'Vestíveis', supplier: 'Fornecedor A' },
            "PROD005": { code: "PROD005", clientCode: "SKU-005", description: "Câmera Digital Ultra HD", moq: 2, unitPrice: 300.00, tableValue: 320.00, cubageUnit: 0.01, simulatedStock: 30, productLine: 'Fotografia', supplier: 'Fornecedor B' },
            "PROD006": { code: "PROD006", clientCode: "SKU-006", description: "Bateria Portátil Mega", moq: 10, unitPrice: 25.00, tableValue: 28.00, cubageUnit: 0.0005, simulatedStock: 300, productLine: 'Acessórios', supplier: 'Fornecedor C' },
            "PROD007": { code: "PROD007", clientCode: "SKU-007", description: 'Cadeira Ergonômica', unitPrice: 600.00, simulatedStock: 15, productLine: 'Móveis de Escritório', cubageUnit: 0.15, supplier: 'Fornecedor A' },
            "PROD008": { code: "PROD008", clientCode: "SKU-008", description: 'Impressora 3D Industrial', unitPrice: 800.00, simulatedStock: 0, productLine: 'Maquinário', cubageUnit: 0.8, supplier: 'Fornecedor B' },
            "PROD009": { code: "PROD009", clientCode: "SKU-009", description: 'Monitor Ultrawide', unitPrice: 350.00, tableValue: 350.00, simulatedStock: 50, productLine: 'Periféricos', supplier: 'Fornecedor C' },
            "PROD010": { code: "PROD010", clientCode: "SKU-010", description: 'Teclado Mecânico', unitPrice: 80.00, tableValue: 80.00, cubageUnit: 0.01, supplier: 'Fornecedor A' },
            "PROD011": { code: "PROD011", clientCode: "SKU-011", description: 'Mouse Gamer', unitPrice: 40.00, tableValue: 40.00, cubageUnit: 0.001, supplier: 'Fornecedor B' }
        };

        // Cria um mapeamento reverso universal para ClientProductCode (SKU) para ProductCode (PROD)
        const universalClientCodeToProductCodeMap = {};
        for (const prodCode in productDatabase) {
            const product = productDatabase[prodCode];
            if (product.clientCode) {
                universalClientCodeToProductCodeMap[product.clientCode.toUpperCase()] = prodCode;
            }
        }

        // Global map for suppliers to their numerical codes and reverse map
        const supplierCodeMap = {};
        const supplierNameMap = {}; // Reverse map to get name from code
        let nextSupplierCode = 22; // Start with 22, increment by 11

        function getOrGenerateSupplierCode(supplierName) {
            if (!supplierCodeMap[supplierName]) {
                supplierCodeMap[supplierName] = String(nextSupplierCode);
                supplierNameMap[String(nextSupplierCode)] = supplierName; // Store reverse mapping
                nextSupplierCode += 11;
            }
            return supplierCodeMap[supplierName];
        }

        function getSupplierNameFromCode(supplierCode) {
            return supplierNameMap[supplierCode] || supplierCode; // Return code if name not found
        }
        
        // --- Dados de Pedidos Simulados ---
        const orders = [
            {
                orderId: 'PED-001',
                parentOrderId: 'SOL-001',
                clientFlag: 'TOTVS BRASIL',
                originCountry: 'Hong Kong',
                totalValue: 5000.00,
                status: 'Aguardando Aprovação', // Alterado: Status inicial do tracking HK
                requestDate: '2025-06-20',
                lastUpdateDate: '2025-06-22',
                supplier: 'Fornecedor A',
                products: [
                    { code: 'PROD001', description: 'Smartphone Premium X1', quantity: 10, unitPrice: 150.00, cubageUnit: 0.005 }
                ]
            },
            {
                orderId: 'PED-002',
                parentOrderId: 'SOL-009',
                clientFlag: 'ACME Corp',
                originCountry: 'Colômbia',
                totalValue: 1200.00,
                status: 'Em Separação', // Alterado: Status inicial do tracking Colômbia
                requestDate: '2025-06-21',
                lastUpdateDate: '2025-06-21',
                supplier: 'Fornecedor B',
                products: [
                    { code: 'PROD007', description: 'Cadeira Ergonômica', quantity: 2, unitPrice: 600.00, cubageUnit: 0.15 }
                ]
            },
            {
                orderId: 'PED-003',
                parentOrderId: 'SOL-002',
                clientFlag: 'Global Tech',
                originCountry: 'Hong Kong',
                totalValue: 300.00,
                status: 'Rejeitado',
                requestDate: '2025-06-18',
                lastUpdateDate: '2025-06-19',
                supplier: 'Fornecedor A',
                products: [
                    { code: 'PROD003', description: 'Fone Bluetooth Max', quantity: 5, unitPrice: 45.00, cubageUnit: 0.001 },
                    { code: 'PROD006', description: 'Bateria Portátil Mega', quantity: 5, unitPrice: 25.00, cubageUnit: 0.0005 }
                ]
            },
            {
                orderId: 'PED-004',
                parentOrderId: 'SOL-010',
                clientFlag: 'Importadora Sul',
                originCountry: 'Colômbia',
                totalValue: 800.00,
                status: 'Entregue',
                requestDate: '2025-06-23',
                lastUpdateDate: '2025-06-23',
                supplier: 'Fornecedor C',
                products: [
                    { code: 'PROD008', description: 'Impressora 3D Industrial', quantity: 1, unitPrice: 800.00, cubageUnit: 0.8 }
                ]
            },
            // Adicionando 10 novos pedidos
            {
                orderId: 'PED-005',
                parentOrderId: 'SOL-003',
                clientFlag: 'Tech Solutions',
                originCountry: 'Hong Kong',
                totalValue: 750.00,
                status: 'Em Negociação', // Alterado: Status detalhado do tracking HK
                requestDate: '2025-06-24',
                lastUpdateDate: '2025-06-24',
                supplier: 'Fornecedor B',
                products: [
                    { code: 'PROD001', description: 'Smartphone Premium X1', quantity: 2, unitPrice: 150.00, cubageUnit: 0.005 },
                    { code: 'PROD003', description: 'Fone Bluetooth Max', quantity: 3, unitPrice: 45.00, cubageUnit: 0.001 }
                ]
            },
            {
                orderId: 'PED-006',
                parentOrderId: 'SOL-003',
                clientFlag: 'Eletro Mundi',
                originCountry: 'Hong Kong',
                totalValue: 120.00,
                status: 'Carga Entregue', // Alterado: Status detalhado do tracking HK
                requestDate: '2025-06-24',
                lastUpdateDate: '2025-06-25',
                supplier: 'Fornecedor A',
                products: [
                    { code: 'PROD004', description: 'Smartwatch Sport Y', quantity: 1, unitPrice: 80.00, cubageUnit: 0.002 },
                    { code: 'PROD006', description: 'Bateria Portátil Mega', quantity: 2, unitPrice: 20.00, cubageUnit: 0.0005 }
                ]
            },
            {
                orderId: 'PED-007',
                parentOrderId: 'SOL-004',
                clientFlag: 'Casa e Conforto',
                originCountry: 'Colômbia',
                totalValue: 1800.00,
                status: 'Em Conferência', // Alterado: Status detalhado do tracking Colômbia
                requestDate: '2025-06-25',
                lastUpdateDate: '2025-06-25',
                supplier: 'Fornecedor C',
                products: [
                    { code: 'PROD007', description: 'Cadeira Ergonômica', quantity: 3, unitPrice: 600.00, cubageUnit: 0.15 }
                ]
            },
            {
                orderId: 'PED-008',
                parentOrderId: 'SOL-011',
                clientFlag: 'Home Office Ltda',
                originCountry: 'Hong Kong',
                totalValue: 700.00,
                status: 'Carga Pronta', // Alterado: Status detalhado do tracking HK
                requestDate: '2025-06-25',
                lastUpdateDate: '2025-06-25',
                supplier: 'Fornecedor B',
                products: [
                    { code: 'PROD009', description: 'Monitor Ultrawide', quantity: 2, unitPrice: 350.00, cubageUnit: 0.05 }
                ]
            },
            {
                orderId: 'PED-009',
                parentOrderId: 'SOL-005',
                clientFlag: 'Game Lovers',
                originCountry: 'Hong Kong',
                totalValue: 120.00,
                status: 'Aprovado', // Universal
                requestDate: '2025-06-26',
                lastUpdateDate: '2025-06-26',
                supplier: 'Fornecedor A',
                products: [
                    { code: 'PROD010', description: 'Teclado Mecânico', quantity: 1, unitPrice: 80.00, cubageUnit: 0.01 },
                    { code: 'PROD011', description: 'Mouse Gamer', quantity: 1, unitPrice: 40.00, cubageUnit: 0.001 }
                ]
            },
            {
                orderId: 'PED-010',
                parentOrderId: 'SOL-005',
                clientFlag: 'Fotografia Profissional',
                originCountry: 'Hong Kong',
                totalValue: 960.00,
                status: 'Pendente', // Universal
                requestDate: '2025-06-26',
                lastUpdateDate: '2025-06-26',
                supplier: 'Fornecedor C',
                products: [
                    { code: 'PROD005', description: 'Câmera Digital Ultra HD', quantity: 3, unitPrice: 320.00, cubageUnit: 0.01 }
                ]
            },
            {
                orderId: 'PED-011',
                parentOrderId: 'SOL-006',
                clientFlag: 'Acessórios Digitais',
                originCountry: 'Hong Kong',
                totalValue: 100.00,
                status: 'Cancelado', // Universal
                requestDate: '2025-06-27',
                lastUpdateDate: '2025-06-27',
                supplier: 'Fornecedor A',
                products: [
                    { code: 'PROD003', description: 'Fone Bluetooth Max', quantity: 2, unitPrice: 50.00, cubageUnit: 0.001 }
                ]
            },
            {
                orderId: 'PED-012',
                parentOrderId: 'SOL-012',
                clientFlag: 'Tecnologia Avançada',
                originCountry: 'Colômbia',
                totalValue: 800.00,
                status: 'Em Rota de Entrega', // Alterado: Status detalhado do tracking Colômbia
                requestDate: '2025-06-27',
                lastUpdateDate: '2025-06-27',
                supplier: 'Fornecedor B',
                products: [
                    { code: 'PROD008', description: 'Impressora 3D Industrial', quantity: 1, unitPrice: 800.00, cubageUnit: 0.8 }
                ]
            },
            {
                orderId: 'PED-013',
                parentOrderId: 'SOL-007',
                clientFlag: 'Móveis Modernos',
                originCountry: 'Colômbia',
                totalValue: 1200.00,
                status: 'Pendente', // Universal
                requestDate: '2025-06-28',
                lastUpdateDate: '2025-06-28',
                supplier: 'Fornecedor C',
                products: [
                    { code: 'PROD007', description: 'Cadeira Ergonômica', quantity: 2, unitPrice: 600.00, cubageUnit: 0.15 }
                ]
            },
            {
                orderId: 'PED-014',
                parentOrderId: 'SOL-013',
                clientFlag: 'Importadora Nova',
                originCountry: 'Hong Kong',
                totalValue: 160.00,
                status: 'Carga Em rota de Entrega', // Alterado: Status detalhado do tracking HK
                requestDate: '2025-06-28',
                lastUpdateDate: '2025-06-28',
                supplier: 'Fornecedor A',
                products: [
                    { code: 'PROD001', description: 'Smartphone Premium X1', quantity: 1, unitPrice: 160.00, cubageUnit: 0.005 }
                ]
            },
             // Adicionado manualmente para simular múltiplos pedidos para SOL-008
            {
                orderId: 'PED-015',
                parentOrderId: 'SOL-008',
                clientFlag: 'Cliente Prototipo',
                originCountry: 'Hong Kong',
                totalValue: 760.00,
                status: 'Em Processamento', // Universal, para "Em Processamento" genérico antes do Renato (Hong Kong)
                requestDate: '2025-06-29',
                lastUpdateDate: '2025-06-29',
                supplier: 'Fornecedor A',
                products: [
                    { code: 'PROD001', description: 'Smartphone Premium X1', quantity: 5, unitPrice: 150.00, currentInternalUnitPrice: 158.00, newSupplierUnitPrice: 152.00, approvalStatus: 'Pendente' }
                ]
            },
            {
                orderId: 'PED-016',
                parentOrderId: 'SOL-008',
                clientFlag: 'Cliente Prototipo',
                originCountry: 'Hong Kong',
                totalValue: 500.00,
                status: 'Em Processamento', // Universal, para "Em Processamento" genérico antes do Renato (Hong Kong)
                requestDate: '2025-06-29',
                lastUpdateDate: '2025-06-29',
                supplier: 'Fornecedor B',
                products: [
                    { code: 'PROD002', name: 'Tablet Pro Z', quantity: 2, unitPrice: 250.00, currentInternalUnitPrice: 260.00, newSupplierUnitPrice: 255.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (2 * 255).toFixed(2), currentInternalPriceTotal: (2 * 260).toFixed(2), overallApprovalStatus: 'Pendente'
            }
        ];


        // --- Funções Utilitárias ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            currentScreen = screenId;
        }

        function showMessage(title, content, type = 'info', onConfirm = null, onCancel = null) {
            const modal = document.getElementById('messageModal');
            document.getElementById('messageModalTitle').innerText = title;
            document.getElementById('messageModalContent').innerText = content;

            const confirmBtn = document.getElementById('messageModalConfirmBtn');
            const cancelBtn = document.getElementById('messageModalCancelBtn');
            const closeBtn = document.getElementById('messageModalCloseBtn');

            confirmBtn.onclick = () => { if (onConfirm) onConfirm(); modal.classList.add('hidden'); };
            cancelBtn.onclick = () => { if (onCancel) onCancel(); modal.classList.add('hidden'); };
            closeBtn.onclick = () => modal.classList.add('hidden');

            confirmBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            closeBtn.classList.remove('hidden'); // Botão "Ok" padrão

            if (onConfirm || onCancel) {
                closeBtn.classList.add('hidden'); // Ocultar "Ok" padrão se "Confirmar/Cancelar" estiverem presentes
                confirmBtn.classList.remove('hidden');
                if (onCancel) {
                    cancelBtn.classList.remove('hidden');
                }
            }
            modal.classList.remove('hidden');
        }

        function displayAddProductMessage(message, type, filial) {
            let messageDiv;
            if (filial === 'hongkong') {
                messageDiv = document.getElementById('addProductMessageHK');
            } else { // 'colombia'
                messageDiv = document.getElementById('addProductMessageCOL');
            }
            
            messageDiv.innerText = message;
            messageDiv.className = `add-product-message ${type}`;
            messageDiv.classList.remove('hidden');
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000); // Esconder após 3 segundos
        }

        // --- Controle de Fluxo ---
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Validação de login: apenas "prototipo/prototipo" é válido
            if (username === 'prototipo' && password === 'prototipo') {
                showScreen('orderCenterScreen');
                // Garante que nextParentRequestCounter e nextPurchaseOrderIdCounter sejam inicializados com base nos dados existentes
                // Encontra o ID SOL-XXX máximo
                const maxSolId = orders.reduce((max, order) => {
                    const solNum = parseInt(order.parentOrderId.replace('SOL-', ''));
                    return isNaN(solNum) ? max : Math.max(max, solNum);
                }, 0);
                nextParentRequestCounter = maxSolId + 1;

                // Encontra o ID PED-XXX máximo
                const maxPedId = orders.reduce((max, order) => {
                    const pedNum = parseInt(order.orderId.replace('PED-', ''));
                    return isNaN(pedNum) ? max : Math.max(max, pedNum);
                }, 0);
                nextPurchaseOrderIdCounter = maxPedId + 1;
                
                populateSupplierFilter(); // Popula o filtro de fornecedores após o login
                populateOriginCountryFilter(); // Popula o filtro de países de origem após o login
                renderOrdersTable(); // Renderiza a tabela de pedidos após o login
            } else {
                // Mensagem genérica para login incorreto
                showMessage('Erro de Login', 'Usuário ou senha inválidos.', 'error');
            }
        }

        function openFilialSelectionModal() {
            document.getElementById('filialSelectionModal').classList.remove('hidden');
        }

        function closeFilialSelectionModal() {
            document.getElementById('filialSelectionModal').classList.add('hidden');
        }

        function selectFilial(filial) {
            selectedFilial = filial;
            closeFilialSelectionModal(); // Fechar o modal primeiro
            if (filial === 'colombia') {
                showScreen('colombiaFormScreen');
                colombiaProducts = []; // Limpar produtos para nova solicitação
                renderColombiaProductList(); // Renderizar lista de produtos adicionados (vazia inicialmente)
                // Limpar inputs para formulário Colômbia
                document.getElementById('clientProductCodeCOL').value = '';
                document.getElementById('productCodeCOLDisplay').innerText = '--';
                document.getElementById('productDescriptionDisplayCOL').innerText = '--';
                document.getElementById('productStockCOL').innerText = '--';
                document.getElementById('productQuantityCOL').value = '1';
                document.getElementById('valorUnitCOLDisplay').innerText = 'R$ 0,00';
                document.getElementById('clientOrderNumberCOL').value = ''; // Limpar número do pedido do cliente
                switchTab('colombia', 'easy'); // Define a aba inicial como "Fácil"
            } else if (filial === 'hongkong') {
                showScreen('hongKongFormScreen');
                hongKongProducts = []; // Limpar produtos para nova solicitação
                renderHongKongProductList(); // Renderizar lista de produtos adicionados (vazia inicialmente)
                // Limpar inputs para formulário Hong Kong
                document.getElementById('clientProductCodeHK').value = '';
                document.getElementById('mappedProductCodeDisplayHK').innerText = '--';
                document.getElementById('productDescriptionDisplayHK').innerText = '--';
                document.getElementById('productQuantityHK').value = '1';
                document.getElementById('productValueHK').innerText = 'R$ 0,00';
                document.getElementById('totalM3DisplayHK').innerText = '0.00 m³';
                document.getElementById('moqLiveFeedbackHK').innerText = '';
                document.getElementById('clientOrderNumberHK').value = ''; // Limpar número do pedido do cliente
                switchTab('hongkong', 'easy'); // Define a aba inicial como "Fácil"
            }
        }

        // Função para alternar entre as abas "Pedido Manual" e "Pedido Fácil"
        function switchTab(filial, tabType) {
            let manualTabContent, easyTabContent, tabButtonsContainer;

            if (filial === 'hongkong') {
                manualTabContent = document.getElementById('hongKongManualOrderTab');
                easyTabContent = document.getElementById('hongKongEasyOrderTab');
                tabButtonsContainer = document.getElementById('hkTabButtons');
            } else { // colombia
                manualTabContent = document.getElementById('colombiaManualOrderTab');
                easyTabContent = document.getElementById('colombiaEasyOrderTab');
                tabButtonsContainer = document.getElementById('colTabButtons');
            }

            // Esconde todo o conteúdo da aba primeiro
            manualTabContent.classList.add('hidden');
            easyTabContent.classList.add('hidden');

            // Remove a classe 'active' de todos os botões de aba
            Array.from(tabButtonsContainer.children).forEach(button => {
                button.classList.remove('active');
            });

            // Mostra o conteúdo da aba selecionada e adiciona a classe 'active' ao botão
            if (tabType === 'easy') { // Ordem invertida: 'easy' é o primeiro (índice 0)
                easyTabContent.classList.remove('hidden');
                tabButtonsContainer.children[0].classList.add('active');
            } else if (tabType === 'manual') { // 'manual' é o segundo (índice 1)
                manualTabContent.classList.remove('hidden');
                tabButtonsContainer.children[1].classList.add('active');
            }
        }

        // Função para voltar para a Central de Pedidos a partir da seleção de filial ou formulários
        function backToOrderCenter() {
            showScreen('orderCenterScreen');
            renderOrdersTable(); // Re-renderizar a tabela para garantir o estado atualizado
        }

        function backToFilialSelectionFromForm() {
            // Este botão está nos formulários de solicitação, então ele deve abrir o modal novamente
            openFilialSelectionModal();
            // Opcionalmente, limpar os produtos do formulário aqui se o usuário "voltar" para escolher outra filial
            if (currentScreen === 'hongKongFormScreen') {
                hongKongProducts = [];
                renderHongKongProductList();
            } else if (currentScreen === 'colombiaFormScreen') {
                colombiaProducts = [];
                renderColombiaProductList();
            }
            showScreen('orderCenterScreen'); // Esconder a tela do formulário
        }

        function backToProductEntry() { // Usado a partir do Resumo de Hong Kong
            showScreen('hongKongFormScreen');
            renderHongKongProductList(); // Re-renderizar a lista do carrinho
        }


        // Função de Logout
        function logout() {
            // Redefinir todo o estado relevante para um logout completo
            selectedFilial = '';
            hongKongProducts = [];
            colombiaProducts = [];
            // Limpar generatedPurchaseOrders completamente
            generatedPurchaseOrders = [
                {
                    parentOrderId: 'SOL-001', id: 'PED-001', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-20',
                    products: [{ code: 'PROD001', name: 'Smartphone Premium X1', quantity: 10, unitPrice: 150.00, currentInternalUnitPrice: 160.00, newSupplierUnitPrice: 155.00, approvalStatus: 'Pendente' }],
                    newSupplierPriceTotal: (10 * 155).toFixed(2), currentInternalPriceTotal: (10 * 160).toFixed(2), overallApprovalStatus: 'Pendente'
                },
                { // Alterado para SOL-009 para consistência de origem
                    parentOrderId: 'SOL-009', id: 'PED-002', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-21',
                    products: [{ code: 'PROD007', name: 'Cadeira Ergonômica', quantity: 2, unitPrice: 600.00, currentInternalUnitPrice: 630.00, newSupplierUnitPrice: 600.00, approvalStatus: 'Pendente' }],
                    newSupplierPriceTotal: (2 * 600).toFixed(2), currentInternalPriceTotal: (2 * 630).toFixed(2), overallApprovalStatus: 'Pendente'
                },
                {
                    parentOrderId: 'SOL-003', id: 'PED-005', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-24',
                    products: [
                        { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 2, unitPrice: 150.00, currentInternalUnitPrice: 158.00, newSupplierUnitPrice: 152.00, approvalStatus: 'Pendente' },
                        { code: 'PROD003', name: 'Fone Bluetooth Max', quantity: 3, unitPrice: 45.00, currentInternalUnitPrice: 48.00, newSupplierUnitPrice: 46.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (2 * 152 + 3 * 46).toFixed(2), currentInternalPriceTotal: (2 * 158 + 3 * 48).toFixed(2), overallApprovalStatus: 'Pendente'
                },
                {
                    parentOrderId: 'SOL-005', id: 'PED-010', supplier: 'Fornecedor C', supplierCode: '44', date: '2025-06-26',
                    products: [{ code: 'PROD005', name: 'Câmera Digital Ultra HD', quantity: 3, unitPrice: 320.00, currentInternalUnitPrice: 335.00, newSupplierUnitPrice: 320.00, approvalStatus: 'Pendente' }],
                    newSupplierPriceTotal: (3 * 320).toFixed(2), currentInternalPriceTotal: (3 * 335).toFixed(2), overallApprovalStatus: 'Pendente'
                },
                // Adicionado manualmente para simular múltiplos pedidos para SOL-008
                {
                    parentOrderId: 'SOL-008', id: 'PED-015', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-29',
                    products: [
                        { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 5, unitPrice: 150.00, currentInternalUnitPrice: 158.00, newSupplierUnitPrice: 152.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (5 * 152).toFixed(2), currentInternalPriceTotal: (5 * 158).toFixed(2), overallApprovalStatus: 'Pendente'
                },
                {
                    parentOrderId: 'SOL-008', id: 'PED-016', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-29',
                    products: [
                        { code: 'PROD002', name: 'Tablet Pro Z', quantity: 2, unitPrice: 250.00, currentInternalUnitPrice: 260.00, newSupplierUnitPrice: 255.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (2 * 255).toFixed(2), currentInternalPriceTotal: (2 * 260).toFixed(2), overallApprovalStatus: 'Pendente'
                },
            ];

            simulatedSupplierOrders = {}; // Limpar os pedidos por fornecedor
            currentOrderDetails = null;
            currentViewingPO = null; // Reiniciar o PO em visualização
            
            // Re-initialize counters based on the original data + new generated orders
            const maxSolId = orders.reduce((max, order) => {
                const solNum = parseInt(order.parentOrderId.replace('SOL-', ''));
                return isNaN(solNum) ? max : Math.max(max, solNum);
            }, 0);
            nextParentRequestCounter = maxSolId + 1;

            const maxPedId = orders.reduce((max, order) => {
                const pedNum = parseInt(order.orderId.replace('PED-', ''));
                return isNaN(pedNum) ? max : Math.max(max, pedNum);
            }, 0);
            nextPurchaseOrderIdCounter = maxPedId + 1;

            currentParentOrderId = null; // Novo: Redefinir o ID do pedido pai

            // Limpar campos de entrada para todos os formulários
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            // HK
            if (document.getElementById('clientProductCodeHK')) document.getElementById('clientProductCodeHK').value = '';
            if (document.getElementById('mappedProductCodeDisplayHK')) document.getElementById('mappedProductCodeDisplayHK').innerText = '--';
            if (document.getElementById('productDescriptionDisplayHK')) document.getElementById('productDescriptionDisplayHK').innerText = '--';
            if (document.getElementById('productQuantityHK')) document.getElementById('productQuantityHK').value = '1';
            if (document.getElementById('productValueHK')) document.getElementById('productValueHK').innerText = 'R$ 0,00';
            if (document.getElementById('totalM3DisplayHK')) document.getElementById('totalM3DisplayHK').innerText = '0.00 m³';
            if (document.getElementById('moqLiveFeedbackHK')) document.getElementById('moqLiveFeedbackHK').innerText = '';
            if (document.getElementById('addProductMessageHK')) document.getElementById('addProductMessageHK').classList.add('hidden');
            if (document.getElementById('clientOrderNumberHK')) document.getElementById('clientOrderNumberHK').value = '';
            if (document.getElementById('pasteCodesHK')) document.getElementById('pasteCodesHK').value = ''; // Limpa textarea do Pedido Fácil
            if (document.getElementById('fileUploadHK')) document.getElementById('fileUploadHK').value = ''; // Limpa input file
            if (document.getElementById('fileNameDisplayHK')) document.getElementById('fileNameDisplayHK').innerText = 'Nenhum arquivo selecionado'; // Limpa exibição do nome do arquivo


            // COL
            if (document.getElementById('clientProductCodeCOL')) document.getElementById('clientProductCodeCOL').value = '';
            if (document.getElementById('productCodeCOLDisplay')) document.getElementById('productCodeCOLDisplay').innerText = '--';
            if (document.getElementById('productDescriptionDisplayCOL')) document.getElementById('productDescriptionDisplayCOL').innerText = '--';
            if (document.getElementById('productStockCOL')) document.getElementById('productStockCOL').innerText = '--';
            if (document.getElementById('productQuantityCOL')) document.getElementById('productQuantityCOL').value = '1';
            if (document.getElementById('valorUnitCOLDisplay')) document.getElementById('valorUnitCOLDisplay').innerText = 'R$ 0,00';
            if (document.getElementById('addProductMessageCOL')) document.getElementById('addProductMessageCOL').classList.add('hidden');
            if (document.getElementById('clientOrderNumberCOL')) document.getElementById('clientOrderNumberCOL').value = '';
            if (document.getElementById('pasteCodesCOL')) document.getElementById('pasteCodesCOL').value = ''; // Limpa textarea do Pedido Fácil
            if (document.getElementById('fileUploadCOL')) document.getElementById('fileUploadCOL').value = ''; // Limpa input file
            if (document.getElementById('fileNameDisplayCOL')) document.getElementById('fileNameDisplayCOL').innerText = 'Nenhum arquivo selecionado'; // Limpa exibição do nome do arquivo


            closeFilialSelectionModal(); // Garantir que o modal esteja oculto no logout
            closeProductCatalogModal(); // Garantir que o modal do catálogo esteja oculto no logout
            showScreen('loginScreen');
        }

        function restartFlow() {
            // Redefinir todo o estado relevante para um reinício completo
            logout(); // Reutilizar a função de logout, pois ela executa a mesma redefinição de estado
        }

        // --- Lógica da Central de Pedidos ---
        function populateSupplierFilter() {
            const supplierFilterSelect = document.getElementById('supplierFilter');
            supplierFilterSelect.innerHTML = '<option value="">Todos</option>'; // Limpa as opções existentes

            const uniqueSuppliers = new Set();
            orders.forEach(order => {
                if (order.supplier) {
                    uniqueSuppliers.add(order.supplier);
                }
            });

            // Adiciona fornecedores por seus códigos e exibe apenas o código
            // Classifica os fornecedores por seu código numérico para exibição consistente
            const sortedSupplierCodes = Array.from(Object.keys(supplierNameMap)).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedSupplierCodes.forEach(supplierCode => {
                const option = document.createElement('option');
                option.value = supplierCode; // O valor é o código
                option.innerText = `${supplierCode}`; // Exibe APENAS o código
                supplierFilterSelect.appendChild(option);
            });
        }

        function populateOriginCountryFilter() {
            const originCountryFilterSelect = document.getElementById('originCountryFilter');
            originCountryFilterSelect.innerHTML = '<option value="">Todos</option>'; // Limpa as opções existentes

            const uniqueCountries = new Set();
            orders.forEach(order => {
                if (order.originCountry) {
                    uniqueCountries.add(order.originCountry);
                }
            });

            Array.from(uniqueCountries).sort().forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.innerText = country;
                originCountryFilterSelect.appendChild(option);
            });
        }


        function renderOrdersTable() {
            const tbody = document.querySelector('#orderCenterTable tbody');
            tbody.innerHTML = ''; // Limpa o corpo da tabela

            const statusFilter = document.getElementById('statusFilter').value;
            const supplierFilterCode = document.getElementById('supplierFilter').value; // Obtém o código do filtro de fornecedor
            const originCountryFilter = document.getElementById('originCountryFilter').value; // Obtém o filtro do país de origem
            const orderSearchQuery = document.getElementById('orderSearch').value.toLowerCase();

            const getFlagImage = (country) => {
                switch(country.toLowerCase()) {
                    case 'colômbia':
                        return '<img src="https://e7.pngegg.com/pngimages/796/10/png-clipart-flag-of-colombia-flag-of-cambodia-colombia-flag-flag-sphere-thumbnail.png" alt="Bandeira da Colômbia" class="flag-icon">';
                    case 'hong kong':
                        // Usando a bandeira da China como um placeholder para Hong Kong
                        return '<img src="https://e7.pngegg.com/pngimages/630/750/png-clipart-flag-of-china-association-of-southeast-asian-nations-national-flag-asean%E3%81%AE%E7%B4%8B%E7%AB%A0-china-orange-world-thumbnail.png" alt="Bandeira de Hong Kong" class="flag-icon">';
                    default:
                        return '<span>🚩</span>'; // Bandeira padrão para países desconhecidos
                }
            };

            const filteredOrders = orders.filter(order => {
                const matchesStatus = statusFilter === '' || order.status === statusFilter;
                // Filtra por código de fornecedor, convertendo o nome do fornecedor do pedido para seu código
                const matchesSupplier = supplierFilterCode === '' || getOrGenerateSupplierCode(order.supplier) === supplierFilterCode; 
                const matchesOriginCountry = originCountryFilter === '' || order.originCountry === originCountryFilter; // Nova condição de filtro
                const matchesSearch = orderSearchQuery === '' ||
                                      order.orderId.toLowerCase().includes(orderSearchQuery) ||
                                      (order.parentOrderId && order.parentOrderId.toLowerCase().includes(orderSearchQuery)) || // Inclui busca pelo ID pai
                                      order.clientFlag.toLowerCase().includes(orderSearchQuery);
                return matchesStatus && matchesSupplier && matchesOriginCountry && matchesSearch; // Combina todos os filtros
            });

            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                
                let statusIndicatorClass = '';
                // Lógica para definir a cor do indicador de status na Central de Pedidos
                switch (order.status) {
                    case 'Aprovado':
                    case 'Carga Pronta':
                    case 'Carga Entregue':
                    case 'Entregue':
                        statusIndicatorClass = 'green';
                        break;
                    case 'Pendente':
                    case 'Aguardando Aprovação':
                    case 'Em Negociação':
                        statusIndicatorClass = 'yellow';
                        break;
                    case 'Rejeitado':
                        statusIndicatorClass = 'red';
                        break;
                    case 'Em Processamento':
                    case 'Em Separação':
                    case 'Em Conferência':
                    case 'Em Rota de Entrega':
                        statusIndicatorClass = 'blue';
                        break;
                    case 'Cancelado':
                        statusIndicatorClass = 'gray';
                        break;
                    default:
                        statusIndicatorClass = 'yellow'; // Fallback
                }

                const flagImageHtml = getFlagImage(order.originCountry);
                // Exibe apenas o código numérico do fornecedor
                const displaySupplierCode = order.supplier ? getOrGenerateSupplierCode(order.supplier) : 'N/A';


                row.innerHTML = `
                    <td>${order.parentOrderId ? order.parentOrderId : 'N/A'}</td> <!-- ID Solicitação Principal em primeiro, renomeado para 'Id' -->
                    <td><a href="#" class="order-link" onclick="viewOrderDetails('${order.orderId}')">${order.orderId}</a></td> <!-- Link agora no Nº Pedido -->
                    <td>${flagImageHtml}</td>
                    <td>${order.originCountry}</td>
                    <td>${displaySupplierCode}</td> <!-- Exibe apenas o código do fornecedor -->
                    <td>R$ ${order.totalValue.toFixed(2).replace('.', ',')}</td>
                    <td><span class="status-indicator ${statusIndicatorClass}"></span>${order.status}</td>
                    <td>${order.requestDate}</td>
                    <td>${order.lastUpdateDate}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewOrderDetails(orderId) {
            currentOrderDetails = orders.find(order => order.orderId === orderId);
            if (!currentOrderDetails) {
                showMessage('Erro', 'Detalhes do pedido não encontrados.', 'error');
                return;
            }

            document.getElementById('currentOrderId').innerText = currentOrderDetails.orderId;
            document.getElementById('detailOrderId').innerText = currentOrderDetails.orderId;
            document.getElementById('detailParentOrderId').innerText = currentOrderDetails.parentOrderId ? currentOrderDetails.parentOrderId : 'N/A'; // Exibe o ID Principal

            // Constrói o display da origem com bandeira e nome do país
            const getFlagImageForDetails = (country) => {
                switch(country.toLowerCase()) {
                    case 'colômbia':
                        return '<img src="https://e7.pngegg.com/pngimages/796/10/png-clipart-flag-of-colombia-flag-of-cambodia-colombia-flag-flag-sphere-thumbnail.png" alt="Bandeira da Colômbia" class="flag-icon inline-block mr-2">';
                    case 'hong kong':
                        return '<img src="https://e7.pngegg.com/pngimages/630/750/png-clipart-flag-of-china-association-of-southeast-asian-nations-national-flag-asean%E3%81%AE%E7%B4%8B%E7%AB%A0-china-orange-world-thumbnail.png" alt="Bandeira de Hong Kong" class="flag-icon inline-block mr-2">';
                    default:
                        return '<span class="mr-2">🚩</span>'; // Bandeira padrão
                }
            };
            document.getElementById('detailOriginDisplay').innerHTML = `${getFlagImageForDetails(currentOrderDetails.originCountry)}${currentOrderDetails.originCountry}`;


            document.getElementById('detailSupplier').innerText = currentOrderDetails.supplier ? getOrGenerateSupplierCode(currentOrderDetails.supplier) : 'N/A'; // Exibe o Fornecedor com código
            document.getElementById('detailTotalValue').innerText = `R$ ${currentOrderDetails.totalValue.toFixed(2).replace('.', ',')}`;
            document.getElementById('detailStatus').innerText = currentOrderDetails.status; // Ainda exibe o status direto

            const productsTableBody = document.getElementById('orderDetailsProductsTableBody');
            productsTableBody.innerHTML = ''; // Limpa as linhas existentes

            currentOrderDetails.products.forEach(product => {
                const row = document.createElement('tr');
                const itemTotalPrice = (product.quantity * product.unitPrice).toFixed(2);
                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.description}</td>
                    <td>${product.quantity}</td>
                    <td>R$ ${product.unitPrice.toFixed(2).replace('.', ',')}</td>
                    <td>R$ ${itemTotalPrice.replace('.', ',')}</td>
                `;
                productsTableBody.appendChild(row);
            });

            // Renderiza a seção de tracking
            renderTracking(currentOrderDetails);

            showScreen('orderDetailsScreen');
        }

        // --- Lógica de Tracking ---
        const hongKongTrackingFlow = [
            { name: 'Pendente', class: 'pending' },
            { name: 'Em Negociação', class: 'negotiation' },
            { name: 'Aguardando Aprovação', class: 'waiting-approval' },
            { name: 'Aprovado', class: 'approved' },
            { name: 'Carga Pronta', class: 'ready-cargo' },
            { name: 'Carga Em rota de Entrega', class: 'in-transit' },
            { name: 'Carga Entregue', class: 'delivered' },
            { name: 'Rejeitado', class: 'rejected', isFinal: true },
            { name: 'Cancelado', class: 'cancelled', isFinal: true }
        ];

        const colombiaTrackingFlow = [
            { name: 'Pendente', class: 'pending' },
            { name: 'Em Separação', class: 'separation' },
            { name: 'Em Conferência', class: 'conference' },
            { name: 'Em Rota de Entrega', class: 'in-transit' },
            { name: 'Entregue', class: 'delivered' },
            { name: 'Aprovado', class: 'approved' }, // Aprovado pode ser pós-entrega, se o ERP aprova o faturamento
            { name: 'Rejeitado', class: 'rejected', isFinal: true },
            { name: 'Cancelado', class: 'cancelled', isFinal: true }
        ];

        function renderTracking(order) {
            const trackingSection = document.getElementById('orderTrackingSection');
            trackingSection.innerHTML = ''; // Limpa a seção de tracking

            let flow = [];
            if (order.originCountry === 'Hong Kong') {
                flow = hongKongTrackingFlow;
            } else if (order.originCountry === 'Colômbia') {
                flow = colombiaTrackingFlow;
            } else {
                trackingSection.innerHTML = '<p class="text-gray-500 text-center">Rastreamento não disponível para esta origem.</p>';
                return;
            }

            const currentStatusIndex = flow.findIndex(step => step.name === order.status);
            let trackingHtml = '<div class="tracking-steps">';

            flow.forEach((step, index) => {
                let stepClass = '';
                let circleContent = ''; // Conteúdo do círculo (vazio ou ícone)

                // Lógica de destaque e cor para o status atual
                if (index === currentStatusIndex) {
                    stepClass = 'active';
                    // Adiciona classes de cor específicas para o status ATIVO
                    if (step.class) {
                         stepClass += ` ${step.class}`; // Adiciona a classe de cor personalizada (e.g., 'negotiation', 'approved')
                    }
                } else if (index < currentStatusIndex) {
                    // Status que já foram concluídos
                    stepClass = 'completed';
                    if (step.class) { // Adiciona a classe de cor personalizada para passos concluídos
                        stepClass += ` ${step.class}`;
                    }
                } else {
                    // Status futuros (ainda não alcançados)
                    stepClass = 'future'; // Adicione uma classe para estilos futuros, se necessário
                }

                // Casos especiais para status "Rejeitado" e "Cancelado"
                if ((step.name === 'Rejeitado' || step.name === 'Cancelado') && index === currentStatusIndex) {
                    stepClass = `active ${step.class}`; // Garante que fiquem vermelhos se forem o status atual
                } else if ((step.name === 'Rejeitado' || step.name === 'Cancelado') && index < currentStatusIndex) {
                     // Se Rejeitado/Cancelado já passou, mas o status atual NÃO é um status final (ex: Rejeitado -> Carga Pronta), eles ainda ficam vermelhos
                    if (flow[currentStatusIndex].isFinal === false) { // Se o status ATUAL NÃO é um status final
                         stepClass = `completed ${step.class}`; // Considera-se concluído (em termos de ter passado)
                    } else { // Se o status ATUAL é outro status final (ex: Rejeitado -> Cancelado)
                         stepClass = `completed ${step.class}`; // Marca como concluído (passou por ele)
                    }
                }

                // Conteúdo do círculo (opcional, pode ser um número ou um ícone de "check")
                if (stepClass.includes('completed') && !step.isFinal) { // Adiciona checkmark para concluídos não-finais
                    circleContent = '&#10003;'; // Checkmark Unicode
                } else if (index === currentStatusIndex) { // Para o status atual
                    circleContent = (index + 1).toString(); // Número do passo
                }

                trackingHtml += `
                    <div class="tracking-step ${stepClass}">
                        <div class="circle">${circleContent}</div>
                        <span>${step.name}</span>
                    </div>
                `;
            });
            trackingHtml += '</div>';
            trackingSection.innerHTML = trackingHtml;
        }


        // --- Lógica do Fluxo de Hong Kong ---
        function updateProductDetailsOnClientCodeChangeHK() {
            const clientProductCodeInput = document.getElementById('clientProductCodeHK').value.trim().toUpperCase();
            const mappedProductCodeDisplay = document.getElementById('mappedProductCodeDisplayHK');
            const productDescriptionDisplay = document.getElementById('productDescriptionDisplayHK');
            const productValueDisplay = document.getElementById('productValueHK');
            const totalM3Display = document.getElementById('totalM3DisplayHK');
            const moqLiveFeedbackDiv = document.getElementById('moqLiveFeedbackHK');

            // Reseta os campos de exibição
            mappedProductCodeDisplay.innerText = '--';
            productDescriptionDisplay.innerText = '--';
            productValueDisplay.innerText = 'R$ 0,00';
            totalM3Display.innerText = '0.00 m³';
            moqLiveFeedbackDiv.innerText = '';
            moqLiveFeedbackDiv.className = 'text-xs mt-1';

            // Usa o mapa universal para busca de código de cliente para código de produto
            const productCode = universalClientCodeToProductCodeMap[clientProductCodeInput];
            const productInfo = productDatabase[productCode];

            if (productInfo) {
                mappedProductCodeDisplay.innerText = productCode; // Exibe o código PROD
                productDescriptionDisplay.innerText = `${productInfo.description}`;
                productDescriptionDisplay.style.color = '#374151';
                productValueDisplay.innerText = `R$ ${productInfo.tableValue.toFixed(2).replace('.', ',')}`;
                
                calculateTotalM3HK();
                checkMoqLiveHK();
            } else {
                productDescriptionDisplay.innerText = 'Cód Prod Cliente não encontrado.';
                productDescriptionDisplay.style.color = '#dc2626';
            }
        }

        function calculateTotalM3HK() {
            const clientProductCode = document.getElementById('clientProductCodeHK').value.trim().toUpperCase();
            const productCode = universalClientCodeToProductCodeMap[clientProductCode];
            const productInfo = productDatabase[productCode];
            const quantity = parseInt(document.getElementById('productQuantityHK').value);
            const totalM3Display = document.getElementById('totalM3DisplayHK');

            if (productInfo && !isNaN(quantity) && quantity > 0) {
                const totalM3 = productInfo.cubageUnit * quantity;
                totalM3Display.innerText = `${totalM3.toFixed(2).replace('.', ',')} m³`;
            } else {
                totalM3Display.innerText = '0.00 m³';
            }
        }

        function checkMoqLiveHK() {
            const clientProductCode = document.getElementById('clientProductCodeHK').value.trim().toUpperCase();
            const productCode = universalClientCodeToProductCodeMap[clientProductCode];
            const productQuantity = parseInt(document.getElementById('productQuantityHK').value);
            const moqFeedbackDiv = document.getElementById('moqLiveFeedbackHK');

            const productInfo = productDatabase[productCode];

            if (!productInfo) {
                moqFeedbackDiv.innerText = 'Por favor, insira um código de produto válido.';
                moqFeedbackDiv.className = 'moq-feedback-error';
                return;
            }

            if (isNaN(productQuantity) || productQuantity <= 0) {
                moqFeedbackDiv.innerText = '';
                moqFeedbackDiv.className = 'text-xs mt-1';
                return;
            }

            const moq = productInfo.moq;

            if (productQuantity < moq) {
                moqFeedbackDiv.innerText = `⚠️ Quantidade (${productQuantity}) abaixo do MOQ mínimo (${moq}). Este item será cancelado se não for ajustado.`;
                moqFeedbackDiv.className = 'moq-feedback-error';
            } else {
                moqFeedbackDiv.innerText = `✅ Quantidade (${productQuantity}) atende ao MOQ mínimo (${moq}).`;
                moqFeedbackDiv.className = 'moq-feedback-ok';
            }
        }

        function addProductHK() {
            const clientProductCode = document.getElementById('clientProductCodeHK').value.trim().toUpperCase();
            const productCode = universalClientCodeToProductCodeMap[clientProductCode];
            const quantity = parseInt(document.getElementById('productQuantityHK').value);
            const productInfo = productDatabase[productCode];

            if (!productInfo) {
                displayAddProductMessage('Erro: Código de produto cliente inválido.', 'error', 'hongkong');
                return;
            }

            if (isNaN(quantity) || quantity <= 0) {
                displayAddProductMessage('Erro: Por favor, insira uma quantidade válida para o produto.', 'error', 'hongkong');
                return;
            }

            if (quantity < productInfo.moq) {
                displayAddProductMessage(`Erro: Quantidade (${quantity}) abaixo do MOQ mínimo (${productInfo.moq}).`, 'error', 'hongkong');
                return;
            }

            // Calcula M3 total para o produto adicionado
            const totalM3 = (productInfo.cubageUnit * quantity).toFixed(2);
            // Calcula o valor total para o produto adicionado (usando tableValue para exibição)
            const totalValue = (productInfo.tableValue * quantity).toFixed(2);


            // Verifica se o produto já está na lista, se sim, atualiza a quantidade e M3
            const existingProductIndex = hongKongProducts.findIndex(p => p.code === productCode);
            if (existingProductIndex > -1) {
                hongKongProducts[existingProductIndex].quantity += quantity;
                hongKongProducts[existingProductIndex].totalM3 = (parseFloat(hongKongProducts[existingProductIndex].totalM3) + parseFloat(totalM3)).toFixed(2);
                hongKongProducts[existingProductIndex].totalValue = (parseFloat(hongKongProducts[existingProductIndex].totalValue) + parseFloat(totalValue)).toFixed(2);
                displayAddProductMessage(`Quantidade de "${productInfo.description}" atualizada para ${hongKongProducts[existingProductIndex].quantity}.`, 'success', 'hongkong');
            } else {
                hongKongProducts.push({
                    clientCode: clientProductCode, // Este é o código SKU
                    code: productCode, // Este é o código PROD
                    name: productInfo.description,
                    quantity: quantity,
                    moq: productInfo.moq,
                    unitPrice: productInfo.unitPrice, // Este é o preço unitário de aquisição
                    tableValue: productInfo.tableValue, // Este é o preço da tabela para exibição
                    cubageUnit: productInfo.cubageUnit,
                    totalM3: totalM3,
                    totalValue: totalValue,
                    supplier: productInfo.supplier // Adiciona o fornecedor do produto
                });
                displayAddProductMessage(`"${productInfo.description}" adicionado com sucesso.`, 'success', 'hongkong');
            }

            renderHongKongProductList();
            // Limpa os campos de entrada após adicionar
            document.getElementById('clientProductCodeHK').value = '';
            document.getElementById('mappedProductCodeDisplayHK').innerText = '--';
            document.getElementById('productDescriptionDisplayHK').innerText = '--';
            document.getElementById('productQuantityHK').value = '1';
            document.getElementById('productValueHK').innerText = 'R$ 0,00';
            document.getElementById('totalM3DisplayHK').innerText = '0.00 m³';
            document.getElementById('moqLiveFeedbackHK').innerText = '';
        }

        function removeProductHK(index) {
            hongKongProducts.splice(index, 1);
            renderHongKongProductList();
            displayAddProductMessage('Produto removido.', 'info', 'hongkong');
        }

        function renderHongKongProductList() {
            const listDiv = document.getElementById('productListHK');
            listDiv.innerHTML = '<h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados na Solicitação:</h3>';
            if (hongKongProducts.length === 0) {
                listDiv.innerHTML += '<div id="noProductsAddedHK" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>';
                return;
            }

            // Cria uma tabela para os produtos adicionados
            let tableHtml = `<table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Cód Cliente</th>
                                        <th>Cód Produto</th>
                                        <th>Descrição</th>
                                        <th>Qtd. Solicitada</th>
                                        <th>Valor Unit.</th>
                                        <th>Valor Total</th>
                                        <th>M³ Total</th>
                                        <th>Fornecedor</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            hongKongProducts.forEach((product, index) => {
                tableHtml += `
                    <tr>
                        <td>${product.clientCode}</td>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>R$ ${parseFloat(product.tableValue).toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${parseFloat(product.totalValue).toFixed(2).replace('.', ',')}</td>
                        <td>${parseFloat(product.totalM3).toFixed(2).replace('.', ',')} m³</td>
                        <td>${product.supplier || 'N/A'}</td> <!-- Exibe o fornecedor -->
                        <td><button onclick="removeProductHK(${index})" class="text-red-500 hover:text-red-700 font-bold text-sm">Remover</button></td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            listDiv.innerHTML += tableHtml;
        }

        function submitHongKongForm() {
            if (hongKongProducts.length === 0) {
                showMessage('Erro', 'Por favor, adicione pelo menos um produto antes de enviar a solicitação.', 'error');
                return;
            }

            // Gera o ID da solicitação principal (SOL-XXX)
            currentParentOrderId = `SOL-${nextParentRequestCounter.toString().padStart(3, '0')}`;
            nextParentRequestCounter++; // Incrementa para a próxima solicitação

            let moqValidationResultDiv = document.getElementById('moqValidationResult');
            moqValidationResultDiv.innerHTML = '<h3 class="font-semibold text-gray-700 mb-2">Validação de MOQ:</h3>';

            let validProductsAfterMoq = [];
            let allItemsCancelled = true; // Assume que todos os itens serão cancelados inicialmente

            hongKongProducts.forEach(product => {
                if (product.quantity < product.moq) { // Usa product.moq das informações do produto armazenadas
                    moqValidationResultDiv.innerHTML += `<p class="error-message">🚫 O item "${product.name}" (Qtd: ${product.quantity}) não atende ao MOQ mínimo de ${product.moq}. Este item será cancelado do pedido.</p>`;
                } else {
                    moqValidationResultDiv.innerHTML += `<p class="text-green-700">✅ O item "${product.name}" (Qtd: ${product.quantity}) atende ao MOQ mínimo (${product.moq}).</p>`;
                    validProductsAfterMoq.push(product);
                    allItemsCancelled = false; // Se pelo menos um item for válido, define como falso
                }
            });

            hongKongProducts = validProductsAfterMoq; // Atualiza a lista global apenas com produtos válidos

            const hkSummaryButtonsDiv = document.getElementById('hkSummaryButtons');
            const generatePoButton = hkSummaryButtonsDiv.querySelector('button:last-child'); // O botão 'Salvar Solicitação'

            if (hongKongProducts.length === 0) { // Verifica o comprimento após a validação de MOQ para ver se há produtos válidos restantes
                moqValidationResultDiv.innerHTML += `<p class="error-message mt-4">Todos os itens foram cancelados devido à falha no MOQ. Por favor, utilize o botão "Voltar e Ajustar" para corrigir sua solicitação.</p>`;
                generatePoButton.classList.add('hidden'); // Oculta o botão PO
            } else {
                generatePoButton.classList.remove('hidden'); // Garante que o botão PO esteja visível se houver produtos válidos

                // Simula a divisão por fornecedor e cria a tabela
                let supplierSplitHTML = '<h3 class="font-semibold text-gray-700 mt-4 mb-2">Divisão por Fornecedor:</h3>';
                // Agrupa produtos por fornecedor
                simulatedSupplierOrders = {}; // Reinicia antes de preencher
                hongKongProducts.forEach(product => {
                    const supplier = product.supplier || 'Fornecedor Desconhecido'; // Usa o fornecedor do produto
                    if (!simulatedSupplierOrders[supplier]) {
                        simulatedSupplierOrders[supplier] = [];
                    }
                    simulatedSupplierOrders[supplier].push(product);
                });

                for (const supplier in simulatedSupplierOrders) {
                    let totalCubagemForSupplier = 0;
                    let totalValueForSupplier = 0; // Novo: Subtotal do valor total
                    simulatedSupplierOrders[supplier].forEach(item => {
                        totalCubagemForSupplier += item.cubageUnit * item.quantity;
                        totalValueForSupplier += parseFloat(item.totalValue); // Acumula o valor total

                        // Armazena os preços para a tela de aprovação do Renato
                        item.newSupplierUnitPrice = item.unitPrice; // Armazena como número, não string
                        // Gera um preço interno atual aleatório, 5-15% mais alto que o preço de aquisição
                        item.currentInternalUnitPrice = item.unitPrice * (1 + (Math.random() * 0.1 + 0.05));
                        // Inicializa o status de aprovação para cada produto
                        item.approvalStatus = 'Pendente';
                    });

                    const percentLCL = totalCubagemForSupplier < 1 ? (totalCubagemForSupplier / 1 * 100).toFixed(2) : '>100'; 
                    const percent20HC = ((totalCubagemForSupplier / MAX_CUBAGE_20HC) * 100).toFixed(2);
                    const percent40HC = ((totalCubagemForSupplier / MAX_CUBAGE_40HC) * 100).toFixed(2);

                    supplierSplitHTML += `<div class="mb-4 p-2 border rounded-md bg-white">
                                            <strong>${supplier} (Cód: ${getOrGenerateSupplierCode(supplier)}):</strong>
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Cód Cliente</th>
                                                        <th>Cód Produto</th>
                                                        <th>Descrição</th>
                                                        <th>Qtd. Solicitada</th>
                                                        <th>MOQ</th>
                                                        <th>Valor Unit.</th>
                                                        <th>Valor Total</th>
                                                        <th>M³ Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>`;
                    simulatedSupplierOrders[supplier].forEach(item => {
                        supplierSplitHTML += `
                                                    <tr>
                                                        <td>${item.clientCode}</td>
                                                        <td>${item.code}</td>
                                                        <td>${item.name}</td>
                                                        <td>${item.quantity}</td>
                                                        <td>${item.moq}</td>
                                                        <td>R$ ${parseFloat(item.tableValue).toFixed(2).replace('.', ',')}</td>
                                                        <td>R$ ${parseFloat(item.totalValue).toFixed(2).replace('.', ',')}</td>
                                                        <td>${parseFloat(item.totalM3).toFixed(2).replace('.', ',')} m³</td>
                                                    </tr>`;
                    });
                    supplierSplitHTML += `
                                                </tbody>
                                            </table>
                                            <p class="mt-4 font-semibold">Subtotal (Valor): R$ ${totalValueForSupplier.toFixed(2).replace('.', ',')}</p>
                                            <h4 class="font-semibold text-gray-700 mt-2 mb-2">Previsão de Cubagem para este fornecedor:</h4>
                                            <p><strong>Subtotal Cubagem:</strong> ${totalCubagemForSupplier.toFixed(2).replace('.', ',')} m³</p>
                                            <ul class="list-disc pl-5">
                                                <li>Percentual LCL (carga solta): ${percentLCL}%</li>
                                                <li>Percentual Contêiner 20 HC: ${percent20HC}% (Capacidade: ${MAX_CUBAGE_20HC} m³)</li>
                                                <li>Percentual Contêiner 40 HC: ${percent40HC}% (Capacidade: ${MAX_CUBAGE_40HC} m³)</li>
                                            </ul>
                                          </div>`;
                }
                document.getElementById('supplierSplitResult').innerHTML = supplierSplitHTML;
            }
            showScreen('hongKongSummaryScreen');
        }

        function generatePO() {
            if (Object.keys(simulatedSupplierOrders).length === 0) {
                showMessage('Erro', 'Nenhum pedido de fornecedor para gerar a solicitação.', 'error');
                return;
            }

            let poDetailsHtml = '';

            poDetailsHtml += `
                <div class="mb-6 p-4 border rounded-lg bg-blue-50 text-blue-800 shadow-sm">
                    <p class="font-semibold text-lg mb-2">Solicitação Principal: <strong>${currentParentOrderId}</strong></p>
                    <p>Todos os pedidos gerados abaixo estão vinculados a esta solicitação principal.</p>
                </div>
            `;


            for (const supplier in simulatedSupplierOrders) {
                const supplierProducts = simulatedSupplierOrders[supplier];
                const currentPOId = `PED-${nextPurchaseOrderIdCounter.toString().padStart(3, '0')}`; // Gera novo PED-XXX
                nextPurchaseOrderIdCounter++; // Incrementa para o próximo PED

                // Calcula os totais para esta PO específica
                const newSupplierPriceTotal = supplierProducts.reduce((sum, p) => sum + p.newSupplierUnitPrice * p.quantity, 0).toFixed(2);
                const currentInternalPriceTotal = supplierProducts.reduce((sum, p) => sum + p.currentInternalUnitPrice * p.quantity, 0).toFixed(2);
                const displaySupplierCode = getOrGenerateSupplierCode(supplier); // Obtém o código numérico

                // Adiciona o PO à lista global `generatedPurchaseOrders` com o `overallApprovalStatus` inicial como 'Pendente'
                generatedPurchaseOrders.push({
                    parentOrderId: currentParentOrderId, // Associa com o ID da solicitação principal
                    id: currentPOId,
                    supplier: supplier, // Armazena o nome original
                    supplierCode: displaySupplierCode, // Armazena o código numérico
                    date: new Date().toLocaleDateString('pt-BR'),
                    products: supplierProducts.map(p => ({ ...p, approvalStatus: 'Pendente' })), // Garante que cada produto no PO tenha o status
                    newSupplierPriceTotal: newSupplierPriceTotal,
                    currentInternalPriceTotal: currentInternalPriceTotal,
                    overallApprovalStatus: 'Pendente' // Status geral do PO (inicialmente pendente)
                });

                // Adiciona o pedido recém-gerado à lista de pedidos simulados para que apareça na Central de Pedidos
                orders.push({
                    orderId: currentPOId,
                    parentOrderId: currentParentOrderId,
                    clientFlag: currentUserClientName, // Usa a razão social do usuário logado
                    originCountry: 'Hong Kong', // Hardcoded para Hong Kong, pois é o fluxo atual
                    totalValue: parseFloat(newSupplierPriceTotal),
                    status: 'Aguardando Aprovação', // Status inicial para novos pedidos HK
                    requestDate: new Date().toLocaleDateString('pt-BR'),
                    lastUpdateDate: new Date().toLocaleDateString('pt-BR'),
                    supplier: supplier, // Armazena o nome original do fornecedor
                    products: supplierProducts
                });
            }

            // Re-renderiza os detalhes da PO HTML usando os generatedPurchaseOrders preenchidos
            poDetailsHtml = `
                <div class="mb-6 p-4 border rounded-lg bg-blue-50 text-blue-800 shadow-sm">
                    <p class="font-semibold text-lg mb-2">Solicitação Principal: <strong>${currentParentOrderId}</strong></p>
                    <p>Todos os pedidos gerados abaixo estão vinculados a esta solicitação principal.</p>
                </div>
            `;
            // Filtra generatedPurchaseOrders para mostrar apenas os POs relacionados à solicitação principal atual
            const poToDisplayInCurrentRequest = generatedPurchaseOrders.filter(po => po.parentOrderId === currentParentOrderId);

            poToDisplayInCurrentRequest.forEach(po => {
                poDetailsHtml += `
                    <div class="mb-6 p-4 border rounded-lg bg-white shadow-sm">
                        <p class="font-semibold text-lg mb-2">Pedido para ${po.supplier} (Cód: ${po.supplierCode}):</p>
                        <p><strong>Nº Pedido:</strong> ${po.id}</p>
                        <p><strong>Data de Emissão:</strong> ${po.date}</p>
                        <p class="mt-4 font-semibold">Produtos no Pedido:</p>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Descrição</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${po.products.map(p => `
                                    <tr>
                                        <td>${p.code}</td>
                                        <td>${p.name}</td>
                                        <td>${p.quantity}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <p class="mt-4 font-semibold text-xl">Valor Total Estimado: R$ ${po.newSupplierPriceTotal.replace('.', ',')}</p>
                    </div>
                `;
            });

            document.getElementById('poDetails').innerHTML = poDetailsHtml;
            populateSupplierFilter(); // Atualiza o filtro de fornecedores com fornecedores potencialmente novos
            populateOriginCountryFilter(); // Atualiza o filtro do país de origem, pois novos pedidos podem ter novos países
            showScreen('purchaseOrderScreen');
        }

        function simulateRenatoApprovalScreen() {
            // Filtra generatedPurchaseOrders para pegar apenas os POs que estão Pendentes de Aprovação (OverallApprovalStatus)
            const poToApprove = generatedPurchaseOrders.filter(po => po.overallApprovalStatus === 'Pendente');

            if (poToApprove.length === 0) {
                showMessage('Info', 'Não há solicitações de compra para aprovação no momento.', 'info');
                return;
            }

            // Exibe a lista de pedidos pendentes e oculta a visualização detalhada
            document.getElementById('pendingOrdersList').classList.remove('hidden');
            document.getElementById('detailedApprovalView').classList.add('hidden');

            const pendingOrdersTableBody = document.getElementById('pendingOrdersTableBody');
            pendingOrdersTableBody.innerHTML = ''; // Limpa as linhas existentes

            let anyPendingPOs = false;
            // Filtra TODOS os POs que estão pendentes para exibição na lista (overallApprovalStatus)
            const pendingIndividualPOs = generatedPurchaseOrders.filter(po => po.overallApprovalStatus === 'Pendente' || po.overallApprovalStatus === 'Em Negociação'); // Inclui "Em Negociação" como pendente de revisão para Renato

            pendingIndividualPOs.forEach(po => { // Itera sobre os POs individuais pendentes
                anyPendingPOs = true;
                // Sempre usa currentUserClientName para a coluna Cliente na tela de Renato
                const clientName = currentUserClientName;
                const lastUpdateDate = orders.find(o => o.orderId === po.id)?.lastUpdateDate || 'N/A'; // Pega a data da última atualização do PO individual

                // O valor total do pedido é o total do PO individual
                const totalValueForPO = parseFloat(po.newSupplierPriceTotal);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${po.parentOrderId ? po.parentOrderId : 'N/A'}</td> <!-- Exibe o ID da Solicitação Principal -->
                    <td>${po.id}</td> <!-- Exibe o ID do PO individual -->
                    <td>${clientName}</td>
                    <td>${po.supplier}</td>
                    <td>R$ ${totalValueForPO.toFixed(2).replace('.', ',')}</td>
                    <td>${po.date}</td>
                    <td>${lastUpdateDate}</td>
                    <td>
                        <button onclick="performAnalysisForPO('${po.id}')" class="btn btn-primary btn-sm">Realizar Análise</button>
                    </td>
                `;
                pendingOrdersTableBody.appendChild(row);
            });

            if (!anyPendingPOs) {
                pendingOrdersTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Nenhum pedido pendente de aprovação no momento.</td></tr>`;
            }

            showScreen('renatoApprovalScreen');
        }

        // Função para atualizar o estado visual dos botões
        function updateButtonVisualState(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (button.disabled) {
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // Nova função para realizar a análise de um único PO
        function performAnalysisForPO(poId) { // Alterado para receber poId
            // Mostra a tela de carregamento da análise
            document.getElementById('analysisLoadingScreen').classList.remove('hidden');

            // Após um atraso, esconde a tela de carregamento e mostra a tela de aprovação detalhada
            setTimeout(() => {
                document.getElementById('analysisLoadingScreen').classList.add('hidden');

                // Encontra o PO que corresponde ao poId fornecido e o define como o PO atualmente sendo visualizado
                currentViewingPO = generatedPurchaseOrders.find(po => po.id === poId);

                if (!currentViewingPO) {
                    showMessage('Erro', `O pedido ${poId} não foi encontrado.`, 'error');
                    // Voltar para a lista de pedidos pendentes se não houver PO para analisar
                    backToPendingOrdersList();
                    return;
                }

                // LOGGING FOR DEBUGGING
                console.log('Products in currentViewingPO after loading:', currentViewingPO.products);
                currentViewingPO.products.forEach((p, index) => {
                    console.log(`  Product ${index}: ${p.name}, Status: ${p.approvalStatus}`);
                });

                // Exibe a visualização de aprovação detalhada e oculta a lista
                document.getElementById('pendingOrdersList').classList.add('hidden');
                document.getElementById('detailedApprovalView').classList.remove('hidden');
                document.getElementById('currentDetailedParentOrderIdDisplay').innerText = currentViewingPO.id; // Exibe o ID do pedido individual

                const supplierApprovalCardsDiv = document.getElementById('supplierApprovalCards');
                supplierApprovalCardsDiv.innerHTML = ''; // Limpa os cartões existentes

                let totalGlobalDifference = 0; // Para calcular a diferença global para este PO individual

                let productsComparisonTable = `
                    <table class="data-table text-sm">
                        <thead>
                            <tr>
                                <th>Cód.</th>
                                <th>Produto</th>
                                <th>Qtd.</th>
                                <th>Vlr. Unit. Atual</th>
                                <th>Vlr. Unit. Novo</th>
                                <th>Total Atual</th>
                                <th>Novo Total</th>
                                <th>Dif. (R$)</th>
                                <th>Status</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                currentViewingPO.products.forEach(p => {
                    const currentPrice = parseFloat(p.currentInternalUnitPrice);
                    const newPrice = parseFloat(p.newSupplierUnitPrice);
                    const totalCurrentPrice = currentPrice * p.quantity;
                    const totalNewPrice = newPrice * p.quantity;
                    const differenceUnit = newPrice - currentPrice;
                    const differenceTotalPerProduct = differenceUnit * p.quantity;
                    totalGlobalDifference += differenceTotalPerProduct; // Acumula para a diferença global

                    // Calcula a porcentagem de diferença
                    let percentageDiff = 0;
                    if (currentPrice !== 0) {
                        percentageDiff = (differenceUnit / currentPrice) * 100;
                    }
                    const percentageDiffString = `(${percentageDiff.toFixed(0)}%)`; // Formato: (0%) ou (2%)

                    const differenceIcon = differenceUnit > 0 ? '🔴' : (differenceUnit < 0 ? '🟢' : '⚪'); // Círculo Vermelho, Verde, Branco
                    const differenceClass = differenceUnit > 0 ? 'price-difference-positive' : (differenceUnit < 0 ? 'price-difference-negative' : '');
                    
                    const statusClass = `product-approval-status ${p.approvalStatus}`;

                    productsComparisonTable += `
                        <tr id="product-row-${p.code}">
                            <td>${p.code}</td>
                            <td>${p.name}</td>
                            <td>${p.quantity}</td>
                            <td>${currentPrice.toFixed(2).replace('.', ',')}</td>
                            <td>${newPrice.toFixed(2).replace('.', ',')}</td>
                            <td>${totalCurrentPrice.toFixed(2).replace('.', ',')}</td>
                            <td>${totalNewPrice.toFixed(2).replace('.', ',')}</td>
                            <td class="${differenceClass}">${differenceTotalPerProduct.toFixed(2).replace('.', ',')} ${percentageDiffString} ${differenceIcon}</td>
                            <td><span id="product-status-${p.code}" class="${statusClass}">${p.approvalStatus}</span></td>
                            <td>
                                <div class="approval-buttons-group flex flex-col items-start">
                                    <button onclick="setProductApprovalStatus('${currentViewingPO.id}', '${p.code}', 'Aprovado')" class="btn btn-sm btn-approve ${p.approvalStatus === 'Aprovado' ? 'selected' : ''}">Aprovar</button>
                                    <button onclick="setProductApprovalStatus('${currentViewingPO.id}', '${p.code}', 'Negociar')" class="btn btn-sm btn-negotiate ${p.approvalStatus === 'Negociar' ? 'selected' : ''}">Negociar</button>
                                    <button onclick="setProductApprovalStatus('${currentViewingPO.id}', '${p.code}', 'Rejeitar')" class="btn btn-sm btn-reject ${p.approvalStatus === 'Rejeitado' ? 'selected' : ''}">Rejeitar</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                productsComparisonTable += `
                        </tbody>
                    </table>
                `;

                const supplierCardHtml = `
                    <div id="po-card-${currentViewingPO.id}" class="supplier-summary-card">
                        <h3 class="font-bold text-xl mb-3">Fornecedor: ${currentViewingPO.supplierCode} - ${currentViewingPO.supplier} (Pedido: ${currentViewingPO.id})</h3>
                        <div class="overflow-x-auto"> <!-- Added for horizontal scroll if table overflows -->
                            ${productsComparisonTable}
                        </div>
                    </div>
                `;
                supplierApprovalCardsDiv.innerHTML = supplierCardHtml; // Apenas um cartão por vez

                // Atualiza o resumo da diferença global no final para o PO individual atual
                const globalDifferenceSummaryDiv = document.getElementById('globalDifferenceSummary');
                const globalDifferenceValueSpan = document.getElementById('globalDifferenceValue');
                const globalDifferenceClass = totalGlobalDifference > 0 ? 'price-difference-positive' : 'price-difference-negative';
                const globalDifferenceText = totalGlobalDifference.toFixed(2).replace('.', ',');
                globalDifferenceValueSpan.innerText = `R$ ${globalDifferenceText}`;
                globalDifferenceValueSpan.className = globalDifferenceClass;
                globalDifferenceSummaryDiv.classList.remove('hidden');

                // Esconde ambos os botões inicialmente
                document.getElementById('saveApprovalBtn').classList.add('hidden');
                document.getElementById('finalizeApprovalBtn').classList.add('hidden');
                document.getElementById('saveApprovalBtn').disabled = true;
                document.getElementById('finalizeApprovalBtn').disabled = true;
                updateButtonVisualState('saveApprovalBtn');
                updateButtonVisualState('finalizeApprovalBtn');

                checkSaveButtonState(); // Verifica o estado do botão "Gravar"
            }, 2500); // Atraso de 2.5 segundos para a simulação da análise
        }

        // Nova função para definir o status de aprovação de um produto específico
        function setProductApprovalStatus(poId, productCode, status) {
            const po = generatedPurchaseOrders.find(p => p.id === poId);
            if (!po) return;

            const product = po.products.find(p => p.code === productCode);
            if (product) {
                product.approvalStatus = status;

                // Atualiza a UI do status
                const productStatusSpan = document.getElementById(`product-status-${productCode}`);
                if (productStatusSpan) {
                    productStatusSpan.innerText = status;
                    productStatusSpan.className = `product-approval-status ${status}`;
                }

                // Atualiza a UI dos botões
                const productRow = document.getElementById(`product-row-${productCode}`);
                if (productRow) {
                    const buttons = productRow.querySelectorAll('.approval-buttons-group button');
                    buttons.forEach(btn => {
                        btn.classList.remove('selected');
                        if (btn.innerText.toLowerCase() === status.toLowerCase()) {
                            btn.classList.add('selected');
                        }
                    });
                }
            }
            // LOGGING FOR DEBUGGING
            console.log(`Product ${productCode} status changed to: ${status}`);
            checkSaveButtonState(); // Verifica o estado do botão "Gravar" após cada mudança de status
        }

        // Função para verificar se o botão "Gravar" deve ser habilitado
        function checkSaveButtonState() {
            const saveBtn = document.getElementById('saveApprovalBtn');
            const finalizeBtn = document.getElementById('finalizeApprovalBtn');

            if (!currentViewingPO || !currentViewingPO.products) {
                console.log('checkSaveButtonState: currentViewingPO or products are null. Hiding and disabling both buttons.');
                saveBtn.classList.add('hidden');
                finalizeBtn.classList.add('hidden');
                saveBtn.disabled = true;
                finalizeBtn.disabled = true;
                updateButtonVisualState('saveApprovalBtn');
                updateButtonVisualState('finalizeApprovalBtn');
                return;
            }

            // O botão Gravar é habilitado apenas se TODOS os produtos tiverem um status selecionado (não 'Pendente')
            const allProductsDecided = currentViewingPO.products.every(p => p.approvalStatus !== 'Pendente');
            
            console.log('checkSaveButtonState: Current products status:', currentViewingPO.products.map(p => ({code: p.code, status: p.approvalStatus})));
            console.log('checkSaveButtonState: All products decided (non-Pendente)?', allProductsDecided);

            if (allProductsDecided) {
                saveBtn.classList.remove('hidden'); // Torna o botão "Gravar Análise" visível
                saveBtn.disabled = false;
            } else {
                saveBtn.classList.add('hidden'); // Esconde o botão "Gravar Análise"
                saveBtn.disabled = true;
            }
            console.log('checkSaveButtonState: saveApprovalBtn disabled state set to:', saveBtn.disabled);
            console.log('checkSaveButtonState: saveApprovalBtn hidden state set to:', saveBtn.classList.contains('hidden'));
            updateButtonVisualState('saveApprovalBtn'); // Apply visual state

            // O botão Finalizar permanece oculto e desabilitado até ser ativado por saveApprovalDecisions()
            console.log('checkSaveButtonState: finalizeApprovalBtn disabled state remains:', finalizeBtn.disabled);
            console.log('checkSaveButtonState: finalizeApprovalBtn hidden state remains:', finalizeBtn.classList.contains('hidden'));
            updateButtonVisualState('finalizeApprovalBtn'); // Apply visual state
        }

        // Nova função para salvar as decisões de aprovação
        function saveApprovalDecisions() {
            if (!currentViewingPO) {
                showMessage('Erro', 'Nenhum pedido para salvar as decisões.', 'error');
                return;
            }

            // Atualiza o overallApprovalStatus do PO baseado nas decisões dos produtos
            let hasRejected = currentViewingPO.products.some(p => p.approvalStatus === 'Rejeitado');
            let hasNegotiate = currentViewingPO.products.some(p => p.approvalStatus === 'Negociar');
            let allApproved = currentViewingPO.products.every(p => p.approvalStatus === 'Aprovado');

            if (hasRejected) {
                currentViewingPO.overallApprovalStatus = 'Rejeitado';
            } else if (hasNegotiate) {
                currentViewingPO.overallApprovalStatus = 'Em Negociação'; // Renato agora pode setar diretamente para "Em Negociação"
            } else if (allApproved) {
                currentViewingPO.overallApprovalStatus = 'Aprovado';
            } else {
                currentViewingPO.overallApprovalStatus = 'Pendente'; // Should have been decided if the button was enabled
            }

            // Atualiza o status correspondente no array 'orders'
            const orderIndex = orders.findIndex(o => o.orderId === currentViewingPO.id);
            if (orderIndex !== -1) {
                // Atualiza o status principal do pedido com base na decisão de Renato
                orders[orderIndex].status = currentViewingPO.overallApprovalStatus; // Status principal recebe o status de aprovação Renato
                orders[orderIndex].lastUpdateDate = new Date().toLocaleDateString('pt-BR');
            }

            showMessage('Sucesso', 'As decisões de aprovação foram gravadas.', 'success');
            document.getElementById('saveApprovalBtn').disabled = true; // Disable "Gravar" button after saving
            document.getElementById('finalizeApprovalBtn').disabled = false; // Enable "Finalizar Aprovação"
            document.getElementById('finalizeApprovalBtn').classList.remove('hidden'); // Torna "Finalizar Aprovação" visível
            updateButtonVisualState('saveApprovalBtn'); // Apply visual state
            updateButtonVisualState('finalizeApprovalBtn'); // Apply visual state
        }

        // Função para voltar da visualização de aprovação detalhada para a lista de pedidos pendentes
        function backToPendingOrdersList() {
            currentViewingPO = null; // Limpa o PO em visualização
            simulateRenatoApprovalScreen(); // Re-renderiza a lista inicial de pedidos pendentes
        }

        function displayRenatoFinalSummary() {
            // Verifica se o botão "Finalizar Aprovação" está habilitado (o que implica que a gravação já ocorreu)
            if (document.getElementById('finalizeApprovalBtn').disabled) {
                showMessage('Erro', 'Por favor, grave a análise antes de finalizar a aprovação.', 'error');
                return;
            }

            if (!currentViewingPO) {
                showMessage('Erro', 'Nenhum pedido selecionado para finalizar a análise.', 'error');
                return;
            }

            const finalTitle = currentViewingPO.overallApprovalStatus === 'Aprovado' ? 'Parabéns! Pedido Aprovado!' : 'Análise de Preços Concluída para este Pedido!';
            const finalMessage = currentViewingPO.overallApprovalStatus === 'Aprovado'
                ? `O pedido ${currentViewingPO.id} para a solicitação ${currentViewingPO.parentOrderId} foi aprovado. Compras Internacionais enviará a confirmação ao fornecedor e atualizará os preços finais no portal.`
                : (currentViewingPO.overallApprovalStatus === 'Rejeitado'
                    ? `Análise concluída para o pedido ${currentViewingPO.id} da solicitação ${currentViewingPO.parentOrderId}. O pedido foi rejeitado. A equipe de Compras Internacionais será notificada para renegociar se necessário.`
                    : `Análise concluída para o pedido ${currentViewingPO.id} da solicitação ${currentViewingPO.parentOrderId}. Alguns itens estão em negociação. A equipe de Compras Internacionais será notificada para prosseguir.`);

            document.getElementById('hongKongFinalTitle').innerText = finalTitle;
            document.getElementById('hongKongFinalMessage').innerText = finalMessage;

            let finalDetailsHtml = `<p class="font-semibold mb-2">Status do Pedido <strong>${currentViewingPO.id}</strong> (Solicitação Principal: <strong>${currentViewingPO.parentOrderId}</strong>):</p>`;

            let statusClass, statusText;
            switch (currentViewingPO.overallApprovalStatus) {
                case 'Aprovado':
                    statusClass = 'bg-green-50 text-green-800';
                    statusText = 'Aprovado ✅';
                    break;
                case 'Rejeitado':
                    statusClass = 'bg-red-50 text-red-800';
                    statusText = 'Rejeitado ❌';
                    break;
                case 'Em Negociação': // Renato agora pode setar diretamente para "Em Negociação"
                    statusClass = 'bg-yellow-50 text-yellow-800';
                    statusText = 'Em Negociação 🟡';
                    break;
                default:
                    statusClass = 'bg-blue-50 text-blue-800';
                    statusText = 'Pendente ⏳'; // Deveria ter sido decidido se o botão foi habilitado
            }

            const valueText = currentViewingPO.overallApprovalStatus === 'Aprovado' ? `<p>O valor de aquisição final negociado é de: <span class="font-bold">R$ ${currentViewingPO.newSupplierPriceTotal.replace('.', ',')}</span></p>` : '';

            finalDetailsHtml += `
                <div class="mb-4 p-3 border rounded-lg ${statusClass}">
                    <p>Pedido <strong>${currentViewingPO.id}</strong> para ${currentViewingPO.supplier} (Cód: ${currentViewingPO.supplierCode}) foi <strong>${statusText}</strong>.</p>
                    ${valueText}
                </div>
            `;
            finalDetailsHtml += '<p class="mt-4">Em breve, você receberá a atualização com os preços e quantidades finais fechadas.</p>';
            document.getElementById('finalDetailsHK').innerHTML = finalDetailsHtml;
            showScreen('hongKongFinalScreen');

            // Limpa o PO em visualização após exibir o resumo final
            currentViewingPO = null;
        }

        // --- Lógica do Fluxo da Colômbia ---
        function updateProductDetailsOnClientCodeChangeCOL() {
            const clientProductCodeInput = document.getElementById('clientProductCodeCOL').value.trim().toUpperCase();
            const productCodeDisplay = document.getElementById('productCodeCOLDisplay');
            const productDescriptionDisplay = document.getElementById('productDescriptionDisplayCOL');
            const productStockDisplay = document.getElementById('productStockCOL');
            const valorUnitDisplay = document.getElementById('valorUnitCOLDisplay');

            // Reseta os campos de exibição
            productCodeDisplay.innerText = '--';
            productDescriptionDisplay.innerText = '--';
            productDescriptionDisplay.style.color = '#4b5563';
            productStockDisplay.innerText = '--';
            productStockDisplay.style.color = '#4b5563';
            valorUnitDisplay.innerText = 'R$ 0,00';

            // Usa o mapa universal para busca de código de cliente para código de produto
            const productCode = universalClientCodeToProductCodeMap[clientProductCodeInput];
            const productInfo = productDatabase[productCode];

            if (productInfo) {
                productCodeDisplay.innerText = productCode; // Exibe o código PROD
                productDescriptionDisplay.innerText = `${productInfo.description}`;
                productDescriptionDisplay.style.color = '#374151';
                valorUnitDisplay.innerText = `R$ ${productInfo.unitPrice.toFixed(2).replace('.', ',')}`;

                if (productInfo.simulatedStock > 0) {
                    productStockDisplay.innerText = 'Sim';
                    productStockDisplay.style.color = '#16a34a'; // Verde para estoque
                } else {
                    productStockDisplay.innerText = 'Não';
                    productStockDisplay.style.color = '#dc2626'; // Vermelho para sem estoque
                }
            } else {
                productDescriptionDisplay.innerText = 'Cód Prod Cliente não encontrado.';
                productDescriptionDisplay.style.color = '#dc2626';
            }
        }

        function addProductCOL() {
            const clientProductCode = document.getElementById('clientProductCodeCOL').value.trim().toUpperCase();
            const productCode = universalClientCodeToProductCodeMap[clientProductCode];
            const productInfo = productDatabase[productCode];
            const quantity = parseInt(document.getElementById('productQuantityCOL').value);

            if (!productInfo) {
                displayAddProductMessage('Erro: Código de produto cliente inválido.', 'error', 'colombia');
                return;
            }

            if (isNaN(quantity) || quantity <= 0) {
                displayAddProductMessage('Erro: Por favor, insira uma quantidade válida para o produto.', 'error', 'colombia');
                return;
            }
            
            // Verifica o estoque ANTES de adicionar para a Colômbia
            if (productInfo.simulatedStock === 0) {
                displayAddProductMessage(`Produto Sem Estoque: O produto "${productInfo.description}" não possui estoque disponível no momento.`, 'error', 'colombia');
                return;
            }

            // Calcula o valor total para o produto adicionado
            const totalValue = (productInfo.unitPrice * quantity).toFixed(2);
            
            // Verifica se o produto já está na lista, se sim, atualiza a quantidade
            const existingProductIndex = colombiaProducts.findIndex(p => p.code === productCode);
            if (existingProductIndex > -1) {
                colombiaProducts[existingProductIndex].quantity += quantity;
                colombiaProducts[existingProductIndex].totalValue = (parseFloat(colombiaProducts[existingProductIndex].totalValue) + parseFloat(totalValue)).toFixed(2);
                displayAddProductMessage(`Quantidade de "${productInfo.description}" atualizada para ${colombiaProducts[existingProductIndex].quantity}.`, 'success', 'colombia');
            } else {
                colombiaProducts.push({
                    clientCode: clientProductCode,
                    code: productCode,
                    name: productInfo.description,
                    quantity: quantity,
                    unitPrice: productInfo.unitPrice,
                    simulatedStock: productInfo.simulatedStock, // Carrega informações de estoque para exibição, se necessário posteriormente
                    totalValue: totalValue
                });
                displayAddProductMessage(`"${productInfo.description}" adicionado com sucesso.`, 'success', 'colombia');
            }

            renderColombiaProductList();
            document.getElementById('clientProductCodeCOL').value = '';
            document.getElementById('productCodeCOLDisplay').innerText = '--';
            document.getElementById('productDescriptionDisplayCOL').innerText = '--';
            document.getElementById('productStockCOL').innerText = '--';
            document.getElementById('productQuantityCOL').value = '1';
            document.getElementById('valorUnitCOLDisplay').innerText = 'R$ 0,00';
        }

        function removeColombiaProduct(index) {
            colombiaProducts.splice(index, 1);
            renderColombiaProductList();
            displayAddProductMessage('Produto removido.', 'info', 'colombia');
        }

        function renderColombiaProductList() {
            const listDiv = document.getElementById('productListCOL');
            listDiv.innerHTML = '<h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados na Solicitação:</h3>';
            if (colombiaProducts.length === 0) {
                listDiv.innerHTML += '<div id="noProductsAddedCOL" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>';
                return;
            }

            // Cria uma tabela para os produtos adicionados
            let tableHtml = `<table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Cód Produto Cliente</th>
                                        <th>Cód Produto</th>
                                        <th>Descrição</th>
                                        <th>Qtd. Solicitada</th>
                                        <th>Valor Unit.</th>
                                        <th>Valor Total</th>
                                        <th>Estoque</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            colombiaProducts.forEach((product, index) => {
                const stockStatus = product.simulatedStock > 0 ? 'Sim' : 'Não';
                const stockColorClass = product.simulatedStock > 0 ? 'text-green-600' : 'text-red-600';
                tableHtml += `
                    <tr>
                        <td>${product.clientCode}</td>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>R$ ${parseFloat(product.unitPrice).toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${parseFloat(product.totalValue).toFixed(2).replace('.', ',')}</td>
                        <td class="${stockColorClass} font-semibold">${stockStatus}</td>
                        <td><button onclick="removeColombiaProduct(${index})" class="text-red-500 hover:text-red-700 font-bold text-sm">Remover</button></td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            listDiv.innerHTML += tableHtml;
        }

        // Função para adicionar produtos à lista de produtos de Hong Kong (usada pelos métodos "Fácil")
        function addProductsToHongKongList(productsToAdd) {
            let productsAddedCount = 0;
            let productsFailedCount = 0;
            let totalMoqIssues = 0;

            productsToAdd.forEach(productData => {
                const clientProductCode = productData.clientCode.trim().toUpperCase();
                const productCode = universalClientCodeToProductCodeMap[clientProductCode];
                const quantity = parseInt(productData.quantity);
                const productInfo = productDatabase[productCode];

                if (!productInfo) {
                    console.error(`Produto com Cód Cliente "${clientProductCode}" não encontrado.`);
                    productsFailedCount++;
                    return;
                }
                if (isNaN(quantity) || quantity <= 0) {
                    console.error(`Quantidade inválida para o produto "${clientProductCode}".`);
                    productsFailedCount++;
                    return;
                }
                if (quantity < productInfo.moq) {
                    console.warn(`Produto "${productInfo.description}" (Qtd: ${quantity}) abaixo do MOQ mínimo (${productInfo.moq}). Será cancelado.`);
                    totalMoqIssues++;
                    // Não adiciona produtos que não atendem ao MOQ
                    return; 
                }

                const totalM3 = (productInfo.cubageUnit * quantity).toFixed(2);
                const totalValue = (productInfo.tableValue * quantity).toFixed(2);

                const existingProductIndex = hongKongProducts.findIndex(p => p.code === productCode);
                if (existingProductIndex > -1) {
                    hongKongProducts[existingProductIndex].quantity += quantity;
                    hongKongProducts[existingProductIndex].totalM3 = (parseFloat(hongKongProducts[existingProductIndex].totalM3) + parseFloat(totalM3)).toFixed(2);
                    hongKongProducts[existingProductIndex].totalValue = (parseFloat(hongKongProducts[existingProductIndex].totalValue) + parseFloat(totalValue)).toFixed(2);
                } else {
                    hongKongProducts.push({
                        clientCode: clientProductCode,
                        code: productCode,
                        name: productInfo.description,
                        quantity: quantity,
                        moq: productInfo.moq,
                        unitPrice: productInfo.unitPrice,
                        tableValue: productInfo.tableValue,
                        cubageUnit: productInfo.cubageUnit,
                        totalM3: totalM3,
                        totalValue: totalValue,
                        supplier: productInfo.supplier // Adiciona o fornecedor do produto
                    });
                }
                productsAddedCount++;
            });

            renderHongKongProductList();

            let message = '';
            let type = 'info';
            if (productsAddedCount > 0) {
                message = `${productsAddedCount} produto(s) adicionado(s)/atualizado(s) com sucesso.`;
                type = 'success';
            }
            if (productsFailedCount > 0) {
                message += ` ${productsFailedCount} produto(s) inválido(s) ou não encontrado(s).`;
                type = 'error';
            }
            if (totalMoqIssues > 0) {
                message += ` ${totalMoqIssues} produto(s) com problema de MOQ (não adicionados).`;
                type = 'error';
            }
            if (productsAddedCount === 0 && productsFailedCount === 0 && totalMoqIssues === 0) {
                message = 'Nenhum produto válido foi processado ou adicionado.';
                type = 'info';
            }
            displayAddProductMessage(message, type, 'hongkong');
        }

        // Função para adicionar produtos à lista de produtos da Colômbia (usada pelos métodos "Fácil")
        function addProductsToColombiaList(productsToAdd) {
            let productsAddedCount = 0;
            let productsFailedCount = 0;
            let totalStockIssues = 0;

            productsToAdd.forEach(productData => {
                const clientProductCode = productData.clientCode.trim().toUpperCase();
                const productCode = universalClientCodeToProductCodeMap[clientProductCode];
                const quantity = parseInt(productData.quantity);
                const productInfo = productDatabase[productCode];

                if (!productInfo) {
                    console.error(`Produto com Cód Cliente "${clientProductCode}" não encontrado.`);
                    productsFailedCount++;
                    return;
                }
                if (isNaN(quantity) || quantity <= 0) {
                    console.error(`Quantidade inválida para o produto "${clientProductCode}".`);
                    productsFailedCount++;
                    return;
                }
                if (productInfo.simulatedStock === 0) {
                    console.warn(`Produto "${productInfo.description}" sem estoque. Não adicionado.`);
                    totalStockIssues++;
                    // Não adiciona produtos sem estoque
                    return; 
                }

                const totalValue = (productInfo.unitPrice * quantity).toFixed(2);

                const existingProductIndex = colombiaProducts.findIndex(p => p.code === productCode);
                if (existingProductIndex > -1) {
                    colombiaProducts[existingProductIndex].quantity += quantity;
                    colombiaProducts[existingProductIndex].totalValue = (parseFloat(colombiaProducts[existingProductIndex].totalValue) + parseFloat(totalValue)).toFixed(2);
                } else {
                    colombiaProducts.push({
                        clientCode: clientProductCode,
                        code: productCode,
                        name: productInfo.description,
                        quantity: quantity,
                        unitPrice: productInfo.unitPrice,
                        simulatedStock: productInfo.simulatedStock, // Carrega informações de estoque para exibição, se necessário posteriormente
                        totalValue: totalValue
                    });
                }
                productsAddedCount++;
            });

            renderColombiaProductList();

            let message = '';
            let type = 'info';
            if (productsAddedCount > 0) {
                message = `${productsAddedCount} produto(s) adicionado(s)/atualizado(s) com sucesso.`;
                type = 'success';
            }
            if (productsFailedCount > 0) {
                message += ` ${productsFailedCount} produto(s) inválido(s) ou não encontrado(s).`;
                type = 'error';
            }
            if (totalStockIssues > 0) {
                message += ` ${totalStockIssues} produto(s) sem estoque (não adicionados).`;
                type = 'error';
            }
             if (productsAddedCount === 0 && productsFailedCount === 0 && totalStockIssues === 0) {
                message = 'Nenhum produto válido foi processado ou adicionado.';
                type = 'info';
            }
            displayAddProductMessage(message, type, 'colombia');
        }

        function submitColombiaForm() {
            if (colombiaProducts.length === 0) {
                showMessage('Erro', 'Por favor, adicione pelo menos um produto antes de enviar a solicitação.', 'error');
                return;
            }

            const clientOrderNumber = document.getElementById('clientOrderNumberCOL').value.trim();
            const currentPOId = `PED-${nextPurchaseOrderIdCounter.toString().padStart(3, '0')}`; // Gera novo PED-XXX
            nextPurchaseOrderIdCounter++; // Incrementa para o próximo PED

            // Gera o ID da solicitação principal (SOL-XXX)
            currentParentOrderId = `SOL-${nextParentRequestCounter.toString().padStart(3, '0')}`;
            nextParentRequestCounter++; // Incrementa para a próxima solicitação

            // Simula o envio para o SAP e o recebimento de fatura
            setTimeout(() => {
                // Gera um valor total simulado para NF-e com base nos produtos da Colômbia
                const totalNfeValue = colombiaProducts.reduce((sum, p) => sum + parseFloat(p.totalValue), 0).toFixed(2);
                document.getElementById('nfeValue').innerText = `R$ ${totalNfeValue.replace('.', ',')}`;

                // Atualiza o conteúdo do PDF da NF-e com os produtos reais
                let productsInNfePdf = colombiaProducts.map((p, idx) => `| ${String(idx + 1).padStart(2, '0')}| ${p.name.padEnd(17)}| ${String(p.quantity).padEnd(3)} | R$ ${parseFloat(p.unitPrice).toFixed(2).padEnd(10).replace('.', ',')}| R$ ${parseFloat(p.totalValue).toFixed(2).padEnd(6).replace('.', ',')} |`).join('\n');
                let nfePdfContent = `
                    ----------------------------------------------------
                    |                NOTA FISCAL ELETRÔNICA            |
                    | Nº: NF-20250624-001                                |
                    | Data de Emissão: 24/06/2025                        |
                    | ${clientOrderNumber ? `Seu Pedido: ${clientOrderNumber}`.padEnd(50, ' ') + `|\n` : '' }
                    |                                                    |
                    | REMETENTE: EMPRESA XYZ DO BRASIL                   |
                    | CNPJ: 00.000.000/0001-00                           |
                    | ENDEREÇO: RUA EXEMPLO, 123 - SÃO PAULO/SP          |
                    |                                                    |
                    | DESTINATÁRIO: CLIENTE INTERNACIONAL COLÔMBIA       |
                    | ENDEREÇO: CALLE 45, 7-30 - BOGOTÁ/COLÔMBIA         |
                    |                                                    |
                    | PRODUTOS:                                          |
                    | -------------------------------------------------- |
                    | ID | DESCRIÇÃO           | QTD | VALOR UNIT | TOTAL |
                    |----|---------------------|-----|------------|-------|
                    ${productsInNfePdf}
                    |--------------------------------------------------|
                    | VALOR TOTAL:                                R$ ${totalNfeValue.replace('.', ',')} |
                    ----------------------------------------------------
                    (Este é um exemplo simulado de NF-e.)
                `;
                document.querySelector('#nfePdfViewer pre').innerText = nfePdfContent;

                // Adiciona o pedido à lista global `orders` com o status inicial 'Em Separação'
                orders.push({
                    orderId: currentPOId,
                    parentOrderId: currentParentOrderId,
                    clientFlag: currentUserClientName,
                    originCountry: 'Colômbia',
                    totalValue: parseFloat(totalNfeValue),
                    status: 'Em Separação', // Status inicial para Colômbia
                    requestDate: new Date().toLocaleDateString('pt-BR'),
                    lastUpdateDate: new Date().toLocaleDateString('pt-BR'),
                    supplier: 'N/A', // Ou determine um fornecedor para Colômbia
                    products: colombiaProducts
                });

                showScreen('colombiaInvoiceScreen');
            }, 1500); // Simula atraso de rede
        }

        function showNfePdf() {
            const pdfViewer = document.getElementById('nfePdfViewer');
            pdfViewer.classList.toggle('hidden');
        }

        // --- Funções do Modal de Catálogo de Produtos ---
        function openProductCatalogModal(filial) {
            currentProductCatalogFilial = filial;
            document.getElementById('productCatalogModal').classList.remove('hidden');
            document.getElementById('productCatalogSearchInput').value = ''; // Limpa a busca
            renderProductCatalogList(''); // Renderiza todos os produtos para a filial selecionada
        }

        function closeProductCatalogModal() {
            document.getElementById('productCatalogModal').classList.add('hidden');
        }

        function filterProductCatalog() {
            const searchTerm = document.getElementById('productCatalogSearchInput').value.toLowerCase();
            renderProductCatalogList(searchTerm);
        }

        function renderProductCatalogList(searchTerm) {
            const listDiv = document.getElementById('productCatalogList');
            listDiv.innerHTML = '';

            // Filtra produtos com base no termo de busca, mas NÃO mais por filial
            const productsToDisplay = Object.values(productDatabase).filter(product => {
                const matchesSearch = searchTerm === '' ||
                                      (product.code && product.code.toLowerCase().includes(searchTerm)) ||
                                      (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                                      (product.clientCode && product.clientCode.toLowerCase().includes(searchTerm));
                return matchesSearch; // Removida a correspondência por filial
            });

            if (productsToDisplay.length === 0) {
                listDiv.innerHTML = '<div class="text-gray-500 text-center py-4">Nenhum produto encontrado.</div>';
                return;
            }

            // Cria uma tabela para a lista do catálogo de produtos
            let tableHtml = `<table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Cód Produto Cliente</th>
                                        <th>Cód Produto</th>
                                        <th>Descrição do Produto</th>
                                        <th>Linha do Produto</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            productsToDisplay.forEach(product => {
                // Sempre exibe clientCode (SKU) no catálogo, pois é o identificador universal para a busca do cliente
                const displayClientCode = product.clientCode || 'N/A';
                const displayProductCode = product.code || 'N/A';
                tableHtml += `
                    <tr onclick="selectProductFromCatalog(productDatabase['${product.code}'])">
                        <td class="product-code-display">${displayClientCode}</td>
                        <td class="product-code-display">${displayProductCode}</td>
                        <td class="product-description-display">${product.description}</td>
                        <td class="product-line-display">${product.productLine || 'N/A'}</td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            listDiv.innerHTML = tableHtml;
        }

        function selectProductFromCatalog(product) {
            if (currentProductCatalogFilial === 'hongkong') {
                // Se o modal de catálogo foi aberto a partir do "Pedido Fácil", adiciona diretamente
                // Se foi aberto a partir do "Pedido Manual", preenche o campo de input
                if (document.getElementById('hongKongEasyOrderTab').classList.contains('active')) {
                    addProductsToHongKongList([{ clientCode: product.clientCode, quantity: 1 }]); // Adiciona 1 como default
                } else {
                    document.getElementById('clientProductCodeHK').value = product.clientCode || '';
                    updateProductDetailsOnClientCodeChangeHK(); 
                }
            } else if (currentProductCatalogFilial === 'colombia') {
                // Se o modal de catálogo foi aberto a partir do "Pedido Fácil", adiciona diretamente
                // Se foi aberto a partir do "Pedido Manual", preenche o campo de input
                if (document.getElementById('colombiaEasyOrderTab').classList.contains('active')) {
                    addProductsToColombiaList([{ clientCode: product.clientCode, quantity: 1 }]); // Adiciona 1 como default
                } else {
                    document.getElementById('clientProductCodeCOL').value = product.clientCode || '';
                    updateProductDetailsOnClientCodeChangeCOL();
                }
            }
            closeProductCatalogModal();
        }

        // Função para alternar o conteúdo de seções colapsáveis
        function toggleCollapsible(headerElement, contentId) {
            const contentElement = document.getElementById(contentId);
            const icon = headerElement.querySelector('.collapsible-icon');

            if (contentElement.classList.contains('hidden')) {
                contentElement.classList.remove('hidden');
                headerElement.classList.add('open');
            } else {
                contentElement.classList.add('hidden');
                headerElement.classList.remove('open');
            }
        }

        // Funções para "Pedido Fácil"
        function displayFileName(fileInputId, displaySpanId) {
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(displaySpanId);
            if (fileInput.files.length > 0) {
                fileNameDisplay.innerText = fileInput.files[0].name;
            } else {
                fileNameDisplay.innerText = 'Nenhum arquivo selecionado';
            }
        }

        function handleFileUpload(filial) {
            const fileInput = filial === 'hongkong' ? document.getElementById('fileUploadHK') : document.getElementById('fileUploadCOL');
            const file = fileInput.files[0];

            if (!file) {
                displayAddProductMessage('Por favor, selecione um arquivo CSV para upload.', 'error', filial);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const csvContent = e.target.result;
                const lines = csvContent.split('\n').filter(line => line.trim() !== ''); // Remove linhas vazias

                if (lines.length === 0) {
                    displayAddProductMessage('O arquivo CSV está vazio ou não contém dados válidos.', 'error', filial);
                    return;
                }

                // Assume que a primeira linha é o cabeçalho e ignora
                const productsData = [];
                for (let i = 1; i < lines.length; i++) {
                    const [clientCode, quantity] = lines[i].split(',').map(item => item.trim());
                    if (clientCode && quantity && !isNaN(parseInt(quantity))) {
                        productsData.push({ clientCode, quantity: parseInt(quantity) });
                    } else {
                        console.warn(`Linha inválida no CSV: "${lines[i]}"`);
                    }
                }

                if (filial === 'hongkong') {
                    addProductsToHongKongList(productsData);
                } else { // colombia
                    addProductsToColombiaList(productsData);
                }
                
                // Limpa o input de arquivo e o nome exibido após o upload
                fileInput.value = '';
                displayFileName(fileInput.id, filial === 'hongkong' ? 'fileNameDisplayHK' : 'fileNameDisplayCOL');
            };
            reader.onerror = () => {
                displayAddProductMessage('Erro ao ler o arquivo.', 'error', filial);
            };
            reader.readAsText(file);
        }

        function processPastedCodes(filial) {
            const textareaId = filial === 'hongkong' ? 'pasteCodesHK' : 'pasteCodesCOL';
            const codesString = document.getElementById(textareaId).value;
            const lines = codesString.split('\n').filter(line => line.trim() !== '');

            if (lines.length === 0) {
                displayAddProductMessage('Nenhum código para processar. Cole os códigos no formato "CODIGO,QUANTIDADE".', 'error', filial);
                return;
            }

            const productsData = [];
            lines.forEach(line => {
                const [clientCode, quantity] = line.split(',').map(item => item.trim());
                if (clientCode && quantity && !isNaN(parseInt(quantity))) {
                    productsData.push({ clientCode, quantity: parseInt(quantity) });
                } else {
                    console.warn(`Formato de linha inválido: "${line}"`);
                }
            });

            if (filial === 'hongkong') {
                addProductsToHongKongList(productsData);
            } else { // colombia
                addProductsToColombiaList(productsData);
            }

            // Limpar a textarea após o processamento
            document.getElementById(textareaId).value = '';
        }

        function downloadSpreadsheetModel() {
            // Simula o download de um arquivo CSV
            const csvContent = "data:text/csv;charset=utf-8,CodigoComercial,Quantidade\nSKU-001,10\nSKU-002,5";
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "modelo_planilha_pedido.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link); // Clean up
            showMessage('Download', 'O download do modelo de planilha foi iniciado.', 'info');
        }


        // --- Carregamento Inicial da Tela ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa os códigos de fornecedor para pedidos existentes uma vez no carregamento
            orders.forEach(order => {
                if (order.supplier) {
                    getOrGenerateSupplierCode(order.supplier);
                }
            });
            // Define os contadores iniciais com base nos dados atuais
            const maxSolId = orders.reduce((max, order) => {
                const solNum = parseInt(order.parentOrderId.replace('SOL-', ''));
                return isNaN(solNum) ? max : Math.max(max, solNum);
            }, 0);
            nextParentRequestCounter = maxSolId + 1;

            const maxPedId = orders.reduce((max, order) => {
                const pedNum = parseInt(order.orderId.replace('PED-', ''));
                return isNaN(pedNum) ? max : Math.max(max, pedNum);
            }, 0);
            nextPurchaseOrderIdCounter = maxPedId + 1;
            
            showScreen('loginScreen');
        });
    </script>
</body>
</html>
