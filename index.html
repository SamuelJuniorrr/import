<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protótipo do Portal Fluig - Import/Export</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">\
    <style>
        /* Define html and body to take full height and manage overflow */
        html, body {
            height: 100%; /* Ensure html and body take full height */
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fundo cinza claro */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to start, not center vertically, to allow natural flow and scrolling */
            padding: 20px; /* Padding around the content */
            box-sizing: border-box; /* Include padding in height/width */
            overflow-y: auto; /* Allow body to scroll if content exceeds viewport */
        }
        /* O .container é para o layout geral da aplicação e não para o card de login */
        .container {
            background-color: #ffffff; /* Ajuste para ser o fundo geral dos conteúdos das telas, se necessário */
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 24px; /* Ajuste para ser mais compacto, como o login */
            max-width: 400px; /* Largura mais estreita para o cartão de login e modais */
            width: 100%;
        }
        /* Novo wrapper para conteúdo principal de telas maiores */
        .app-content-wrapper {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 32px;
            max-width: 2400px; /* Mais largo para as telas principais, conforme solicitado */
            width: 100%;
            margin: 0 auto; /* Centraliza o wrapper */
        }

        .header {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        /* Estilo para inputs de formulário padrão */
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px; /* Cantos arredondados para inputs */
            font-size: 1rem;
            color: #374151;
        }
        /* Estilo específico para inputs de login com ícones, imitando image_1e26c4.png */
        .login-input-group {
            display: flex;
            align-items: center;
            border: 1px solid #d1d5db; /* Borda para todo o grupo de input */
            border-radius: 4px; /* Cantos menos arredondados para o grupo, combinando com a imagem */
            padding: 8px 12px; /* Preenchimento dentro do grupo */
            margin-bottom: 15px; /* Espaço entre inputs de login */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #ffffff; /* Fundo explicitamente branco */
        }
        .login-input-group:focus-within {
            border-color: #3b82f6; /* Borda azul no foco */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25); /* Sombra sutil no foco */
            background-color: #ffffff; /* Manter branco no foco */
        }
        .login-input-group .icon-svg {
            color: #9ca3af; /* Cor cinza para ícones */
            margin-right: 8px;
            flex-shrink: 0; /* Impedir que o ícone encolha */
        }
        .login-input-group input {
            flex-grow: 1; /* Input ocupa o espaço restante */
            padding: 0; /* Sem preenchimento para o próprio input, tratado pelo pai */
            border: none; /* Sem borda individual para o input */
            outline: none; /* Remover contorno no foco */
            background-color: transparent; /* Fundo transparente, permitindo o branco do pai */
            font-size: 1rem;
            color: #333;
        }
        .login-input-group input::placeholder {
            color: #9ca3af;
        }

        /* Campo de descrição não editável */
        #productDescriptionDisplayHK, #mappedProductCodeDisplayHK, #productValueHK, #totalM3DisplayHK, #productDescriptionDisplayCOL, #productStockCOL, #valorUnitCOLDisplay, #productCodeCOLDisplay {
            padding: 10px 12px; /* Preenchimento ajustado para combinar com a altura do input */
            border: 1px solid #d1d5db; /* Borda cinza clara */
            border-radius: 8px;
            background-color: #f9fafb; /* Fundo ligeiramente diferente para distinção visual */
            color: #4b5563; /* Texto cinza mais escuro */
            font-size: 1rem;
            min-height: 42px; /* Garantir que corresponda à altura de outros inputs */
            display: flex;
            align-items: center;
        }
        /* Specific style for editable input in purchasing order details */
        #purchasingOrderDetailsScreen input[type="number"] {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            width: 120px; /* Adjust width as needed */
            text-align: right;
        }


        .btn {
            padding: 10px 20px;
            border-radius: 4px; /* Cantos menos arredondados para botões, combinando com a imagem */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .btn-primary {
            background-color: #3b82f6; /* Azul */
            color: #ffffff;
            border: none;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Azul mais escuro no hover */
        }
        .btn-secondary {
            background-color: #f3f4f6; /* Cinza claro */
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb; /* Cinza claro mais escuro no hover */
        }
        .product-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            background-color: #f9fafb;
        }
        .message-box {
            background-color: #dbeafe; /* Azul claro */
            border: 1px solid #93c5fd; /* Azul médio */
            color: #1e40af; /* Azul escuro */
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        .error-message {
            background-color: #fee2e2; /* Vermelho claro */
            border: 1px solid #ef4444; /* Vermelho */
            color: #b91c1c; /* Vermelho escuro */
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: 500;
        }
        /* Estilo para feedback de MOQ ao vivo */
        .moq-feedback-ok {
            color: #16a34a; /* Verde */
            font-size: 0.875rem;
            margin-top: 4px;
        }
        .moq-feedback-error {
            color: #dc2626; /* Vermelho */
            font-size: 0.875rem;
            margin-top: 4px;
        }
        /* Estilo da tabela */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .data-table th, .data-table td {
            padding: 12px 16px; /* Preenchimento aumentado para melhor legibilidade */
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase; /* Combinar com a tabela da central de tarefas */
            font-size: 0.85rem; /* Ligeiramente menor para cabeçalhos de tabela */
            white-space: nowrap; /* Impede quebra de linha em cabeçalhos */
        }
        .data-table td {
             white-space: nowrap; /* Impede quebra de linha em células de dados por padrão */
        }
        .data-table tbody tr:last-child td {
            border-bottom: none; /* Remover a borda inferior para a última linha */
        }
        .data-table tbody tr:hover {
            background-color: #f3f4f6; /* Efeito de hover para linhas da tabela */
        }

        /* Garantir que .hidden esconda elementos definitivamente */
        .hidden {
            display: none !important;
        }
        /* Layout Específico da Tela de Login e Estilo do Cartão - Corresponde a image_1e26c4.png */
        #loginScreen {
            width: 100%;
            height: 100vh; /* Ocupa a altura total da viewport para centralização */
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f3f4f6; /* Fundo cinza */
        }
        .login-card {
            background-color: #ffffff; /* Fundo branco para o cartão */
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 320px; /* Largura mais estreita para o cartão */
            width: 100%;
            text-align: center;
        }
        .login-logo {
            margin-bottom: 25px; /* Espaço abaixo do logo */
            text-align: center;
        }
        .login-logo img {
            max-width: 120px;
            display: inline-block;
            margin: 0 auto;
        }
        .forgot-password-link {
            font-size: 0.85rem;
            color: #3b82f6;
            margin-top: 15px;
            display: block;
            text-decoration: none;
            text-align: center;
        }
        .forgot-password-link:hover {
            text-decoration: underline;
        }

        /* Removendo o cabeçalho padrão do .container para a tela de login */
        #loginScreen .header {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        /* Estilo para input de quantidade dentro da tabela de produtos */
        .product-quantity-input {
            width: 80px; /* Largura fixa para input de quantidade */
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
        }
        .add-to-cart-btn {
            background-color: #22c55e; /* Botão verde */
            color: #ffffff;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .add-to-cart-btn:hover {
            background-color: #16a34a; /* Verde mais escuro no hover */
        }

        /* Estilos para a Tela da Central de Pedidos (baseado na Central de Tarefas) */
        #orderCenterScreen, #hongKongSummaryScreen, #renatoApprovalScreen,
        #hongKongFormScreen, #colombiaFormScreen, #orderDetailsScreen,
        #purchaseOrderScreen, #hongKongFinalScreen, #colombiaInvoiceScreen,
        #purchasingCenterScreen, #purchasingOrderDetailsScreen { /* Added new purchasing screens */
            display: flex;
            flex-direction: column;
            width: 100%;
            /* Removed min-height: 100vh; to allow natural height and scrolling */
            box-shadow: none; /* Remove shadow if applied by .container */
            padding: 0; /* Remove padding if applied by .container */
            margin: 0; /* Remove margin if applied by .container */
            background-color: #f3f4f6; /* Define the body background, not the container's */
            overflow: auto; /* Allows internal scrolling if content exceeds screen height */
        }

        #orderCenterScreen .header, #purchasingCenterScreen .header { /* Usar o estilo de cabeçalho geral */
            padding-top: 20px;
            margin-bottom: 16px;
        }
        #orderCenterScreen .btn-primary, #purchasingCenterScreen .btn-primary {
            padding: 8px 16px;
            border-radius: 8px;
        }
        #orders-table-container, #purchasing-tables-container { /* Aplicar estilo semelhante à tela de resumo */
            flex-grow: 1; /* Permite que a tabela ocupe o espaço restante */
            overflow-x: auto; /* Adiciona scroll horizontal apenas à tabela se necessário */
        }
        #orderCenterTable, #negotiationTable, #renatoActionsTable, #negotiationInProgressTable, #aprovadoGerenciaTable {
            width: 100%; /* Garante que a tabela use toda a largura disponível */
            min-width: 1100px; /* Define uma largura mínima para evitar encolhimento excessivo */
        }
        #orderCenterTable .status-indicator, #negotiationTable .status-indicator, #renatoActionsTable .status-indicator, #negotiationInProgressTable .status-indicator, #aprovadoGerenciaTable .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        /* Nova categorização de cores para os status atualizados */
        #orderCenterTable .status-indicator.green, #negotiationTable .status-indicator.green, #renatoActionsTable .status-indicator.green, #negotiationInProgressTable .status-indicator.green, #aprovadoGerenciaTable .status-indicator.green { background-color: #22c55e; } /* Aprovado, Carga Pronta, Entregue, Carga Entregue, Documentação OK, Chegada no Porto */
        #orderCenterTable .status-indicator.red, #negotiationTable .status-indicator.red, #renatoActionsTable .status-indicator.red, #negotiationInProgressTable .status-indicator.red, #aprovadoGerenciaTable .status-indicator.red { background-color: #ef4444; } /* Rejeitado */
        #orderCenterTable .status-indicator.yellow, #negotiationTable .status-indicator.yellow, #renatoActionsTable .status-indicator.yellow, #negotiationInProgressTable .status-indicator.yellow, #aprovadoGerenciaTable .status-indicator.yellow { background-color: #eab308; } /* Pendente, Aguardando Aprovação, Em Negociação, Documentação Pendente */
        #orderCenterTable .status-indicator.blue, #negotiationTable .status-indicator.blue, #renatoActionsTable .status-indicator.blue, #negotiationInProgressTable .status-indicator.blue, #aprovadoGerenciaTable .status-indicator.blue { background-color: #3b82f6; } /* Em Processamento (genérico), Em Separação, Em Conferência, Em Rota de Entrega, Em Produção, Saída do Porto */
        #orderCenterTable .status-indicator.gray, #negotiationTable .status-indicator.gray, #renatoActionsTable .status-indicator.gray, #negotiationInProgressTable .status-indicator.gray, #aprovadoGerenciaTable .status-indicator.gray { background-color: #6b7280; } /* Cancelado */
        #orderCenterTable .status-indicator.purple, #negotiationTable .status-indicator.purple, #renatoActionsTable .status-indicator.purple, #negotiationInProgressTable .status-indicator.purple, #aprovadoGerenciaTable .status-indicator.purple { background-color: #8b5cf6; } /* Negociado (new status) */


        #orderCenterTable tbody tr:hover, #negotiationTable tbody tr:hover, #renatoActionsTable tbody tr:hover, #negotiationInProgressTable tbody tr:hover, #aprovadoGerenciaTable tbody tr:hover {
            background-color: #f3f4f6; /* Cinza claro mais escuro no hover para todas as linhas */
        }
        /* Estilo para número de pedido clicável */
        #orderCenterTable tbody tr td a.order-link, #negotiationTable tbody tr td a.order-link, #renatoActionsTable tbody tr td a.order-link, #negotiationInProgressTable tbody tr td a.order-link, #aprovadoGerenciaTable tbody tr td a.order-link {
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
        }
        #orderCenterTable tbody tr td a.order-link:hover, #negotiationTable tbody tr td a.order-link:hover, #renatoActionsTable tbody tr td a.order-link:hover, #negotiationInProgressTable tbody tr td a.order-link:hover, #aprovadoGerenciaTable tbody tr td a.order-link:hover {
            color: #2563eb;
        }
        /* Estilo da imagem da bandeira */
        .flag-icon {
            width: 20px; /* Adjusted size for icon */
            height: auto;
            border-radius: 2px; /* Cantos ligeiramente arredondados para bandeiras */
            vertical-align: middle; /* Alinhar com o texto */
            margin-right: 8px; /* Adicionado margem direita para separar do texto ou de outros elementos */
            box-shadow: 0 0 2px rgba(0,0,0,0.2); /* Sombra sutil para bandeiras */
        }

        /* Tela de Detalhes do Pedido */
        #orderDetailsScreen .detail-item, #purchasingOrderDetailsScreen .detail-item {
            padding: 10px 0;
            border-bottom: 1px dashed #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #orderDetailsScreen .detail-item:last-child, #purchasingOrderDetailsScreen .detail-item:last-child {
            border-bottom: none;
        }
        #orderDetailsScreen .detail-item strong, #purchasingOrderDetailsScreen .detail-item strong {
            color: #4b5563;
        }
        #orderDetailsScreen .detail-item span, #purchasingOrderDetailsScreen .detail-item span {
            color: #1f2937;
        }
        #orderDetailsScreen .product-details-table, #purchasingOrderDetailsScreen .product-details-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        #orderDetailsScreen .product-details-table th,
        #orderDetailsScreen .product-details-table td,
        #purchasingOrderDetailsScreen .product-details-table th,
        #purchasingOrderDetailsScreen .product-details-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            text-align: left;
        }
        #orderDetailsScreen .product-details-table th,
        #purchasingOrderDetailsScreen .product-details-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        #orderDetailsScreen .product-details-table tr:nth-child(even),
        #purchasingOrderDetailsScreen .product-details-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        /* Estilos para o Tracking do Pedido */
        .tracking-steps {
            display: flex;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            justify-content: space-between;
            margin-top: 20px;
            padding: 20px 0;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }

        .tracking-step {
            flex: 1; /* Distribui o espaço igualmente */
            min-width: 120px; /* Largura mínima para cada etapa */
            text-align: center;
            position: relative;
            padding-top: 30px; /* Espaço para o círculo e linha */
            color: #9ca3af; /* Cor padrão para inativo/futuro */
            font-size: 0.875rem;
            font-weight: 500;
        }
        .tracking-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            left: calc(50% + 15px); /* Inicia após o círculo */
            width: calc(100% - 30px); /* Largura da linha entre os círculos */
            height: 2px;
            background-color: #e5e7eb; /* Cor da linha para status futuros */
            z-index: 0;
        }
        .tracking-step .circle {
            width: 30px;
            height: 30px;
            background-color: #e5e7eb; /* Cor padrão para inativo/futuro */
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: bold;
            z-index: 1; /* Para ficar acima da linha */
        }

        /* Estilos para o status atual e anteriores */
        .tracking-step.completed {
            color: #1f2937; /* Texto escuro para concluído */
        }
        .tracking-step.completed .circle {
            background-color: #22c55e; /* Verde para concluído */
        }
        .tracking-step.completed:not(:last-child)::after {
            background-color: #22c55e; /* Linha verde para concluído */
        }
        .tracking-step.active {
            color: #3b82f6; /* Azul para ativo */
            font-weight: 600;
        }
        .tracking-step.active .circle {
            background-color: #3b82f6; /* Azul para ativo */
            border: 2px solid #2563eb; /* Borda mais escura para destaque */
            transform: translateX(-50%) scale(1.1); /* Um pouco maior */
        }
        /* Estilos para Rejeitado/Cancelado quando são o status ATUAL */
        .tracking-step.rejected.active, .tracking-step.cancelled.active {
            color: #dc2626; /* Vermelho para rejeitado/cancelado */
            font-weight: 600;
        }
        .tracking-step.rejected.active .circle, .tracking-step.cancelled.active .circle {
            background-color: #dc2626; /* Vermelho para rejeitado/cancelado */
            border: 2px solid #b91c1c;
        }

        /* Cores específicas para os círculos quando ATIVOS ou COMPLETED */
        /* Hong Kong Specific */
        .tracking-step.negotiation.active .circle,
        .tracking-step.negotiation.completed .circle {
            background-color: #eab308; /* Amarelo para Em Negociação */
            border-color: #b45309;
        }
        .tracking-step.waiting-approval.active .circle,
        .tracking-step.waiting-approval.completed .circle {
            background-color: #f97316; /* Laranja para Aguardando Aprovação */
            border-color: #c2410c;
        }
        .tracking-step.approved.active .circle,
        .tracking-step.approved.completed .circle { /* Aprovado pode ser completo ou ativo */
            background-color: #22c55e; /* Verde */
            border-color: #16a34a;
        }
        .tracking-step.production.active .circle,
        .tracking-step.production.completed .circle {
            background-color: #3b82f6; /* Azul padrão para Em Produção */
            border-color: #2563eb;
        }
        .tracking-step.ready-cargo.active .circle,
        .tracking-step.ready-cargo.completed .circle {
            background-color: #06b6d4; /* Ciano para Carga Pronta */
            border-color: #0891b2;
        }
        .tracking-step.atd.active .circle,
        .tracking-step.atd.completed .circle {
            background-color: #8b5cf6; /* Roxo para Saída do Porto de Embarque (ATD) */
            border-color: #7c3aed;
        }
        .tracking-step.pending-doc.active .circle,
        .tracking-step.pending-doc.completed .circle {
            background-color: #fbbf24; /* Amarelo-laranja para Documentação Pendente */
            border-color: #d97706;
        }
        .tracking-step.doc-ok.active .circle,
        .tracking-step.doc-ok.completed .circle {
            background-color: #22c55e; /* Verde para Documentação OK */
            border-color: #16a34a;
        }
        .tracking-step.ata.active .circle,
        .tracking-step.ata.completed .circle {
            background-color: #22c55e; /* Verde para Chegada no Porto de Destino (ATA) */
            border-color: #16a34a;
        }
        .tracking-step.delivered.active .circle,
        .tracking-step.delivered.completed .circle {
            background-color: #22c55e; /* Verde para Carga Entregue / Entregue */
            border-color: #16a34a;
        }
        /* Colombia Specific (ERP-like) */
        .tracking-step.separation.active .circle,
        .tracking-step.separation.completed .circle {
            background-color: #a78bfa; /* Light purple for Em Separação */
            border-color: #9333ea;
        }
        .tracking-step.conference.active .circle,
        .tracking-step.conference.completed .circle {
            background-color: #6d28d9; /* Darker purple for Em Conferência */
            border-color: #5b21b6;
        }
        
        /* Estilos específicos do modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 24px; /* Ajuste aqui também para modais */
            max-width: 400px; /* Ajustado para o tamanho do pop-up, para seguir o container */
            width: 90%; /* Largura responsiva */
            text-align: center;
        }
        /* Corrigido: Modal de Seleção de Filial deve ser mais compacto */
        #filialSelectionModal .modal-content {
            max-width: 400px; /* Mantém a largura compacta como os outros modais */
        }


        /* Estilos específicos para o modal do catálogo de produtos */
        #productCatalogModal .modal-content {
            max-width: 700px;
            text-align: left;
        }
        #productCatalogSearchInput {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            width: 100%;
            margin-bottom: 16px;
        }
        #productCatalogList {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 10px;
            background-color: #fff;
        }
        /* Estilo da tabela do catálogo de produtos */
        #productCatalogList .data-table th,
        #productCatalogList .data-table td {
            padding: 10px 12px;
        }
        #productCatalogList .data-table tbody tr {
            cursor: pointer;
        }
        #productCatalogList .data-table tbody tr:hover {
            background-color: #f3f4f6;
        }
        #productCatalogList .data-table .product-code-display {
            font-weight: 600;
            color: #1f2937;
        }
        #productCatalogList .data-table .product-description-display {
            color: #374151;
        }
        #productCatalogList .data-table .product-line-display {
            color: #6b7280;
            font-size: 0.85rem;
        }

        .input-with-icon {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-with-icon input {
            padding-right: 40px; /* Espaço para o ícone */
        }
        .input-with-icon .search-icon {
            position: absolute;
            right: 12px;
            cursor: pointer;
            stroke: #6b7280; /* Explicitly setting the stroke color */
            width: 1.25rem; /* Equivalent to w-5 */
            height: 1.25rem; /* Equivalent to h-5 */
        }
        .add-product-message {
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.875rem;
            text-align: center;
        }
        .add-product-message.success {
            background-color: #d1fae5; /* Verde claro */
            color: #065f46; /* Verde escuro */
        }
        .add-product-message.error {
            background-color: #fee2e2; /* Vermelho claro */
            border: 1px solid #ef4444; /* Vermelho */
            color: #b91c1c; /* Vermelho escuro */
        }
        .add-product-message.info {
            background-color: #e0f2fe; /* Azul claro */
            color: #0c4a6e; /* Azul escorao */
        }

        /* Estilos para a Tela de Resumo para combinar com a Central de Pedidos */
        #hongKongSummaryScreen .header {
            padding-top: 20px;
            margin-bottom: 16px;
        }
        /* Estilos específicos para a tela de Aprovação do Renato */
        #renatoApprovalScreen .content-area, #purchasingCenterScreen .content-area {
            background-color: #ffffff; /* Fundo branco para o conteúdo principal */
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 32px;
            text-align: left; /* Alinhar texto à esquerda */
            max-width: 2400px; /* Define largura máxima para a área de conteúdo, conforme solicitado */
            width: 100%;
            margin: 0 auto; /* Centraliza a área de conteúdo */
        }

        #renatoApprovalScreen .supplier-summary-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative; /* Para o indicador de status */
        }

        .price-difference-positive {
            color: #dc2626; /* Vermelho para aumento de custo */
            font-weight: 700;
        }

        .price-difference-negative {
            color: #16a34a; /* Verde para economia */
            font-weight: 700;
        }

        .supplier-status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        /* Estilos para a tela de carregamento da análise */
        #analysisLoadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9); /* Fundo escuro para destacar */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Acima de outros modais */
            color: #ffffff;
            text-align: center;
        }
        #analysisLoadingScreen .spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #3b82f6; /* Cor azul do tema */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #analysisLoadingScreen .message {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        #analysisLoadingScreen .sub-message {
            font-size: 1rem;
            color: #d1d5db;
        }

        /* Estilos para as abas */
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-weight: 600;
            color: #6b7280;
            position: relative;
            bottom: -1px; /* Para sobrepor a borda inferior */
        }
        .tab-button.active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }
        .tab-content {
            padding-top: 20px;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        .collapsible-header:hover {
            color: #1f2937;
        }
        .collapsible-content {
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 10px;
        }
        .collapsible-content:last-child {
            border-bottom: none;
        }
        .collapsible-icon {
            transition: transform 0.3s ease;
        }
        .collapsible-header.open .collapsible-icon {
            transform: rotate(180deg);
        }

        /* Estilos para os botões de aprovação/negociação/rejeição */
        .approval-buttons-group {
            display: flex; /* Use flexbox for horizontal layout */
            flex-direction: row; /* Arrange items in a row */
            gap: 4px; /* Space between buttons */
            justify-content: flex-start; /* Alinha os botões ao início (esquerda) */
            flex-wrap: nowrap; /* Impede quebra de linha por padrão, força o mesmo tamanho */
        }
        .approval-buttons-group .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem; /* Menor para caber na tabela */
            border-radius: 4px;
            flex: 1; /* Make buttons take equal width */
            max-width: 80px; /* Define uma largura máxima para cada botão */
            text-align: center;
        }
        .approval-buttons-group .btn-approve {
            background-color: #22c55e; /* Verde */
            color: white;
        }
        .approval-buttons-group .btn-approve.selected {
            outline: 2px solid #16a34a; /* Borda mais escura para selecionado */
            outline-offset: 1px;
        }
        .approval-buttons-group .btn-negotiate {
            background-color: #eab308; /* Amarelo */
            color: white;
        }
        .approval-buttons-group .btn-negotiate.selected {
            outline: 2px solid #b45309;
            outline-offset: 1px;
        }
        .approval-buttons-group .btn-reject {
            background-color: #ef4444; /* Vermelho */
            color: white;
        }
        .approval-buttons-group .btn-reject.selected {
            outline: 2px solid #be123c;
            outline-offset: 1px;
        }
        /* Status display for each product in Renato's screen */
        .product-approval-status {
            font-weight: 600;
        }
        .product-approval-status.Pendente {
            color: #6b7280; /* Cinza */
        }
        .product-approval-status.Aprovado {
            color: #16a34a; /* Verde */
        }
        .product-approval-status.Negociar {
            color: #d97706; /* Laranja */
        }
        .product-approval-status.Rejeitado {
            color: #dc2626; /* Vermelho */
        }
        /* Estilo específico para a tabela de produtos adicionados (Hong Kong/Colômbia) */
        #productListHK .data-table,
        #productListCOL .data-table {
            min-width: 950px; /* Largura mínima para evitar quebra de linha */
        }
    </style>
</head>
<body>
    <div id="app" class="w-full"> <!-- Removed min-h-screen here as body now handles it -->
        
                 <div class="flex justify-end mt-8">
    <button onclick="showScreenInfo()" title="Informações da Tela"
        class="text-blue-600 hover:text-blue-800 flex items-center gap-2"
        style="background: none; border: none; padding: 0;">
        <svg xmlns="http://www.w3.org/2000/svg" class="inline-block align-middle" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="#3b82f6" stroke-width="2">
            <circle cx="12" cy="12" r="10" stroke="#3b82f6" stroke-width="2" fill="#e0f2fe"/>
            <line x1="12" y1="8" x2="12" y2="12" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
            <circle cx="12" cy="16" r="1" fill="#3b82f6"/>
        </svg>
    </button>
</div>
        <!-- Tela de Login -->
        <div id="loginScreen" class="screen">
            <div class="login-card"> <!-- Removido a classe 'container' daqui para usar o estilo mais específico do .login-card -->
                <div class="login-logo">
                    <!--  -->
                    <img src="https://placehold.co/120x40/FFFFFF/000000?text=TOTVS+FLUIG" alt="Logo TOTVS Fluig">
                </div>
                <div class="space-y-4">
                    <div class="login-input-group">
                        <!-- Ícone de Usuário -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-svg"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <input type="text" id="username" placeholder="Usuário">
                    </div>
                    <div class="login-input-group">
                        <!-- Ícone de Cadeado -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-svg"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 0 0 1 10 0v4"/></svg>
                        <input type="password" id="password" placeholder="Senha">
                    </div>
                    <button id="loginButton" class="btn btn-primary w-full mt-6">ACESSAR</button>
                </div>
                <a href="#" onclick="showMessage('Funcionalidade: Esqueceu sua senha?', 'Esta é uma funcionalidade simulada.')" class="forgot-password-link">Esqueceu sua senha?</a>
            </div>
        </div>

        <!-- Central de Pedidos -->
        <div id="orderCenterScreen" class="screen hidden">
            <div class="app-content-wrapper"> <!-- Usando o novo wrapper para conteúdo principal -->
                <div class="header flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Central de Pedidos</h1>
                    <button class="btn-primary" onclick="openFilialSelectionModal()">
                        Nova Solicitação
                    </button>
                </div>
        

                <!-- Seção de Filtro -->
                <div class="flex flex-wrap items-end gap-3 mb-4"> <!-- Use flex-wrap for responsiveness -->
                    <div class="flex-1 min-w-[150px]">
                        <label for="statusFilter" class="block text-sm font-medium text-gray-700">Status:</label>
                        <select id="statusFilter" class="rounded-lg p-2 border border-gray-300 w-full" onchange="renderOrdersTable()">
                            <option value="">Todos</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Em Negociação">Em Negociação</option>
                            <option value="Aguardando Aprovação">Aguardando Aprovação</option>
                            <option value="Rejeitado">Rejeitado</option>
                            <option value="Cancelado">Cancelado</option>
                            <option value="Aprovado">Aprovado</option>
                            <option value="Em Produção">Em Produção</option>
                            <option value="Carga Pronta">Carga Pronta</option>
                            <option value="Saída do Porto de Embarque (ATD)">Saída do Porto de Embarque (ATD)</option>
                            <option value="Documentação Pendente">Documentação Pendente</option>
                            <option value="Documentação OK">Documentação OK</option>
                            <option value="Chegada no Porto de Destino (ATA)">Chegada no Porto de Destino (ATA)</option>
                            <!-- Adicionar opções para novos status Colômbia (já existem) -->
                            <option value="Em Separação">Em Separação</option>
                            <option value="Em Conferência">Em Conferência</option>
                            <option value="Em Rota de Entrega">Em Rota de Entrega</option>
                            <option value="Entregue">Entregue</option>
                            <option value="Negociado">Negociado</option> <!-- New status for Compras -->
                            <option value="Finalizado">Finalizado</option> <!-- New status for Compras -->
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label for="supplierFilter" class="block text-sm font-medium text-gray-700">Fornecedor:</label>
                        <select id="supplierFilter" class="rounded-lg p-2 border border-gray-300 w-full" onchange="renderOrdersTable()">
                            <option value="">Todos</option>
                            <!-- Fornecedores serão carregados dinamicamente aqui por JS -->
                        </select>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label for="originCountryFilter" class="block text-sm font-medium text-gray-700">País Origem:</label>
                        <select id="originCountryFilter" class="rounded-lg p-2 border border-gray-300 w-full" onchange="renderOrdersTable()">
                            <option value="">Todos</option>
                            <!-- Países serão carregados dinamicamente aqui por JS -->
                        </select>
                    </div>
                    <div class="relative flex items-center flex-1 min-w-[200px] mt-6 sm:mt-0"> <!-- Adjust margin for alignment on small screens -->
                        <label for="orderSearch" class="sr-only">Buscar por Nº Pedido ou Cliente</label>
                        <input type="text" id="orderSearch" placeholder="Buscar por Nº Pedido ou Cliente"
                               class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               oninput="renderOrdersTable()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                        </svg>
                    </div>
                </div>

                <!-- Contêiner da Tabela de Pedidos -->
                <div id="orders-table-container" class="overflow-x-auto"> <!-- Adicionado overflow-x aqui -->
                    <table id="orderCenterTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Id Solicitação Principal</th> <!-- Título atualizado para clareza -->
                                <th>Nº Pedido</th> 
                                <th>Origem</th>
                                <th>País Origem</th>
                                <th>Fornecedor</th> 
                                <th>Valor Total</th>
                                <th>Status do Pedido</th>
                                <th>Data Solicitação/Criação</th>
                                <th>Data Última Alteração</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Pedidos serão carregados dinamicamente aqui por JS -->
                        </tbody>
                    </table>
                </div>
                <button onclick="logout()" class="btn btn-secondary w-full mt-6">Sair (Logout)</button>
            </div>
        </div>
        <!-- Tela de Detalhes do Pedido -->
        <div id="orderDetailsScreen" class="screen hidden app-content-wrapper"> <!-- Ajustado para app-content-wrapper -->
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Detalhes do Pedido <span id="currentOrderId"></span></h1>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
                <h3 class="font-semibold text-lg mb-4">Informações Gerais</h3>
                <div class="space-y-2">
                    <div class="detail-item">
                        <strong>Nº Pedido:</strong> <span id="detailOrderId"></span>
                    </div>
                    <div class="detail-item">
                        <strong>ID Principal:</strong> <span id="detailParentOrderId"></span> <!-- Renomeado -->
                    </div>
                    <div class="detail-item">
                        <strong>Origem:</strong> <span id="detailOriginDisplay"></span> <!-- Campo de origem atualizado -->
                    </div>
                    <div class="detail-item">
                        <strong>Fornecedor:</strong> <span id="detailSupplier"></span> <!-- Novo campo Fornecedor -->
                    </div>
                    <div class="detail-item">
                        <strong>Valor Total:</strong> <span id="detailTotalValue"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Status do Pedido:</strong> <span id="detailStatus"></span> <!-- Ainda exibe o status direto -->
                    </div>
                    <div class="detail-item">
                        <strong>Data Solicitação/Criação:</strong> <span id="detailRequestDate"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Data Última Alteração:</strong> <span id="detailLastUpdateDate"></span>
                    </div>
                </div>

                <h3 class="font-semibold text-lg mt-6 mb-4">Status de Rastreamento</h3>
                <div id="orderTrackingSection">
                    <!-- Tracking steps will be rendered here dynamically -->
                </div>

                <h3 class="font-semibold text-lg mt-6 mb-4">Produtos do Pedido</h3>
                <div class="table-container border border-gray-200 rounded-lg overflow-hidden">
                    <table class="product-details-table">
                        <thead>
                            <tr>
                                <th>Código Produto</th>
                                <th>Descrição</th>
                                <th>Quantidade</th>
                                <th>Valor Unitário</th>
                                <th>Valor Total Item</th>
                            </tr>
                        </thead>
                        <tbody id="orderDetailsProductsTableBody">
                            <!-- Detalhes do produto serão carregados dinamicamente aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
            <button onclick="backToOrderCenter()" class="btn btn-secondary w-full mt-6">Voltar para Central de Pedidos</button>
        </div>


        <!-- Modal de Seleção de Filial -->
        <div id="filialSelectionModal" class="modal-overlay hidden">
            <div class="modal-content"> <!-- Corrigido: Removida a classe 'container' e ajustado max-width para o estilo do modal -->
                <div class="header">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Escolha a Filial</h1>
                    <p class="text-gray-600">Para qual filial você deseja enviar a solicitação?</p>
                </div>
                <div class="flex flex-col md:flex-row gap-6 justify-center">
                    <button onclick="selectFilial('colombia')" class="btn btn-primary md:w-1/2">Colômbia</button>
                    <button onclick="selectFilial('hongkong')" class="btn btn-primary md:w-1/2">Hong Kong</button>
                </div>
                <button onclick="closeFilialSelectionModal()" class="btn btn-secondary w-full mt-6">Voltar</button>
            </div>
        </div>

        <!-- Hong Kong Flow Screens -->
        <div id="hongKongFormScreen" class="screen hidden">
            <div class="app-content-wrapper"> <!-- Usando o novo wrapper para conteúdo principal -->
                <div class="header">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Solicitação de Compra - Hong Kong</h1>
                    <p class="text-gray-600">Por favor, preencha os detalhes dos produtos desejados.</p>
                </div>

                <!-- Campo opcional: Número do Pedido do Cliente -->
                <div class="mb-4">
                    <label for="clientOrderNumberHK" class="block text-sm font-medium text-gray-700">Número do Pedido (Opcional):</label>
                    <input type="text" id="clientOrderNumberHK" placeholder="Seu número de referência do pedido"
                        class="rounded-lg p-2 border border-gray-300 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="tab-buttons" id="hkTabButtons">
                    <!-- Pedido Fácil vem primeiro agora -->
                    <button class="tab-button active" onclick="switchTab('hongkong', 'easy')">Pedido Fácil</button>
                    <button class="tab-button" onclick="switchTab('hongkong', 'manual')">Pedido Manual</button>
                </div>

                <!-- Pedido Fácil Tab Content (agora vem antes) -->
                <div id="hongKongEasyOrderTab" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedido Fácil</h2>
                    <p class="text-gray-600 mb-6">Escolha uma das opções abaixo para adicionar os produtos ao carrinho de compras</p>

                    <!-- Upload de Planilha -->
                    <div class="border p-4 rounded-lg bg-gray-50 mb-6">
                        <div class="collapsible-header" onclick="toggleCollapsible(this, 'uploadSheetContentHK')">
                            <h3 class="font-semibold text-gray-700">Upload de Planilha</h3>
                            <svg class="collapsible-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="uploadSheetContentHK" class="collapsible-content hidden">
                            <p class="mb-4 text-gray-600">Selecione o arquivo no seu computador para fazer o upload.</p>
                            <div class="flex items-center gap-4 mb-4">
                                <input type="file" id="fileUploadHK" accept=".csv" class="hidden" onchange="displayFileName('fileUploadHK', 'fileNameDisplayHK')">
                                <button onclick="document.getElementById('fileUploadHK').click()" class="btn btn-secondary">Selecionar arquivo</button>
                                <span id="fileNameDisplayHK" class="text-gray-600 italic">Nenhum arquivo selecionado</span>
                            </div>
                            <p class="text-sm text-gray-500 mb-4">O tamanho do arquivo não deve ultrapassar 5MB. Formato aceito: .csv</p>
                            <button onclick="handleFileUpload('hongkong')" class="btn btn-primary w-full">Fazer Upload</button>
                        </div>
                    </div>

                    <!-- Copiar e Colar Códigos -->
                    <div class="border p-4 rounded-lg bg-gray-50 mb-6">
                        <div class="collapsible-header" onclick="toggleCollapsible(this, 'copyPasteContentHK')">
                            <h3 class="font-semibold text-gray-700">Copiar e Colar Códigos</h3>
                            <svg class="collapsible-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="copyPasteContentHK" class="collapsible-content hidden">
                            <p class="mb-4 text-gray-600">Cole os códigos de produto e quantidades (um por linha, ex: `CODIGO_CLIENTE,CODIGO_PRODUTO,QUANTIDADE` ou `CODIGO_UNICO,QUANTIDADE`):</p>
                            <textarea id="pasteCodesHK" rows="5" class="w-full p-2 border rounded-lg mb-4"></textarea>
                            <button onclick="processPastedCodes('hongkong')" class="btn btn-primary w-full">Adicionar Códigos</button>
                        </div>
                    </div>

                    <!-- Saiba como utilizar nosso modelo de planilha -->
                    <div class="mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Saiba como utilizar nosso modelo de planilha</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/FFF/000?text=Código+Comercial" alt="Código comercial" class="mx-auto mb-4"/>
                                <p class="font-semibold text-lg mb-2">Passo 1</p>
                                <p class="text-gray-600">Faça o download do modelo de planilha. Abra a planilha no seu computador e preencha com o código do produto do cliente e o código do produto (opcional) e a quantidade desejada. Máximo de 50 linhas de produtos por pedido.</p>
                                <button onclick="downloadSpreadsheetModel()" class="text-blue-600 hover:underline mt-2 inline-block">Modelo de Planilha</button>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/FFF/000?text=+5MB" alt="+5MB" class="mx-auto mb-4"/>
                                <p class="font-semibold text-lg mb-2">Passo 2</p>
                                <p class="text-gray-600">Com sua planilha pronta e salva no seu computador, clique em Selecionar arquivo. Em seguida, clique em Fazer upload. O tamanho da planilha não deve ultrapassar 5MB de tamanho.</p>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/FFF/000?text=Carrinho+de+compras+com+o+número+50" alt="Carrinho de compras com o número 50" class="mx-auto mb-4"/>
                                <p class="font-semibold text-lg mb-2">Passo 3</p>
                                <p class="text-gray-600">Com sua planilha pronta e salva no seu computador, clique em Selecionar arquivo. Em seguida, clique em Fazer upload. O tamanho da planilha não deve ultrapassar 5MB de tamanho.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pedido Manual Tab Content (agora vem depois do Pedido Fácil) -->
                <div id="hongKongManualOrderTab" class="tab-content hidden">
                    <!-- Seção para adicionar um novo produto, imitando a linha única da imagem -->
                    <div class="mb-6 border p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-gray-700 mb-4">Adicionar Produtos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div class="col-span-1">
                                <label for="clientProductCodeHK" class="block text-sm font-medium text-gray-700">Cód Prod Cliente:</label>
                                <div class="input-with-icon">
                                <input type="text" id="clientProductCodeHK" placeholder="Cód Cliente"
                                    oninput="updateProductDetailsOnClientCodeChangeHK(); updateTotalValueHK();"
                                    class="rounded-lg p-2 border border-gray-300 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">

                                    <svg onclick="openProductCatalogModal('hongkong')" class="search-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#6b7280">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label for="mappedProductCodeDisplayHK" class="block text-sm font-medium text-gray-700">Cód Produto:</label>
                                <div id="mappedProductCodeDisplayHK" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    --
                                </div>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <label for="productDescriptionDisplayHK" class="block text-sm font-medium text-gray-700">Descrição:</label>
                                <div id="productDescriptionDisplayHK" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    --
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label for="productQuantityHK" class="block text-sm font-medium text-gray-700">Qtd.:</label>
                                <input type="number" id="productQuantityHK" min="1" value="1"
                                    oninput="checkMoqLiveHK(); calculateTotalM3HK(); updateTotalValueHK();"
                                    class="rounded-lg p-2 border border-gray-300 w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
<div class="col-span-1">
    <label for="productValueHK" class="block text-sm font-medium text-gray-700">Valor Unit.:</label>
    <div id="productValueHK" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
        R$ 0,00
    </div>
</div>
<div class="col-span-1">
    <label for="valorTotalHKDisplay" class="block text-sm font-medium text-gray-700">Valor Total:</label>
    <div id="valorTotalHKDisplay" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
        R$ 0,00
    </div>
</div>
<div class="col-span-1">
    <label for="totalM3DisplayHK" class="block text-sm font-medium text-gray-700">M³ Total:</label>
    <div id="totalM3DisplayHK" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
        0.00 m³
    </div>
</div>
                            <div class="col-span-full flex justify-end">
                                <button onclick="addProductHK()" class="btn btn-secondary">Adicionar Produto</button>
                            </div>
                        </div>
                        <div id="addProductMessageHK" class="add-product-message hidden"></div>
                    </div>
                    <div id="moqLiveFeedbackHK" class="text-xs mt-1"></div> <!-- Feedback de MOQ abaixo da lista de produtos -->
                </div>
                
                <!-- Produtos Adicionados na Solicitação (fora das abas, para ser comum) -->
                <div id="productListHK" class="mt-4 border p-4 rounded-lg bg-gray-50 max-h-80 overflow-y-auto">
                    <h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados na Solicitação:</h3>
                    <div id="noProductsAddedHK" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>
                    <!-- Produtos serão listados aqui em uma tabela -->
                </div>

                <div class="flex flex-col md:flex-row gap-4 mt-6">
                    <button onclick="backToFilialSelectionFromForm()" class="btn btn-secondary flex-1">Voltar</button>
                    <button onclick="submitHongKongForm()" class="btn btn-primary flex-1">Enviar Solicitação</button>
                </div>
            </div>
        </div>

        <div id="hongKongSummaryScreen" class="screen hidden">
            <div class="app-content-wrapper"> <!-- Usando o novo wrapper para conteúdo principal -->
                <div class="header flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Resumo da Solicitação - Hong Kong</h1>
                    <button onclick="backToProductEntry()" class="btn btn-secondary">Voltar e Ajustar</button>
                </div>
                <div class="summary-content-wrapper"> <!-- Novo wrapper para conteúdo -->
                    <div id="moqValidationResult"></div>
                    <div id="supplierSplitResult" class="mt-4"></div>
                    <!-- <div id="cubagemPricePrediction" class="mt-4"></div> REMOVIDO DAQUI -->
                    <div class="mt-6 flex gap-4 justify-between" id="hkSummaryButtons">
                        <button onclick="generatePO()" class="btn btn-primary flex-1">Salvar Solicitação</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="purchaseOrderScreen" class="screen hidden container">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Solicitação Gerada</h1>
                <p class="text-gray-600 mb-4">A solicitação foi gerada e enviada para Compras Internacionais.</p>
            </div>
            <div id="poDetails" class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <!-- Detalhes da PO serão injetados aqui -->
            </div>
            <div class="mt-6 text-center text-gray-600">
                <p>Aguardando negociação de Compras Internacionais e aprovação do Renato.</p>
                <!-- Ocultar este botão se o usuário for 'client' -->
                <button onclick="simulateRenatoApprovalScreen()" class="btn btn-primary mt-4" id="simulateRenatoBtn">Simular Aprovação do Renato</button>
            </div>
            <!-- Botão adicionado para retornar à Central de Pedidos -->
            <button onclick="backToOrderCenter()" class="btn btn-secondary w-full mt-6">Voltar para Central de Pedidos</button>
        </div>

        <div id="renatoApprovalScreen" class="screen hidden">
            <div class="app-content-wrapper content-area">
                <div class="header">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Aprovação de Preços - Gerencial</h1>
                    <p class="text-gray-600 mb-4">Análise das diferenças de preço por fornecedor para aprovação final.</p>
                </div>
                <!-- Step 1: List of Pending Parent Orders -->
                <div id="pendingOrdersList">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos Pendentes de Aprovação</h2>
                    <div class="overflow-x-auto"> <!-- Added for horizontal scroll if table overflows -->
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Id Solicitação Principal</th> 
                                    <th>Nº Pedido</th> 
                                    <th>Cliente</th>
                                    <th>Fornecedor (Nome)</th>
                                    <th>Valor Total do Pedido</th>
                                    <th>Data Inclusão</th>
                                    <th>Data Última Atualização</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="pendingOrdersTableBody">
                                <!-- Pending individual POs will be listed here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Step 2: Detailed Approval View (initially hidden) -->
                <div id="detailedApprovalView" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="backToPendingOrdersList()" class="btn btn-secondary">← Voltar para a Lista</button>
                        <p class="font-semibold text-lg">Análise Detalhada para Pedido: <strong id="currentDetailedParentOrderIdDisplay"></strong></p>
                    </div>

                    <div id="overallComparisonSummary" class="mb-6 p-4 border rounded-lg bg-blue-50 text-blue-800 shadow-sm">
                        <p class="font-semibold text-lg mb-2">Análise de Preço Detalhada:</p>
                        <p>Aqui está a análise de preço para o pedido selecionado. Por favor, decida o status para cada produto antes de gravar.</p>
                    </div>
                    <div id="supplierApprovalCards">
                        <!-- Cards de aprovação por fornecedor serão injetados aqui (agora apenas 1 por vez) -->
                    </div>
                    <div id="globalDifferenceSummary" class="mt-6 p-4 rounded-lg bg-gray-100 border border-gray-300 text-center hidden">
                        <p class="text-xl font-bold text-gray-800">
                            Diferença Total Geral do Pedido: <span id="globalDifferenceValue"></span>
                        </p>
                        <p class="text-sm text-gray-600">Este é o impacto financeiro total em relação aos preços internos atuais.</p>
                    </div>
                    <div class="mt-6 flex justify-center gap-4">
                        <button onclick="saveApprovalDecisions()" class="btn btn-primary max-w-xs hidden" id="saveApprovalBtn" disabled>Gravar Análise</button>
                        <button onclick="displayRenatoFinalSummary()" class="btn btn-primary max-w-xs hidden" id="finalizeApprovalBtn" disabled>Finalizar Aprovação</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="hongKongFinalScreen" class="screen hidden container">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4" id="hongKongFinalTitle"></h1>
                <p class="text-gray-600" id="hongKongFinalMessage"></p>
            </div>
            <div class="message-box" id="finalDetailsHK">
                <!-- Detalhes finais com base na aprovação/rejeição -->
            </div>
            <button onclick="restartFlow()" class="btn btn-primary w-full mt-6">Iniciar Nova Solicitação</button>
        </div>

        <!-- Telas do Fluxo Colômbia -->
        <div id="colombiaFormScreen" class="screen hidden">
            <div class="app-content-wrapper"> <!-- Usando o novo wrapper para conteúdo principal -->
                <div class="header">
                    <h1 class="text-3xl font-bold text-gray-800 mb-4">Solicitação de Compra - Colômbia</h1>
                    <p class="text-gray-600">Por favor, preencha os detalhes dos produtos desejados.</p>
                </div>

                <!-- Campo opcional: Número do Pedido do Cliente -->
                <div class="mb-4">
                    <label for="clientOrderNumberCOL" class="block text-sm font-medium text-gray-700">Número do Pedido (Opcional):</label>
                    <input type="text" id="clientOrderNumberCOL" placeholder="Seu número de referência do pedido"
                        class="rounded-lg p-2 border border-gray-300 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="tab-buttons" id="colTabButtons">
                    <!-- Pedido Fácil vem primeiro agora -->
                    <button class="tab-button active" onclick="switchTab('colombia', 'easy')">Pedido Fácil</button>
                    <button class="tab-button" onclick="switchTab('colombia', 'manual')">Pedido Manual</button>
                </div>

                <!-- Pedido Fácil Tab Content (agora vem antes) -->
                <div id="colombiaEasyOrderTab" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedido Fácil</h2>
                    <p class="text-gray-600 mb-6">Escolha uma das opções abaixo para adicionar os produtos ao carrinho de compras</p>

                    <!-- Upload de Planilha -->
                    <div class="border p-4 rounded-lg bg-gray-50 mb-6">
                        <div class="collapsible-header" onclick="toggleCollapsible(this, 'uploadSheetContentCOL')">
                            <h3 class="font-semibold text-gray-700">Upload de Planilha</h3>
                            <svg class="collapsible-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="uploadSheetContentCOL" class="collapsible-content hidden">
                            <p class="mb-4 text-gray-600">Selecione o arquivo no seu computador para fazer o upload.</p>
                            <div class="flex items-center gap-4 mb-4">
                                <input type="file" id="fileUploadCOL" accept=".csv" class="hidden" onchange="displayFileName('fileUploadCOL', 'fileNameDisplayCOL')">
                                <button onclick="document.getElementById('fileUploadCOL').click()" class="btn btn-secondary">Selecionar arquivo</button>
                                <span id="fileNameDisplayCOL" class="text-gray-600 italic">Nenhum arquivo selecionado</span>
                            </div>
                            <p class="text-sm text-gray-500 mb-4">O tamanho do arquivo não deve ultrapassar 5MB. Formato aceito: .csv</p>
                            <button onclick="handleFileUpload('colombia')" class="btn btn-primary w-full">Fazer Upload</button>
                        </div>
                    </div>

                    <!-- Copiar e Colar Códigos -->
                    <div class="border p-4 rounded-lg bg-gray-50 mb-6">
                        <div class="collapsible-header" onclick="toggleCollapsible(this, 'copyPasteContentCOL')">
                            <h3 class="font-semibold text-gray-700">Copiar e Colar Códigos</h3>
                            <svg class="collapsible-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                        <div id="copyPasteContentCOL" class="collapsible-content hidden">
                            <p class="mb-4 text-gray-600">Cole os códigos de produto e quantidades (um por linha, ex: `CODIGO_CLIENTE,CODIGO_PRODUTO,QUANTIDADE` ou `CODIGO_UNICO,QUANTIDADE`):</p>
                            <textarea id="pasteCodesCOL" rows="5" class="w-full p-2 border rounded-lg mb-4"></textarea>
                            <button onclick="processPastedCodes('colombia')" class="btn btn-primary w-full">Adicionar Códigos</button>
                        </div>
                    </div>
                    
                    <!-- Saiba como utilizar nosso modelo de planilha -->
                    <div class="mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Saiba como utilizar nosso modelo de planilha</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/FFF/000?text=Código+Comercial" alt="Código comercial" class="mx-auto mb-4"/>
                                <p class="font-semibold text-lg mb-2">Passo 1</p>
                                <p class="text-gray-600">Faça o download do modelo de planilha. Abra a planilha no seu computador e preencha com o código do produto do cliente e o código do produto (opcional) e a quantidade desejada. Máximo de 50 linhas de produtos por pedido.</p>
                                <button onclick="downloadSpreadsheetModel()" class="text-blue-600 hover:underline mt-2 inline-block">Modelo de Planilha</button>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/FFF/000?text=+5MB" alt="+5MB" class="mx-auto mb-4"/>
                                <p class="font-semibold text-lg mb-2">Passo 2</p>
                                <p class="text-gray-600">Com sua planilha pronta e salva no seu computador, clique em Selecionar arquivo. Em seguida, clique em Fazer upload. O tamanho da planilha não deve ultrapassar 5MB de tamanho.</p>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                                <img src="https://placehold.co/100x100/FFF/000?text=Carrinho+de+compras+com+o+número+50" alt="Carrinho de compras com o número 50" class="mx-auto mb-4"/>
                                <p class="font-semibold text-lg mb-2">Passo 3</p>
                                <p class="text-gray-600">Com sua planilha pronta e salva no seu computador, clique em Selecionar arquivo. Em seguida, clique em Fazer upload. O tamanho da planilha não deve ultrapassar 5MB de tamanho.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pedido Manual Tab Content (agora vem depois do Pedido Fácil) -->
                <div id="colombiaManualOrderTab" class="tab-content hidden">
                    <!-- Seção para adicionar um novo produto, imitando a linha única da imagem -->
                    <div class="mb-6 border p-4 rounded-lg bg-gray-50">
                        <h3 class="font-semibold text-gray-700 mb-4">Adicionar Produtos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            <div class="col-span-1">
                                <label for="clientProductCodeCOL" class="block text-sm font-medium text-gray-700">Cód Prod Cliente:</label>
                                <div class="input-with-icon">
                                    <input type="text" id="clientProductCodeCOL" placeholder="Cód Cliente"
                                        oninput="updateProductDetailsOnClientCodeChangeCOL(); updateTotalValueCOL();"
                                        class="rounded-lg p-2 border border-gray-300 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <svg onclick="openProductCatalogModal('colombia')" class="search-icon w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="#6b7280">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="col-span-1">
                                <label for="productCodeCOLDisplay" class="block text-sm font-medium text-gray-700">Cód Produto:</label>
                                <div id="productCodeCOLDisplay" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    --
                                </div>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <label for="productDescriptionDisplayCOL" class="block text-sm font-medium text-gray-700">Descrição:</label>
                                <div id="productDescriptionDisplayCOL" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
                                    --
                                </div>
                            </div>
                            <div class="col-span-1">
                        <input type="number" id="productQuantityCOL" min="1" value="1"
                            oninput="updateTotalValueCOL();"
                            class="rounded-lg p-2 border border-gray-300 w-full text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
<div class="col-span-1">
    <label for="valorUnitCOLDisplay" class="block text-sm font-medium text-gray-700">Valor Unit.:</label>
    <div id="valorUnitCOLDisplay" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
        R$ 0,00
    </div>
</div>
<div class="col-span-1">
    <label for="valorTotalCOLDisplay" class="block text-sm font-medium text-gray-700">Valor Total:</label>
    <div id="valorTotalCOLDisplay" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center text-gray-600">
        R$ 0,00
    </div>
</div>
                            <div class="col-span-1">
                                <label for="productStockCOL" class="block text-sm font-medium text-gray-700">Estoque:</label>
                                <div id="productStockCOL" class="p-2 border border-gray-300 rounded-lg bg-gray-100 min-h-[42px] flex items-center font-bold">
                                    --
                                </div>
                            </div>
                            <div class="col-span-full flex justify-end">
                                <button onclick="addProductCOL()" class="btn btn-secondary">Adicionar Produto</button>
                            </div>
                        </div>
                        <div id="addProductMessageCOL" class="add-product-message hidden"></div>
                    </div>
                </div>

                <!-- Produtos Adicionados na Solicitação (fora das abas, para ser comum) -->
                <div id="productListCOL" class="mt-4 border p-4 rounded-lg bg-gray-50 max-h-80 overflow-y-auto">
                    <h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados na Solicitação:</h3>
                    <div id="noProductsAddedCOL" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>
                    <!-- Produtos serão listados aqui em uma tabela -->
                </div>

                <div class="flex flex-col md:flex-row gap-4 mt-6">
                    <button onclick="backToFilialSelectionFromForm()" class="btn btn-secondary flex-1">Voltar</button>
                    <button onclick="submitColombiaForm()" class="btn btn-primary flex-1">Enviar Solicitação para SAP</button>
                </div>
            </div>
        </div>

        <div id="colombiaInvoiceScreen" class="screen hidden container">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Faturamento e Nota Fiscal - Colômbia</h1>
                <p class="text-gray-600">Seu pedido foi faturado e a Nota Fiscal está disponível.</p>
            </div>
            <div class="message-box">
                <p class="font-semibold">Nota Fiscal Eletrônica (NF-e) gerada com sucesso!</p>
                <p>Número da NF-e: <span id="nfeNumber">NF-20250624-001</span></p>
                <p>Valor Total: <span id="nfeValue">R$ 0,00</span></p>
                <p class="mt-4">
                    <a href="#" onclick="showNfePdf()" class="text-blue-600 hover:underline">Visualizar PDF da NF-e</a>
                </p>
            </div>
            <div id="nfePdfViewer" class="hidden mt-6 bg-gray-100 p-4 rounded-lg border border-gray-200">
                <p class="text-gray-700">Simulação de PDF da Nota Fiscal:</p>
                <pre id="nfePdfContent" class="bg-white p-4 rounded-md border border-gray-300 text-sm overflow-auto max-h-96 mt-2">
                    <!-- NFE content will be dynamically updated -->
                </pre>
                <button onclick="document.getElementById('nfePdfViewer').classList.add('hidden')" class="btn btn-secondary w-full mt-4">Fechar PDF</button>
            </div>
            <button onclick="restartFlow()" class="btn btn-primary w-full mt-6">Iniciar Nova Solicitação</button>
        </div>

        <!-- NEW: Central de Compras Screen -->
        <div id="purchasingCenterScreen" class="screen hidden">
            <div class="app-content-wrapper content-area">
                <div class="header flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">Central de Compras</h1>
                </div>

                <div class="tab-buttons" id="purchasingTabButtons">
                    <button class="tab-button active" onclick="switchPurchasingTab('novasSolicitacoes')">Novas Solicitações</button>
                    <button class="tab-button" onclick="switchPurchasingTab('negociacoesEmAndamento')">Negociações em Andamento</button>
                    <button class="tab-button" onclick="switchPurchasingTab('renatoActions')">Aguardando Gerencia</button>
                    <button class="tab-button" onclick="switchPurchasingTab('aprovadoGerencia')">Aprovado Gerencia</button> <!-- NEW TAB BUTTON -->
                </div>

                <div id="novasSolicitacoesTab" class="tab-content">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos Aguardando Negociação (Novas Solicitações)</h2>
                    <div class="overflow-x-auto">
                        <table id="negotiationTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Id Solicitação Principal</th>
                                    <th>Nº Pedido</th>
                                    <th>Fornecedor</th>
                                    <th>Valor Estimado</th>
                                    <th>Data Criação</th>
                                    <th>Status</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders awaiting negotiation will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- NEW: Negociações em Andamento Tab -->
                <div id="negociacoesEmAndamentoTab" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos em Negociação com Fornecedor</h2>
                    <div class="overflow-x-auto">
                        <table id="negotiationInProgressTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Id Solicitação Principal</th>
                                    <th>Nº Pedido</th>
                                    <th>Fornecedor</th>
                                    <th>Valor Estimado</th>
                                    <th>Data Última Alteração</th>
                                    <th>Status</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders in negotiation will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="renatoActionsTab" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos com Ações do Renato</h2>
                    <div class="overflow-x-auto">
                        <table id="renatoActionsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Id Solicitação Principal</th>
                                    <th>Nº Pedido</th>
                                    <th>Cliente</th> <!-- Added Cliente column -->
                                    <th>Fornecedor</th>
                                    <th>Valor Estimado</th>
                                    <th>Data Última Alteração</th>
                                    <th>Status</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders with Renato's actions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- NEW TAB CONTENT: Aprovado Gerencia -->
                <div id="aprovadoGerenciaTab" class="tab-content hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Pedidos Aprovados pela Gerência, Aguardando Finalização de Compras</h2>
                    <div class="overflow-x-auto">
                        <table id="aprovadoGerenciaTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Id Solicitação Principal</th>
                                    <th>Nº Pedido</th>
                                    <th>Fornecedor</th>
                                    <th>Valor Estimado</th>
                                    <th>Data Aprovação Gerencia</th>
                                    <th>Status</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Orders approved by management will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <button onclick="logout()" class="btn btn-secondary w-full mt-6">Sair (Logout)</button>
            </div>
        </div>

        <!-- NEW: Purchasing Order Details Screen -->
        <div id="purchasingOrderDetailsScreen" class="screen hidden app-content-wrapper">
            <div class="header">
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Detalhes do Pedido de Compra <span id="purchasingCurrentOrderId"></span></h1>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 mb-6">
                <h3 class="font-semibold text-lg mb-4">Informações Gerais</h3>
                <div class="space-y-2">
                    <div class="detail-item">
                        <strong>Nº Pedido:</strong> <span id="purchasingDetailOrderId"></span>
                    </div>
                    <div class="detail-item">
                        <strong>ID Principal:</strong> <span id="purchasingDetailParentOrderId"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Fornecedor:</strong> <span id="purchasingDetailSupplier"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Status Atual:</strong> <span id="purchasingDetailStatus"></span>
                    </div>
                    <div class="detail-item">
                        <strong>Data Criação:</strong> <span id="purchasingDetailDate"></span>
                    </div>
                </div>

                <h3 class="font-semibold text-lg mt-6 mb-4">Produtos do Pedido</h3>
                <div class="table-container border border-gray-200 rounded-lg overflow-hidden">
                    <table class="product-details-table">
                        <thead>
                            <tr>
                                <th>Código Produto</th>
                                <th>Descrição</th>
                                <th>Qtd.</th>
                                <th>Valor Unit. Interno</th>
                                <th>Valor Unit. Fornecedor (Atual)</th>
                                <th>Novo Valor Unit.</th>
                                <th>Status Aprovação</th>
                            </tr>
                        </thead>
                        <tbody id="purchasingOrderProductsTableBody">
                            <!-- Product details with editable new value input will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="flex flex-col md:flex-row gap-4 mt-6">
                <button onclick="backToPurchasingCenter()" class="btn btn-secondary flex-1">Voltar para Central de Compras</button>
                <button onclick="generatePOPDF()" class="btn btn-primary flex-1">Gerar PO em PDF</button>
                <button onclick="handlePurchasingAction()" class="btn btn-primary flex-1" id="savePurchasingNegotiationBtn">Salvar Negociação</button>
            </div>

            <!-- NEW: PDF Viewer for Purchase Order -->
            <div id="poPdfViewer" class="hidden mt-6 bg-gray-100 p-4 rounded-lg border border-gray-200">
                <p class="text-gray-700">Simulação de Purchase Order (PO) em PDF:</p>
                <pre id="poPdfContent" class="bg-white p-4 rounded-md border border-gray-300 text-sm overflow-auto max-h-96 mt-2">
                    <!-- PO PDF content will be dynamically updated -->
                </pre>
                <button onclick="document.getElementById('poPdfViewer').classList.add('hidden')" class="btn btn-secondary w-full mt-4">Fechar PDF</button>
            </div>
        </div>

        <!-- Caixa de Mensagem Genérica (para alertas, confirmações) -->
        <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                <h3 id="messageModalTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <p id="messageModalContent" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end gap-3">
                    <button id="messageModalConfirmBtn" class="btn btn-primary hidden">Confirmar</button>
                    <button id="messageModalCancelBtn" class="btn btn-secondary hidden">Cancelar</button>
                    <button id="messageModalCloseBtn" class="btn btn-primary">Ok</button>
                </div>
            </div>
        </div>

        <!-- Modal de Catálogo de Produtos -->
        <div id="productCatalogModal" class="modal-overlay hidden">
            <div class="modal-content container">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Catálogo de Produtos</h3>
                <input type="text" id="productCatalogSearchInput" placeholder="Pesquisar por Código ou Descrição..." oninput="filterProductCatalog()">
                <div id="productCatalogList">
                    <!-- Lista de produtos será renderizada aqui -->
                </div>
                <button onclick="closeProductCatalogModal()" class="btn btn-secondary w-full mt-6">Fechar</button>
            </div>
        </div>

        <!-- Nova Tela de Carregamento da Análise -->
        <div id="analysisLoadingScreen" class="hidden">
            <div class="spinner"></div>
            <p class="message">Realizando Análise de Preços...</p>
            <p class="sub-message">Validando dados, comparando valores e otimizando custos.</p>
        </div>

    </div>

    <script>
        // --- Gerenciamento de Estado ---
        let currentScreen = 'loginScreen';
        let selectedFilial = '';
        let hongKongProducts = []; // Atua como o "carrinho" para Hong Kong
        let colombiaProducts = [];
        // Variável global para definir a função do usuário. 'client' ou 'admin'
        let userRole = 'guest'; // Padrão: 'guest' (convidado), pode ser 'client', 'admin', 'compras'
        let simulatedSupplierOrders = {}; // Para armazenar a divisão dos produtos por fornecedor
        let currentOrderDetails = null; // Para armazenar detalhes do pedido selecionado
        let currentUserClientName = "Cliente Prototipo"; // Definido globalmente para o usuário "prototipo"

        // Variáveis para controlar os sequenciais de IDs
        let nextParentRequestCounter = 1; // Para SOL-001, SOL-002...
        let nextPurchaseOrderIdCounter = 0; // Para PED-001, PED-002... será inicializado com orders.length + 1
        let currentParentOrderId = null; // Armazena o ID da solicitação "pai" atual (SOL-XXX)

        // Variável para armazenar os POs atualmente exibidos na visualização de aprovação detalhada (Renato)
        let currentViewingPO = null; 

        // Variável para armazenar o PO sendo editado na tela de Compras
        let currentPurchasingPO = null;

        // --- Constantes para Capacidades de Contêiner (em m³) ---
        const MAX_CUBAGE_20HC = 37.4;
        const MAX_CUBAGE_40HC = 76.0;

        // --- Banco de Dados de Produtos Simulados (Código, Descrição, MOQ, Preço Unitário Simulado, Linha do Produto) ---
        const productDatabase = {
            // Produtos universais com códigos sequenciais
            "PROD001": { code: "PROD001", clientCode: "SKU-001", description: "Smartphone Premium X1", moq: 3, unitPrice: 150.00, tableValue: 160.00, cubageUnit: 0.005, simulatedStock: 100, productLine: "Eletrônicos", supplier: "Fornecedor A" },
            "PROD002": { code: "PROD002", clientCode: "SKU-002", description: "Tablet Pro Z", moq: 2, unitPrice: 250.00, tableValue: 265.00, cubageUnit: 0.008, simulatedStock: 50, productLine: "Eletrônicos", supplier: "Fornecedor B" },
            "PROD003": { code: "PROD003", clientCode: "SKU-003", description: "Fone Bluetooth Max", moq: 5, unitPrice: 45.00, tableValue: 50.00, cubageUnit: 0.001, simulatedStock: 200, productLine: "Acessórios", supplier: "Fornecedor C" },
            "PROD004": { code: "PROD004", clientCode: "SKU-004", description: "Smartwatch Sport Y", moq: 1, unitPrice: 80.00, tableValue: 85.00, cubageUnit: 0.002, simulatedStock: 120, productLine: "Vestíveis", supplier: "Fornecedor A" },
            "PROD005": { code: "PROD005", clientCode: "SKU-005", description: "Câmera Digital Ultra HD", moq: 2, unitPrice: 300.00, tableValue: 320.00, cubageUnit: 0.01, simulatedStock: 30, productLine: "Fotografia", supplier: "Fornecedor B" },
            "PROD006": { code: "PROD006", clientCode: "SKU-006", description: "Bateria Portátil Mega", moq: 10, unitPrice: 25.00, tableValue: 28.00, cubageUnit: 0.0005, simulatedStock: 300, productLine: "Acessórios", supplier: "Fornecedor C" },
            "PROD007": { code: "PROD007", clientCode: "SKU-007", description: "Cadeira Ergonômica", moq: 1, unitPrice: 600.00, tableValue: 650.00, cubageUnit: 0.15, simulatedStock: 15, productLine: "Móveis de Escritório", supplier: "Fornecedor A" },
            "PROD008": { code: "PROD008", clientCode: "SKU-008", description: "Impressora 3D Industrial", moq: 1, unitPrice: 800.00, tableValue: 850.00, cubageUnit: 0.8, simulatedStock: 0, productLine: "Maquinário", supplier: "Fornecedor B" },
            "PROD009": { code: "PROD009", clientCode: "SKU-009", description: "Monitor Ultrawide", moq: 1, unitPrice: 350.00, tableValue: 350.00, cubageUnit: 0.05, simulatedStock: 50, productLine: "Periféricos", supplier: "Fornecedor C" },
            "PROD010": { code: "PROD010", clientCode: "SKU-010", description: "Teclado Mecânico", moq: 1, unitPrice: 80.00, tableValue: 80.00, cubageUnit: 0.01, simulatedStock: 75, productLine: "Periféricos", supplier: "Fornecedor A" },
            "PROD011": { code: "PROD011", clientCode: "SKU-011", description: "Mouse Gamer", moq: 1, unitPrice: 40.00, tableValue: 40.00, cubageUnit: 0.001, simulatedStock: 150, productLine: "Periféricos", supplier: "Fornecedor B" }

        };

        // Cria um mapeamento reverso universal para ClientProductCode (SKU) para ProductCode (PROD)
        const universalClientCodeToProductCodeMap = {};
        for (const prodCode in productDatabase) {
            const product = productDatabase[prodCode];
            if (product.clientCode) {
                universalClientCodeToProductCodeMap[product.clientCode.toUpperCase()] = prodCode;
            }
        }

        // Global map for suppliers to their numerical codes and reverse map
        const supplierCodeMap = {};
        const supplierNameMap = {}; // Reverse map to get name from code
        let nextSupplierCode = 22; // Start with 22, increment by 11

        function getOrGenerateSupplierCode(supplierName) {
            if (!supplierCodeMap[supplierName]) {
                supplierCodeMap[supplierName] = String(nextSupplierCode);
                supplierNameMap[String(nextSupplierCode)] = supplierName; // Store reverse mapping
                nextSupplierCode += 11;
            }
            return supplierCodeMap[supplierName];
        }

function showScreenInfo() {
    let info = '';
    switch (currentScreen) {
        case 'orderCenterScreen':
            info = 'Central de Pedidos: Visualize todos os pedidos realizados, filtre por status, fornecedor e país de origem, acesse detalhes e inicie novas solicitações.';
            break;
        case 'orderDetailsScreen':
            info = 'Detalhes do Pedido: Veja todas as informações do pedido selecionado, incluindo produtos, valores, status e rastreamento.';
            break;
        case 'hongKongFormScreen':
            info = 'Solicitação de Compra Hong Kong: Crie uma nova solicitação de compra para Hong Kong, adicionando produtos manualmente ou por planilha.';
            break;
        case 'colombiaFormScreen':
            info = 'Solicitação de Compra Colômbia: Crie uma nova solicitação de compra para Colômbia, adicionando produtos manualmente ou por planilha.';
            break;
        case 'renatoApprovalScreen':
            info = 'Aprovação de Preços - Gerencial: Aprove, negocie ou rejeite preços de pedidos enviados pelo time de compras, analisando as diferenças de preço.';
            break;
        case 'purchasingCenterScreen':
            info = 'Central de Compras: Área para o time de compras visualizar, negociar e aprovar solicitações recebidas dos clientes.';
            break;
        // Adicione outros cases conforme necessário
        default:
            info = 'Esta tela faz parte do fluxo do portal. Para mais informações, consulte o manual ou o suporte.';
    }
    showMessage('Informações da Tela', info, 'info');
}


        function updateTotalValueHK() {
    const clientProductCode = document.getElementById('clientProductCodeHK').value.trim().toUpperCase();
    const productCode = universalClientCodeToProductCodeMap[clientProductCode];
    const productInfo = productDatabase[productCode];
    const quantity = parseInt(document.getElementById('productQuantityHK').value);
    const valorTotalDisplay = document.getElementById('valorTotalHKDisplay');

    if (productInfo && !isNaN(quantity) && quantity > 0) {
        const total = productInfo.tableValue * quantity;
        valorTotalDisplay.innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
    } else {
        valorTotalDisplay.innerText = 'R$ 0,00';
    }
}

        function getSupplierNameFromCode(supplierCode) {
            return supplierNameMap[supplierCode] || supplierCode; // Return code if name not found
        }
        
        // --- Dados de Pedidos Simulados ---
        // Orders Array (Client's view) - Represents all orders, some will be linked to POs
        const orders = [
            {
                orderId: 'PED-001', parentOrderId: 'SOL-001', clientFlag: 'TOTVS BRASIL', originCountry: 'Hong Kong',
                totalValue: 1550.00, status: 'Pendente', requestDate: '2025-06-20', lastUpdateDate: '2025-06-20',
                supplier: 'Fornecedor A', products: [{ code: 'PROD001', description: 'Smartphone Premium X1', quantity: 10, unitPrice: 155.00, cubageUnit: 0.005 }]
            },
            {
                orderId: 'PED-002', parentOrderId: 'SOL-009', clientFlag: 'ACME Corp', originCountry: 'Colômbia',
                totalValue: 1200.00, status: 'Pendente', requestDate: '2025-06-21', lastUpdateDate: '2025-06-21',
                supplier: 'Fornecedor B', products: [{ code: 'PROD007', description: 'Cadeira Ergonômica', quantity: 2, unitPrice: 600.00, cubageUnit: 0.15 }]
            },
            {
                orderId: 'PED-003', parentOrderId: 'SOL-002', clientFlag: 'Global Tech', originCountry: 'Hong Kong',
                totalValue: 300.00, status: 'Rejeitado', requestDate: '2025-06-18', lastUpdateDate: '2025-06-19',
                supplier: 'Fornecedor A', products: [{ code: 'PROD003', description: 'Fone Bluetooth Max', quantity: 5, unitPrice: 45.00, cubageUnit: 0.001 }, { code: 'PROD006', description: 'Bateria Portátil Mega', quantity: 5, unitPrice: 25.00, cubageUnit: 0.0005 }]
            },
            {
                orderId: 'PED-004', parentOrderId: 'SOL-010', clientFlag: 'Importadora Sul', originCountry: 'Colômbia',
                totalValue: 800.00, status: 'Entregue', requestDate: '2025-06-23', lastUpdateDate: '2025-06-23',
                supplier: 'Fornecedor C', products: [{ code: 'PROD008', description: 'Impressora 3D Industrial', quantity: 1, unitPrice: 800.00, cubageUnit: 0.8 }]
            },
            {
                orderId: 'PED-005', parentOrderId: 'SOL-003', clientFlag: 'Tech Solutions', originCountry: 'Hong Kong',
                totalValue: 454.00, status: 'Pendente', requestDate: '2025-06-24', lastUpdateDate: '2025-06-24',
                supplier: 'Fornecedor B', products: [{ code: 'PROD001', description: 'Smartphone Premium X1', quantity: 2, unitPrice: 152.00, cubageUnit: 0.005 }, { code: 'PROD003', description: 'Fone Bluetooth Max', quantity: 3, unitPrice: 46.00, cubageUnit: 0.001 }]
            },
            {
                orderId: 'PED-006', parentOrderId: 'SOL-003', clientFlag: 'Eletro Mundi', originCountry: 'Hong Kong',
                totalValue: 120.00, status: 'Chegada no Porto de Destino (ATA)', requestDate: '2025-06-24', lastUpdateDate: '2025-06-25',
                supplier: 'Fornecedor A', products: [{ code: 'PROD004', description: 'Smartwatch Sport Y', quantity: 1, unitPrice: 80.00, cubageUnit: 0.002 }, { code: 'PROD006', description: 'Bateria Portátil Mega', quantity: 2, unitPrice: 20.00, cubageUnit: 0.0005 }]
            },
            {
                orderId: 'PED-007', parentOrderId: 'SOL-004', clientFlag: 'Casa e Conforto', originCountry: 'Colômbia',
                totalValue: 1800.00, status: 'Em Conferência', requestDate: '2025-06-25', lastUpdateDate: '2025-06-25',
                supplier: 'Fornecedor C', products: [{ code: 'PROD007', description: 'Cadeira Ergonômica', quantity: 3, unitPrice: 600.00, cubageUnit: 0.15 }]
            },
            {
                orderId: 'PED-008', parentOrderId: 'SOL-011', clientFlag: 'Home Office Ltda', originCountry: 'Hong Kong',
                totalValue: 700.00, status: 'Carga Pronta', requestDate: '2025-06-25', lastUpdateDate: '2025-06-25',
                supplier: 'Fornecedor B', products: [{ code: 'PROD009', description: 'Monitor Ultrawide', quantity: 2, unitPrice: 350.00, cubageUnit: 0.05 }]
            },
            {
                orderId: 'PED-009', parentOrderId: 'SOL-005', clientFlag: 'Game Lovers', originCountry: 'Hong Kong',
                totalValue: 120.00, status: 'Aprovado', requestDate: '2025-06-26', lastUpdateDate: '2025-06-26',
                supplier: 'Fornecedor A', products: [{ code: 'PROD010', description: 'Teclado Mecânico', quantity: 1, unitPrice: 80.00, cubageUnit: 0.01 }, { code: 'PROD011', description: 'Mouse Gamer', quantity: 1, unitPrice: 40.00, cubageUnit: 0.001 }]
            },
            {
                orderId: 'PED-010', parentOrderId: 'SOL-005', clientFlag: 'Fotografia Profissional', originCountry: 'Hong Kong',
                totalValue: 960.00, status: 'Pendente', requestDate: '2025-06-26', lastUpdateDate: '2025-06-26',
                supplier: 'Fornecedor C', products: [{ code: 'PROD005', description: 'Câmera Digital Ultra HD', quantity: 3, unitPrice: 320.00, cubageUnit: 0.01 }]
            },
            {
                orderId: 'PED-011', parentOrderId: 'SOL-006', clientFlag: 'Acessórios Digitais', originCountry: 'Hong Kong',
                totalValue: 100.00, status: 'Cancelado', requestDate: '2025-06-27', lastUpdateDate: '2025-06-27',
                supplier: 'Fornecedor A', products: [{ code: 'PROD003', description: 'Fone Bluetooth Max', quantity: 2, unitPrice: 50.00, cubageUnit: 0.001 }]
            },
            {
                orderId: 'PED-012', parentOrderId: 'SOL-012', clientFlag: 'Tecnologia Avançada', originCountry: 'Colômbia',
                totalValue: 800.00, status: 'Em Rota de Entrega', requestDate: '2025-06-27', lastUpdateDate: '2025-06-27',
                supplier: 'Fornecedor B', products: [{ code: 'PROD008', description: 'Impressora 3D Industrial', quantity: 1, unitPrice: 800.00, cubageUnit: 0.8 }]
            },
            {
                orderId: 'PED-013', parentOrderId: 'SOL-007', clientFlag: 'Móveis Modernos', originCountry: 'Colômbia',
                totalValue: 1200.00, status: 'Pendente', requestDate: '2025-06-28', lastUpdateDate: '2025-06-28',
                supplier: 'Fornecedor C', products: [{ code: 'PROD007', description: 'Cadeira Ergonômica', quantity: 2, unitPrice: 600.00, cubageUnit: 0.15 }]
            },
            {
                orderId: 'PED-014', parentOrderId: 'SOL-013', clientFlag: 'Importadora Nova', originCountry: 'Hong Kong',
                totalValue: 160.00, status: 'Saída do Porto de Embarque (ATD)', requestDate: '2025-06-28', lastUpdateDate: '2025-06-28',
                supplier: 'Fornecedor A', products: [{ code: 'PROD001', description: 'Smartphone Premium X1', quantity: 1, unitPrice: 160.00, cubageUnit: 0.005 }]
            },
            // Orders linked to generatedPurchaseOrders (will have status updated by sync)
            {
                orderId: 'PED-015', parentOrderId: 'SOL-008', clientFlag: 'Cliente Prototipo', originCountry: 'Hong Kong',
                totalValue: 760.00, status: 'Pendente', requestDate: '2025-06-29', lastUpdateDate: '2025-06-29',
                supplier: 'Fornecedor A', products: [{ code: 'PROD001', description: 'Smartphone Premium X1', quantity: 5, unitPrice: 152.00, cubageUnit: 0.005 }]
            },
            {
                orderId: 'PED-016', parentOrderId: 'SOL-008', clientFlag: 'Cliente Prototipo', originCountry: 'Hong Kong',
                totalValue: 510.00, status: 'Pendente', requestDate: '2025-06-29', lastUpdateDate: '2025-06-29',
                supplier: 'Fornecedor B', products: [{ code: 'PROD002', description: 'Tablet Pro Z', quantity: 2, unitPrice: 255.00, cubageUnit: 0.008 }]
            },
            {
                orderId: 'PED-017', parentOrderId: 'SOL-014', clientFlag: 'New Client 1', originCountry: 'Hong Kong',
                totalValue: 840.00, status: 'Pendente', requestDate: '2025-06-30', lastUpdateDate: '2025-06-30',
                supplier: 'Fornecedor C', products: [{ code: 'PROD003', description: 'Fone Bluetooth Max', quantity: 20, unitPrice: 42.00, cubageUnit: 0.001 }]
            },
            {
                orderId: 'PED-018', parentOrderId: 'SOL-015', clientFlag: 'New Client 2', originCountry: 'Hong Kong',
                totalValue: 410.00, status: 'Pendente', requestDate: '2025-06-29', lastUpdateDate: '2025-06-29',
                supplier: 'Fornecedor A', products: [{ code: 'PROD004', description: 'Smartwatch Sport Y', quantity: 5, unitPrice: 82.00, cubageUnit: 0.002 }]
            },
            {
                orderId: 'PED-019', parentOrderId: 'SOL-016', clientFlag: 'New Client 3', originCountry: 'Hong Kong',
                totalValue: 310.00, status: 'Pendente', requestDate: '2025-06-30', lastUpdateDate: '2025-06-30',
                supplier: 'Fornecedor B', products: [{ code: 'PROD005', description: 'Câmera Digital Ultra HD', quantity: 1, unitPrice: 310.00, cubageUnit: 0.01 }]
            },
            {
                orderId: 'PED-020', parentOrderId: 'SOL-017', clientFlag: 'New Client 4', originCountry: 'Hong Kong',
                totalValue: 330.00, status: 'Pendente', requestDate: '2025-06-25', lastUpdateDate: '2025-06-25',
                supplier: 'Fornecedor A', products: [{ code: 'PROD006', description: 'Bateria Portátil Mega', quantity: 15, unitPrice: 22.00, cubageUnit: 0.0005 }]
            },
        ];

        // generatedPurchaseOrders array (Purchasing's view)
        let generatedPurchaseOrders = [
            // --- Novas Solicitações (Pendente) ---
            {
                parentOrderId: 'SOL-001', id: 'PED-001', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-20',
                products: [
                    { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 10, unitPrice: 150.00, currentInternalUnitPrice: 160.00, newSupplierUnitPrice: 155.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (10 * 155).toFixed(2), currentInternalPriceTotal: (10 * 160).toFixed(2), overallApprovalStatus: 'Pendente'
            },
            {
                parentOrderId: 'SOL-014', id: 'PED-017', supplier: 'Fornecedor C', supplierCode: '44', date: '2025-06-30',
                products: [
                    { code: 'PROD003', name: 'Fone Bluetooth Max', quantity: 20, unitPrice: 40.00, currentInternalUnitPrice: 48.00, newSupplierUnitPrice: 42.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (20 * 42).toFixed(2), currentInternalPriceTotal: (20 * 48).toFixed(2), overallApprovalStatus: 'Pendente'
            },

            // --- Negociações em Andamento (Negociado) ---
            {
                parentOrderId: 'SOL-003', id: 'PED-005', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-24',
                products: [
                    { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 2, unitPrice: 150.00, currentInternalUnitPrice: 158.00, newSupplierUnitPrice: 152.00, approvalStatus: 'Pendente' },
                    { code: 'PROD003', name: 'Fone Bluetooth Max', quantity: 3, unitPrice: 45.00, currentInternalUnitPrice: 48.00, newSupplierUnitPrice: 46.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (2 * 152 + 3 * 46).toFixed(2), currentInternalPriceTotal: (2 * 158 + 3 * 48).toFixed(2), overallApprovalStatus: 'Negociado' // Changed to Negociado
            },
            {
                parentOrderId: 'SOL-015', id: 'PED-018', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-29',
                products: [
                    { code: 'PROD004', name: 'Smartwatch Sport Y', quantity: 5, unitPrice: 80.00, currentInternalUnitPrice: 85.00, newSupplierUnitPrice: 82.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (5 * 82).toFixed(2), currentInternalPriceTotal: (5 * 85).toFixed(2), overallApprovalStatus: 'Negociado'
            },

            // --- Aguardando Gerencia (Aguardando Aprovação) ---
            {
                parentOrderId: 'SOL-008', id: 'PED-015', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-29',
                products: [
                    { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 5, unitPrice: 150.00, currentInternalUnitPrice: 158.00, newSupplierUnitPrice: 152.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (5 * 152).toFixed(2), currentInternalPriceTotal: (5 * 158).toFixed(2), overallApprovalStatus: 'Aguardando Aprovação' // Changed
            },
            {
                parentOrderId: 'SOL-008', id: 'PED-016', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-29',
                products: [
                    { code: 'PROD002', name: 'Tablet Pro Z', quantity: 2, unitPrice: 250.00, currentInternalUnitPrice: 260.00, newSupplierUnitPrice: 255.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (2 * 255).toFixed(2), currentInternalPriceTotal: (2 * 260).toFixed(2), overallApprovalStatus: 'Aguardando Aprovação' // Changed
            },
            {
                parentOrderId: 'SOL-016', id: 'PED-019', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-30',
                products: [
                    { code: 'PROD005', name: 'Câmera Digital Ultra HD', quantity: 1, unitPrice: 300.00, currentInternalUnitPrice: 320.00, newSupplierUnitPrice: 310.00, approvalStatus: 'Pendente' }
                ],
                newSupplierPriceTotal: (1 * 310).toFixed(2), currentInternalPriceTotal: (1 * 320).toFixed(2), overallApprovalStatus: 'Aguardando Aprovação'
            },


            // --- Aprovado Gerencia (Aprovado) ---
            {
                parentOrderId: 'SOL-005', id: 'PED-010', supplier: 'Fornecedor C', supplierCode: '44', date: '2025-06-26',
                products: [
                    { code: 'PROD005', name: 'Câmera Digital Ultra HD', quantity: 3, unitPrice: 320.00, currentInternalUnitPrice: 335.00, newSupplierUnitPrice: 320.00, approvalStatus: 'Aprovado' }
                ],
                newSupplierPriceTotal: (3 * 320).toFixed(2), currentInternalPriceTotal: (3 * 335).toFixed(2), overallApprovalStatus: 'Aprovado' // Changed
            },
            {
                parentOrderId: 'SOL-009', id: 'PED-002', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-21',
                products: [
                    { code: 'PROD007', name: 'Cadeira Ergonômica', quantity: 2, unitPrice: 600.00, currentInternalUnitPrice: 630.00, newSupplierUnitPrice: 600.00, approvalStatus: 'Aprovado' }
                ],
                newSupplierPriceTotal: (2 * 600).toFixed(2), currentInternalPriceTotal: (2 * 630).toFixed(2), overallApprovalStatus: 'Aprovado' // Changed
            },

            // --- Finalizado (Para simular POs completas no fluxo de Compras) ---
            {
                parentOrderId: 'SOL-017', id: 'PED-020', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-25',
                products: [
                    { code: 'PROD006', name: 'Bateria Portátil Mega', quantity: 15, unitPrice: 20.00, currentInternalUnitPrice: 28.00, newSupplierUnitPrice: 22.00, approvalStatus: 'Aprovado' }
                ],
                newSupplierPriceTotal: (15 * 22).toFixed(2), currentInternalPriceTotal: (15 * 28).toFixed(2), overallApprovalStatus: 'Finalizado'
            },
        ];


        // --- Funções Utilitárias ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            currentScreen = screenId;

            // Ocultar/Mostrar o botão "Simular Aprovação do Renato" com base na função do usuário
            const simulateRenatoBtn = document.getElementById('simulateRenatoBtn');
            if (simulateRenatoBtn) {
                if (userRole === 'client') {
                    simulateRenatoBtn.classList.add('hidden');
                } else {
                    simulateRenatoBtn.classList.remove('hidden');
                }
            }
        }

        function showMessage(title, content, type = 'info', onConfirm = null, onCancel = null) {
            const modal = document.getElementById('messageModal');
            document.getElementById('messageModalTitle').innerText = title;
            document.getElementById('messageModalContent').innerText = content;

            const confirmBtn = document.getElementById('messageModalConfirmBtn');
            const cancelBtn = document.getElementById('messageModalCancelBtn');
            const closeBtn = document.getElementById('messageModalCloseBtn');

            confirmBtn.onclick = () => { if (onConfirm) onConfirm(); modal.classList.add('hidden'); };
            cancelBtn.onclick = () => { if (onCancel) onCancel(); modal.classList.add('hidden'); };
            closeBtn.onclick = () => modal.classList.add('hidden');

            confirmBtn.classList.add('hidden');
            cancelBtn.classList.add('hidden');
            closeBtn.classList.remove('hidden'); // Botão "Ok" padrão

            if (onConfirm || onCancel) {
                closeBtn.classList.add('hidden'); // Ocultar "Ok" padrão se "Confirmar/Cancelar" estiverem presentes
                confirmBtn.classList.remove('hidden');
                if (onCancel) {
                    cancelBtn.classList.remove('hidden');
                }
            }
            modal.classList.remove('hidden');
        }

        function displayAddProductMessage(message, type, filial) {
            let messageDiv;
            if (filial === 'hongkong') {
                messageDiv = document.getElementById('addProductMessageHK');
            } else { // 'colombia'
                messageDiv = document.getElementById('addProductMessageCOL');
            }
            
            messageDiv.innerText = message;
            messageDiv.className = `add-product-message ${type}`;
            messageDiv.classList.remove('hidden');
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000); // Esconder após 3 segundos
        }

        // --- Controle de Fluxo ---
        function login() {
            console.log("Função login() iniciada.");
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            console.log("Usuário:", username);
            console.log("Senha:", password);

            // Validação de login: "prototipo/prototipo" é o usuário cliente
            if (username === 'cliente' && password === 'cliente') {
                console.log("Login como 'cliente' bem-sucedido.");
                userRole = 'client'; // Define a função do usuário como 'client'
                showScreen('orderCenterScreen');
                // Garante que nextParentRequestCounter e nextPurchaseOrderIdCounter sejam inicializados com base nos dados existentes
                // Encontra o ID SOL-XXX máximo
                const maxSolId = orders.reduce((max, order) => {
                    const solNum = order.parentOrderId && typeof order.parentOrderId === 'string'
                                   ? parseInt(order.parentOrderId.replace('SOL-', ''))
                                   : 0;
                    return isNaN(solNum) ? max : Math.max(max, solNum);
                }, 0);
                nextParentRequestCounter = maxSolId + 1;

                // Encontra o ID PED-XXX máximo
                const maxPedId = orders.reduce((max, order) => {
                    const pedNum = order.orderId && typeof order.orderId === 'string'
                                   ? parseInt(order.orderId.replace('PED-', ''))
                                   : 0;
                    return isNaN(pedNum) ? max : Math.max(max, pedNum);
                }, 0);
                nextPurchaseOrderIdCounter = maxPedId + 1;
                
                populateSupplierFilter(); // Popula o filtro de fornecedores após o login
                populateOriginCountryFilter(); // Popula o filtro de países de origem após o login
                renderOrdersTable(); // Renderiza a tabela de pedidos após o login
            } else if (username === 'compras' && password === 'compras') {
                console.log("Login como 'compras' bem-sucedido.");
                userRole = 'compras'; // Define a função do usuário como 'compras'
                showScreen('purchasingCenterScreen');
                switchPurchasingTab('novasSolicitacoes'); // Default to "Novas Solicitações"
            }
             else if (username === 'gestor' && password === 'gestor') {
                console.log("Login como 'compras' bem-sucedido.");
                userRole = 'gestor'; // Define a função do usuário como 'compras'
                showScreen('renatoApprovalScreen');
                renderPendingRenatoApprovalList();
            }
            else {
                console.log("Tentativa de login falhou. Usuário ou senha inválidos.");
                // Mensagem genérica para login incorreto
                showMessage('Erro de Login', 'Utilizador ou palavra-passe inválidos.', 'error');
            }
        }

        function openFilialSelectionModal() {
            document.getElementById('filialSelectionModal').classList.remove('hidden');
        }

        function closeFilialSelectionModal() {
            document.getElementById('filialSelectionModal').classList.add('hidden');
        }

        function selectFilial(filial) {
            selectedFilial = filial;
            closeFilialSelectionModal(); // Fechar o modal primeiro
            if (filial === 'colombia') {
                showScreen('colombiaFormScreen');
                colombiaProducts = []; // Limpar produtos para nova solicitação
                renderColombiaProductList(); // Renderizar lista de produtos adicionados (vazia inicialmente)
                // Limpar inputs para formulário Colômbia
                document.getElementById('clientProductCodeCOL').value = '';
                document.getElementById('productCodeCOLDisplay').innerText = '--';
                document.getElementById('productDescriptionDisplayCOL').innerText = '--';
                document.getElementById('productStockCOL').innerText = '--';
                document.getElementById('productQuantityCOL').value = '1';
                document.getElementById('valorUnitCOLDisplay').innerText = 'R$ 0,00';
                document.getElementById('clientOrderNumberCOL').value = ''; // Limpar número do pedido do cliente
                switchTab('colombia', 'easy'); // Define a aba inicial como "Fácil"
            } else if (filial === 'hongkong') {
                showScreen('hongKongFormScreen');
                hongKongProducts = []; // Limpar produtos para nova solicitação
                renderHongKongProductList(); // Renderizar lista de produtos adicionados (vazia inicialmente)
                // Limpar inputs para formulário Hong Kong
                document.getElementById('clientProductCodeHK').value = '';
                document.getElementById('mappedProductCodeDisplayHK').innerText = '--';
                document.getElementById('productDescriptionDisplayHK').innerText = '--';
                document.getElementById('productQuantityHK').value = '1';
                document.getElementById('productValueHK').innerText = 'R$ 0,00';
                document.getElementById('totalM3DisplayHK').innerText = '0.00 m³';
                document.getElementById('moqLiveFeedbackHK').innerText = '';
                document.getElementById('clientOrderNumberHK').value = ''; // Limpar número do pedido do cliente
                switchTab('hongkong', 'easy'); // Define a aba inicial como "Fácil"
            }
        }

        // Função para alternar entre as abas "Pedido Manual" e "Pedido Fácil"
        function switchTab(filial, tabType) {
            let manualTabContent, easyTabContent, tabButtonsContainer;

            if (filial === 'hongkong') {
                manualTabContent = document.getElementById('hongKongManualOrderTab');
                easyTabContent = document.getElementById('hongKongEasyOrderTab');
                tabButtonsContainer = document.getElementById('hkTabButtons');
            } else { // colombia
                manualTabContent = document.getElementById('colombiaManualOrderTab');
                easyTabContent = document.getElementById('colombiaEasyOrderTab');
                tabButtonsContainer = document.getElementById('colTabButtons');
            }

            // Esconde todo o conteúdo da aba primeiro
            manualTabContent.classList.add('hidden');
            easyTabContent.classList.add('hidden');

            // Remove a classe 'active' de todos os botões de aba
            Array.from(tabButtonsContainer.children).forEach(button => {
                button.classList.remove('active');
            });

            // Mostra o conteúdo da aba selecionada e adiciona a classe 'active' ao botão
            if (tabType === 'easy') { // Ordem invertida: 'easy' é o primeiro (índice 0)
                easyTabContent.classList.remove('hidden');
                tabButtonsContainer.children[0].classList.add('active');
            } else if (tabType === 'manual') { // 'manual' é o segundo (índice 1)
                manualTabContent.classList.remove('hidden');
                tabButtonsContainer.children[1].classList.add('active');
            }
        }

        // Function to switch tabs in Purchasing Center
        function switchPurchasingTab(tabType) {
            const novasSolicitacoesTab = document.getElementById('novasSolicitacoesTab');
            const negociacoesEmAndamentoTab = document.getElementById('negociacoesEmAndamentoTab'); // NEW
            const renatoActionsTab = document.getElementById('renatoActionsTab');
            const aprovadoGerenciaTab = document.getElementById('aprovadoGerenciaTab'); // NEW TAB

            const tabButtonsContainer = document.getElementById('purchasingTabButtons');

            // Hide all tab contents
            novasSolicitacoesTab.classList.add('hidden');
            negociacoesEmAndamentoTab.classList.add('hidden');
            renatoActionsTab.classList.add('hidden');
            aprovadoGerenciaTab.classList.add('hidden'); // Hide new tab

            // Remove active class from all tab buttons
            Array.from(tabButtonsContainer.children).forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab content and add active class to button
            if (tabType === 'novasSolicitacoes') {
                novasSolicitacoesTab.classList.remove('hidden');
                tabButtonsContainer.children[0].classList.add('active');
            } else if (tabType === 'negociacoesEmAndamento') {
                negociacoesEmAndamentoTab.classList.remove('hidden');
                tabButtonsContainer.children[1].classList.add('active');
            }
            else if (tabType === 'renatoActions') {
                renatoActionsTab.classList.remove('hidden');
                tabButtonsContainer.children[2].classList.add('active');
            } else if (tabType === 'aprovadoGerencia') { // NEW TAB logic
                aprovadoGerenciaTab.classList.remove('hidden');
                tabButtonsContainer.children[3].classList.add('active'); // Index 3 for the new tab
            }
            renderPurchasingCenterTables(); // Re-render tables after switching tabs
        }

        // Função para voltar para a Central de Pedidos a partir da seleção de filial ou formulários
        function backToOrderCenter() {
            showScreen('orderCenterScreen');
            renderOrdersTable(); // Re-renderizar a tabela para garantir o estado atualizado
        }

        function backToFilialSelectionFromForm() {
            // Este botão está nos formulários de solicitação, então ele deve abrir o modal novamente
            openFilialSelectionModal();
            // Opcionalmente, limpar os produtos do formulário aqui se o usuário "voltar" para escolher outra filial
            if (currentScreen === 'hongKongFormScreen') {
                hongKongProducts = [];
                renderHongKongProductList();
            } else if (currentScreen === 'colombiaFormScreen') {
                colombiaProducts = [];
                renderColombiaProductList();
            }
            showScreen('orderCenterScreen'); // Esconder a tela do formulário
        }

        function backToProductEntry() { // Usado a partir do Resumo de Hong Kong
            showScreen('hongKongFormScreen');
            renderHongKongProductList(); // Re-renderizar a lista do carrinho
        }

        function backToPurchasingCenter() {
            currentPurchasingPO = null; // Clear the currently viewed PO
            showScreen('purchasingCenterScreen');
            // Re-render the correct tab based on which one was active before
            const activeTabButton = document.querySelector('#purchasingTabButtons .tab-button.active');
            if (activeTabButton) {
                switchPurchasingTab(activeTabButton.onclick.toString().match(/switchPurchasingTab\('(\w+)'\)/)[1]);
            } else {
                renderPurchasingCenterTables();
            }
        }

        // Function to close the product catalog modal
        function closeProductCatalogModal() {
            document.getElementById('productCatalogModal').classList.add('hidden');
        }

        // Função de Logout
        function logout() {
            // Redefinir todo o estado relevante para um logout completo
            selectedFilial = '';
            hongKongProducts = [];
            colombiaProducts = [];
            userRole = 'guest'; // Redefine a função do usuário para 'guest'
            // Limpar generatedPurchaseOrders completamente
            generatedPurchaseOrders = [
                // Reset to initial state for demonstration purposes
                // --- Novas Solicitações (Pendente) ---
                {
                    parentOrderId: 'SOL-001', id: 'PED-001', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-20',
                    products: [
                        { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 10, unitPrice: 150.00, currentInternalUnitPrice: 160.00, newSupplierUnitPrice: 155.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (10 * 155).toFixed(2), currentInternalPriceTotal: (10 * 160).toFixed(2), overallApprovalStatus: 'Pendente'
                },
                {
                    parentOrderId: 'SOL-014', id: 'PED-017', supplier: 'Fornecedor C', supplierCode: '44', date: '2025-06-30',
                    products: [
                        { code: 'PROD003', name: 'Fone Bluetooth Max', quantity: 20, unitPrice: 40.00, currentInternalUnitPrice: 48.00, newSupplierUnitPrice: 42.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (20 * 42).toFixed(2), currentInternalPriceTotal: (20 * 48).toFixed(2), overallApprovalStatus: 'Pendente'
                },

                // --- Negociações em Andamento (Negociado) ---
                {
                    parentOrderId: 'SOL-003', id: 'PED-005', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-24',
                    products: [
                        { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 2, unitPrice: 150.00, currentInternalUnitPrice: 158.00, newSupplierUnitPrice: 152.00, approvalStatus: 'Pendente' },
                        { code: 'PROD003', name: 'Fone Bluetooth Max', quantity: 3, unitPrice: 45.00, currentInternalUnitPrice: 48.00, newSupplierUnitPrice: 46.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (2 * 152 + 3 * 46).toFixed(2), currentInternalPriceTotal: (2 * 158 + 3 * 48).toFixed(2), overallApprovalStatus: 'Negociado' // Changed to Negociado
                },
                {
                    parentOrderId: 'SOL-015', id: 'PED-018', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-29',
                    products: [
                        { code: 'PROD004', name: 'Smartwatch Sport Y', quantity: 5, unitPrice: 80.00, currentInternalUnitPrice: 85.00, newSupplierUnitPrice: 82.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (5 * 82).toFixed(2), currentInternalPriceTotal: (5 * 85).toFixed(2), overallApprovalStatus: 'Negociado'
                },

                // --- Aguardando Gerencia (Aguardando Aprovação) ---
                {
                    parentOrderId: 'SOL-008', id: 'PED-015', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-29',
                    products: [
                        { code: 'PROD001', name: 'Smartphone Premium X1', quantity: 5, unitPrice: 150.00, currentInternalUnitPrice: 158.00, newSupplierUnitPrice: 152.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (5 * 152).toFixed(2), currentInternalPriceTotal: (5 * 158).toFixed(2), overallApprovalStatus: 'Aguardando Aprovação' // Changed
                },
                {
                    parentOrderId: 'SOL-008', id: 'PED-016', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-29',
                    products: [
                        { code: 'PROD002', name: 'Tablet Pro Z', quantity: 2, unitPrice: 250.00, currentInternalUnitPrice: 260.00, newSupplierUnitPrice: 255.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (2 * 255).toFixed(2), currentInternalPriceTotal: (2 * 260).toFixed(2), overallApprovalStatus: 'Aguardando Aprovação' // Changed
                },
                {
                    parentOrderId: 'SOL-016', id: 'PED-019', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-30',
                    products: [
                        { code: 'PROD005', name: 'Câmera Digital Ultra HD', quantity: 1, unitPrice: 300.00, currentInternalUnitPrice: 320.00, newSupplierUnitPrice: 310.00, approvalStatus: 'Pendente' }
                    ],
                    newSupplierPriceTotal: (1 * 310).toFixed(2), currentInternalPriceTotal: (1 * 320).toFixed(2), overallApprovalStatus: 'Aguardando Aprovação'
                },


                // --- Aprovado Gerencia (Aprovado) ---
                {
                    parentOrderId: 'SOL-005', id: 'PED-010', supplier: 'Fornecedor C', supplierCode: '44', date: '2025-06-26',
                    products: [
                        { code: 'PROD005', name: 'Câmera Digital Ultra HD', quantity: 3, unitPrice: 320.00, currentInternalUnitPrice: 335.00, newSupplierUnitPrice: 320.00, approvalStatus: 'Aprovado' }
                    ],
                    newSupplierPriceTotal: (3 * 320).toFixed(2), currentInternalPriceTotal: (3 * 335).toFixed(2), overallApprovalStatus: 'Aprovado' // Changed
                },
                {
                    parentOrderId: 'SOL-009', id: 'PED-002', supplier: 'Fornecedor B', supplierCode: '33', date: '2025-06-21',
                    products: [
                        { code: 'PROD007', name: 'Cadeira Ergonômica', quantity: 2, unitPrice: 600.00, currentInternalUnitPrice: 630.00, newSupplierUnitPrice: 600.00, approvalStatus: 'Aprovado' }
                    ],
                    newSupplierPriceTotal: (2 * 600).toFixed(2), currentInternalPriceTotal: (2 * 630).toFixed(2), overallApprovalStatus: 'Aprovado' // Changed
                },

                // --- Finalizado (Para simular POs completas no fluxo de Compras) ---
                {
                    parentOrderId: 'SOL-017', id: 'PED-020', supplier: 'Fornecedor A', supplierCode: '22', date: '2025-06-25',
                    products: [
                        { code: 'PROD006', name: 'Bateria Portátil Mega', quantity: 15, unitPrice: 20.00, currentInternalUnitPrice: 28.00, newSupplierUnitPrice: 22.00, approvalStatus: 'Aprovado' }
                    ],
                    newSupplierPriceTotal: (15 * 22).toFixed(2), currentInternalPriceTotal: (15 * 28).toFixed(2), overallApprovalStatus: 'Finalizado'
                },
            ];

            simulatedSupplierOrders = {}; // Limpar os pedidos por fornecedor
            currentOrderDetails = null;
            currentViewingPO = null; // Reiniciar o PO em visualização
            currentPurchasingPO = null; // Reiniciar o PO de Compras
            
            // Re-initialize counters based on the original data + new generated orders
            const maxSolId = orders.reduce((max, order) => {
                const solNum = order.parentOrderId && typeof order.parentOrderId === 'string'
                               ? parseInt(order.parentOrderId.replace('SOL-', ''))
                               : 0;
                return isNaN(solNum) ? max : Math.max(max, solNum);
            }, 0);
            nextParentRequestCounter = maxSolId + 1;

            const maxPedId = orders.reduce((max, order) => {
                const pedNum = order.orderId && typeof order.orderId === 'string'
                               ? parseInt(order.orderId.replace('PED-', ''))
                               : 0;
                return isNaN(pedNum) ? max : Math.max(max, pedNum);
            }, 0);
            nextPurchaseOrderIdCounter = maxPedId + 1;

            currentParentOrderId = null; // Novo: Redefinir o ID do pedido pai

            // Limpar campos de entrada para todos os formulários
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            // HK
            if (document.getElementById('clientProductCodeHK')) document.getElementById('clientProductCodeHK').value = '';
            if (document.getElementById('mappedProductCodeDisplayHK')) document.getElementById('mappedProductCodeDisplayHK').innerText = '--';
            if (document.getElementById('productDescriptionDisplayHK')) document.getElementById('productDescriptionDisplayHK').innerText = '--';
            if (document.getElementById('productQuantityHK')) document.getElementById('productQuantityHK').value = '1';
            if (document.getElementById('productValueHK')) document.getElementById('productValueHK').innerText = 'R$ 0,00';
            if (document.getElementById('totalM3DisplayHK')) document.getElementById('totalM3DisplayHK').innerText = '0.00 m³';
            if (document.getElementById('moqLiveFeedbackHK')) document.getElementById('moqLiveFeedbackHK').innerText = '';
            if (document.getElementById('addProductMessageHK')) document.getElementById('addProductMessageHK').classList.add('hidden');
            if (document.getElementById('clientOrderNumberHK')) document.getElementById('clientOrderNumberHK').value = '';
            if (document.getElementById('pasteCodesHK')) document.getElementById('pasteCodesHK').value = ''; // Limpa textarea do Pedido Fácil
            if (document.getElementById('fileUploadHK')) document.getElementById('fileUploadHK').value = ''; // Limpa input file
            if (document.getElementById('fileNameDisplayHK')) document.getElementById('fileNameDisplayHK').innerText = 'Nenhum arquivo selecionado'; // Limpa exibição do nome do arquivo


            // COL
            if (document.getElementById('clientProductCodeCOL')) document.getElementById('clientProductCodeCOL').value = '';
            if (document.getElementById('productCodeCOLDisplay')) document.getElementById('productCodeCOLDisplay').innerText = '--';
            if (document.getElementById('productDescriptionDisplayCOL')) document.getElementById('productDescriptionDisplayCOL').innerText = '--';
            if (document.getElementById('productStockCOL')) document.getElementById('productStockCOL').innerText = '--';
            if (document.getElementById('productStockCOL')) document.getElementById('productStockCOL').style.color = '';
            if (document.getElementById('productQuantityCOL')) document.getElementById('productQuantityCOL').value = '1';
            if (document.getElementById('valorUnitCOLDisplay')) document.getElementById('valorUnitCOLDisplay').innerText = 'R$ 0,00';
            if (document.getElementById('addProductMessageCOL')) document.getElementById('addProductMessageCOL').classList.add('hidden');
            if (document.getElementById('clientOrderNumberCOL')) document.getElementById('clientOrderNumberCOL').value = '';
            if (document.getElementById('pasteCodesCOL')) document.getElementById('pasteCodesCOL').value = ''; // Limpa textarea do Pedido Fácil
            if (document.getElementById('fileUploadCOL')) document.getElementById('fileUploadCOL').value = ''; // Limpa input file
            if (document.getElementById('fileNameDisplayCOL')) document.getElementById('fileNameDisplayCOL').innerText = 'Nenhum arquivo selecionado'; // Limpa exibição do nome do arquivo


            closeFilialSelectionModal(); // Garantir que o modal esteja oculto no logout
            closeProductCatalogModal(); // Garantir que o modal do catálogo esteja oculto no logout
            showScreen('loginScreen');
        }

        function restartFlow() {
            // Redefinir todo o estado relevante para um reinício completo
            logout(); // Reutilizar a função de logout, pois ela executa a mesma redefinição de estado
        }

        // --- Lógica da Central de Pedidos ---
        function populateSupplierFilter() {
            const supplierFilterSelect = document.getElementById('supplierFilter');
            supplierFilterSelect.innerHTML = '<option value="">Todos</option>'; // Limpa as opções existentes

            const uniqueSuppliers = new Set();
            orders.forEach(order => {
                if (order.supplier) {
                    uniqueSuppliers.add(order.supplier);
                }
            });

            // Adiciona fornecedores por seus códigos e exibe apenas o código
            // Classifica os fornecedores por seu código numérico para exibição consistente
            const sortedSupplierCodes = Array.from(Object.keys(supplierNameMap)).sort((a, b) => parseInt(a) - parseInt(b));
            
            sortedSupplierCodes.forEach(supplierCode => {
                const option = document.createElement('option');
                option.value = supplierCode; // O valor é o código
                option.innerText = `${supplierCode}`; // Exibe APENAS o código
                supplierFilterSelect.appendChild(option);
            });
        }

        function populateOriginCountryFilter() {
            const originCountryFilterSelect = document.getElementById('originCountryFilter');
            originCountryFilterSelect.innerHTML = '<option value="">Todos</option>'; // Limpa as opções existentes

            const uniqueCountries = new Set();
            orders.forEach(order => {
                if (order.originCountry) {
                    uniqueCountries.add(order.originCountry);
                }
            });

            Array.from(uniqueCountries).sort().forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.innerText = country;
                originCountryFilterSelect.appendChild(option);
            });
        }


        function renderOrdersTable() {
            const tbody = document.querySelector('#orderCenterTable tbody');
            tbody.innerHTML = ''; // Limpa o corpo da tabela

            const statusFilter = document.getElementById('statusFilter').value;
            const supplierFilterCode = document.getElementById('supplierFilter').value; // Obtém o código do filtro de fornecedor
            const originCountryFilter = document.getElementById('originCountryFilter').value; // Obtém o filtro do país de origem
            const orderSearchQuery = document.getElementById('orderSearch').value.toLowerCase();

            const getFlagImage = (country) => {
                if (country === undefined || country === null || typeof country !== 'string') {
                    return '<span class="flag-icon">🚩</span>'; // Retorna uma bandeira padrão se o país for inválido
                }
                switch(country.toLowerCase()) {
                    case 'colômbia':
                        return '<img src="https://e7.pngegg.com/pngimages/796/10/png-clipart-flag-of-colombia-flag-of-cambodia-colombia-flag-flag-sphere-thumbnail.png" alt="Bandeira da Colômbia" class="flag-icon">';
                    case 'hong kong':
                        // Usando a bandeira da China como um placeholder para Hong Kong
                        return '<img src="https://e7.pngegg.com/pngimages/630/750/png-clipart-flag-of-china-association-of-southeast-asian-nations-national-flag-asean%E3%81%AE%E7%B4%8B%E7%AB%A0-china-orange-world-thumbnail.png" alt="Bandeira de Hong Kong" class="flag-icon">';
                    default:
                        return '<span class="flag-icon">🚩</span>'; // Bandeira padrão para países desconhecidos
                }
            };

            let filteredOrders = orders.filter(order => {
                const matchesStatus = statusFilter === '' || order.status === statusFilter;
                // Filtra por código de fornecedor, convertendo o nome do fornecedor do pedido para seu código
                const matchesSupplier = supplierFilterCode === '' || getOrGenerateSupplierCode(order.supplier) === supplierFilterCode; 
                const matchesOriginCountry = originCountryFilter === '' || order.originCountry === originCountryFilter; // Nova condição de filtro
                const matchesSearch = orderSearchQuery === '' ||
                                      order.orderId.toLowerCase().includes(orderSearchQuery) ||
                                      (order.parentOrderId && order.parentOrderId.toLowerCase().includes(orderSearchQuery)) || // Inclui busca pelo ID pai
                                      order.clientFlag.toLowerCase().includes(orderSearchQuery);
                return matchesStatus && matchesSupplier && matchesOriginCountry && matchesSearch; // Combina todos os filtros
            });

            // Sort the filtered orders by parentOrderId in ascending order
            filteredOrders.sort((a, b) => {
                // Extrai o número do ID (ex: "SOL-001" -> 1)
                const idA = (a.parentOrderId && typeof a.parentOrderId === 'string') ? parseInt(a.parentOrderId.replace('SOL-', '')) : 0;
                const idB = (b.parentOrderId && typeof b.parentOrderId === 'string') ? parseInt(b.parentOrderId.replace('SOL-', '')) : 0;
                return idA - idB; // Ordena crescentemente
            });


            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                
                let statusIndicatorClass = '';
                // Lógica para definir a cor do indicador de status na Central de Pedidos
                switch (order.status) {
                    case 'Aprovado':
                    case 'Carga Pronta':
                    case 'Documentação OK':
                    case 'Chegada no Porto de Destino (ATA)':
                    case 'Entregue': // Colômbia
                    case 'Negociado': // New status for Compras
                    case 'Finalizado': // New: Compras finalized
                    case 'Em Produção': // After approval, it's green in the client view
                        statusIndicatorClass = 'green';
                        break;
                    case 'Pendente':
                    case 'Aguardando Aprovação':
                    case 'Em Negociação':
                    case 'Documentação Pendente':
                        statusIndicatorClass = 'yellow';
                        break;
                    case 'Rejeitado':
                        statusIndicatorClass = 'red';
                        break;
                    case 'Saída do Porto de Embarque (ATD)':
                    case 'Em Separação': // Colômbia
                    case 'Em Conferência': // Colômbia
                    case 'Em Rota de Entrega': // Colômbia
                        statusIndicatorClass = 'blue';
                        break;
                    case 'Cancelado':
                        statusIndicatorClass = 'gray';
                        break;
                    default:
                        statusIndicatorClass = 'yellow'; // Fallback
                }

                const flagImageHtml = getFlagImage(order.originCountry);
                // Exibe apenas o código numérico do fornecedor para usuários cliente
                const displaySupplierInfo = userRole === 'client' && order.supplier
                    ? getOrGenerateSupplierCode(order.supplier)
                    : (order.supplier || 'N/A');


                row.innerHTML = `
                    <td>${order.parentOrderId ? order.parentOrderId : 'N/A'}</td> <!-- ID Solicitação Principal em primeiro, renomeado para 'Id' -->
                    <td><a href="#" class="order-link" onclick="viewOrderDetails('${order.orderId}')">${order.orderId}</a></td> <!-- Link agora no Nº Pedido -->
                    <td>${flagImageHtml}</td>
                    <td>${order.originCountry}</td>
                    <td>${displaySupplierInfo}</td> <!-- Exibe apenas o código do fornecedor para cliente -->
                    <td>R$ ${(order.totalValue || 0).toFixed(2).replace('.', ',')}</td>
                    <td><span class="status-indicator ${statusIndicatorClass}"></span>${order.status}</td>
                    <td>${order.requestDate}</td>
                    <td>${order.lastUpdateDate}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewOrderDetails(orderId) {
            currentOrderDetails = orders.find(order => order.orderId === orderId);
            if (!currentOrderDetails) {
                showMessage('Erro', 'Detalhes do pedido não encontrados.', 'error');
                return;
            }

            document.getElementById('currentOrderId').innerText = currentOrderDetails.orderId;
            document.getElementById('detailOrderId').innerText = currentOrderDetails.orderId;
            document.getElementById('detailParentOrderId').innerText = currentOrderDetails.parentOrderId ? currentOrderDetails.parentOrderId : 'N/A'; // Exibe o ID Principal

            // Constrói o display da origem com bandeira e nome do país
            const getFlagImageForDetails = (country) => {
                if (country === undefined || country === null || typeof country !== 'string') {
                    return '<span class="mr-2 flag-icon">🚩</span>'; // Retorna uma bandeira padrão se o país for inválido
                }
                switch(country.toLowerCase()) {
                    case 'colômbia':
                        return '<img src="https://e7.pngegg.com/pngimages/796/10/png-clipart-flag-of-colombia-flag-of-cambodia-colombia-flag-flag-sphere-thumbnail.png" alt="Bandeira da Colômbia" class="flag-icon inline-block mr-2">';
                    case 'hong kong':
                        return '<img src="https://e7.pngegg.com/pngimages/630/750/png-clipart-flag-of-china-association-of-southeast-asian-nations-national-flag-asean%E3%81%AE%E7%B4%8B%E7%AB%A0-china-orange-world-thumbnail.png" alt="Bandeira de Hong Kong" class="flag-icon inline-block mr-2">';
                    default:
                        return '<span class="mr-2 flag-icon">🚩</span>'; // Bandeira padrão
                }
            };
            document.getElementById('detailOriginDisplay').innerHTML = `${getFlagImageForDetails(currentOrderDetails.originCountry)}${currentOrderDetails.originCountry}`;


            // Exibe apenas o código do fornecedor para usuários cliente
            const detailSupplierElement = document.getElementById('detailSupplier');
            detailSupplierElement.innerText = userRole === 'client' && currentOrderDetails.supplier
                ? getOrGenerateSupplierCode(currentOrderDetails.supplier)
                : (currentOrderDetails.supplier || 'N/A');


            document.getElementById('detailTotalValue').innerText = `R$ ${currentOrderDetails.totalValue.toFixed(2).replace('.', ',')}`;
            document.getElementById('detailStatus').innerText = currentOrderDetails.status; // Ainda exibe o status direto

            const productsTableBody = document.getElementById('orderDetailsProductsTableBody');
            productsTableBody.innerHTML = ''; // Limpa as linhas existentes

            currentOrderDetails.products.forEach(product => {
                const row = document.createElement('tr');
                const itemTotalPrice = (product.quantity * product.unitPrice).toFixed(2);
                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.description}</td>
                    <td>${product.quantity}</td>
                    <td>R$ ${product.unitPrice.toFixed(2).replace('.', ',')}</td>
                    <td>R$ ${itemTotalPrice.replace('.', ',')}</td>
                `;
                productsTableBody.appendChild(row);
            });

            // Renderiza a seção de tracking
            renderTracking(currentOrderDetails);

            showScreen('orderDetailsScreen');
        }

        // --- Lógica de Tracking ---
        const hongKongTrackingFlow = [
            { name: 'Pendente', class: 'pending', description: 'Pedido criado, aguardando Compras Internacionais iniciar o processo.' },
            { name: 'Em Negociação', class: 'negotiation', description: 'Pedido enviado ao fornecedor, aguardando negociação' },
            { name: 'Aguardando Aprovação', class: 'waiting-approval', description: 'Pedido recebido, Aguardando aprovação da Gerencia' },
            { name: 'Rejeitado', class: 'rejected', description: 'Pedido Rejeitado', isFinal: true }, 
            { name: 'Cancelado', class: 'cancelled', description: 'Pedido Cancelado', isFinal: true },
            { name: 'Aprovado', class: 'approved', description: 'Pedido Aprovado (via retorno da Gerência)' }, // Outcome of approval
            { name: 'Em Produção', class: 'production', description: 'Pedido Aprovado, em produção pelo fornecedor' },
            { name: 'Carga Pronta', class: 'ready-cargo', description: 'Mercadoria pronta para embarque' },
            { name: 'Saída do Porto de Embarque (ATD)', class: 'atd', description: 'Pedido embarcado' },
            { name: 'Documentação Pendente', class: 'pending-doc', description: 'Providenciando documentação de embarque (CI, PL, TELEX RELEASE, COO, Serial Numbers, conforme necessidade do cliente)' },
            { name: 'Documentação OK', class: 'doc-ok', description: 'Toda documentação de embarque ok, processo finalizado no DIMPEX' },
            { name: 'Chegada no Porto de Destino (ATA)', class: 'ata', description: 'Navio atracado no porto de destino', isFinal: true }, // Terminal successful state
            { name: 'Finalizado', class: 'finished', description: 'Processo de Compras finalizado, aguardando faturamento.', isFinal: true } // NEW: Final state after Compras completes
        ];

        const colombiaTrackingFlow = [
            { name: 'Pendente', class: 'pending' },
            { name: 'Em Separação', class: 'separation' },
            { name: 'Em Conferência', class: 'conference' },
            { name: 'Em Rota de Entrega', class: 'in-transit' },
            { name: 'Entregue', class: 'delivered', isFinal: true }, // Entregue é o final do fluxo Colômbia
            { name: 'Aprovado', class: 'approved' }, // Aprovado pode ser pós-entrega, se o ERP aprova o faturamento
            { name: 'Rejeitado', class: 'rejected', isFinal: true },
            { name: 'Cancelado', class: 'cancelled', isFinal: true }
        ];

        function renderTracking(order) {
            const trackingSection = document.getElementById('orderTrackingSection');
            trackingSection.innerHTML = ''; // Limpa a seção de tracking

            let flow = [];
            if (order.originCountry === 'Hong Kong') {
                flow = hongKongTrackingFlow;
            } else if (order.originCountry === 'Colômbia') {
                flow = colombiaTrackingFlow;
            } else {
                trackingSection.innerHTML = '<p class="text-gray-500 text-center">Rastreamento não disponível para esta origem.</p>';
                return;
            }

            // Encontra o índice do status atual no fluxo
            let currentStatusIndex = flow.findIndex(step => step.name === order.status);

            // Se o status atual for um estado final (Rejeitado/Cancelado), garanta que ele seja o único 'active'
            // e todos os anteriores sejam 'completed' no display.
            const isTerminalStatus = ['Rejeitado', 'Cancelado', 'Finalizado', 'Entregue'].includes(order.status); // Added 'Finalizado' and 'Entregue'
            
            let trackingHtml = '<div class="tracking-steps">';

            flow.forEach((step, index) => {
                let stepClass = '';
                let circleContent = '';

                if (isTerminalStatus) {
                    // If it's a terminal status, mark previous steps up to the terminal as completed,
                    // the terminal step as active, and all subsequent steps as future.
                    if (index < currentStatusIndex) {
                        stepClass = 'completed';
                    } else if (index === currentStatusIndex) {
                        stepClass = 'active';
                    } else {
                        stepClass = 'future';
                    }
                } else {
                    // For non-terminal statuses, normal linear progression
                    if (index < currentStatusIndex) {
                        stepClass = 'completed';
                    } else if (index === currentStatusIndex) {
                        stepClass = 'active';
                    } else {
                        stepClass = 'future';
                    }
                }
                
                // Apply the specific color class if the step is completed or active
                if (stepClass === 'completed' || stepClass === 'active') {
                    if (step.class) {
                        stepClass += ` ${step.class}`;
                    }
                }

                // Circle content
                if (stepClass.includes('completed')) { // If the step is completed
                    circleContent = '&#10003;'; // Checkmark
                } else if (stepClass.includes('active')) { // If it's the active step
                    circleContent = (index + 1).toString(); // Step number
                }

                trackingHtml += `
                    <div class="tracking-step ${stepClass}">
                        <div class="circle">${circleContent}</div>
                        <span>${step.name}</span>
                    </div>
                `;
            });
            trackingHtml += '</div>';
            trackingSection.innerHTML = trackingHtml;
        }


        // --- Lógica do Fluxo de Hong Kong ---
        function updateProductDetailsOnClientCodeChangeHK() {
            const clientProductCodeInput = document.getElementById('clientProductCodeHK').value.trim().toUpperCase();
            const mappedProductCodeDisplay = document.getElementById('mappedProductCodeDisplayHK');
            const productDescriptionDisplay = document.getElementById('productDescriptionDisplayHK');
            const productValueDisplay = document.getElementById('productValueHK');
            const totalM3Display = document.getElementById('totalM3DisplayHK');
            const moqLiveFeedbackDiv = document.getElementById('moqLiveFeedbackHK');

            // Reseta os campos de exibição
            mappedProductCodeDisplay.innerText = '--';
            productDescriptionDisplay.innerText = '--';
            productValueDisplay.innerText = 'R$ 0,00';
            totalM3Display.innerText = '0.00 m³';
            moqLiveFeedbackDiv.innerText = '';
            moqLiveFeedbackDiv.className = 'text-xs mt-1';

            // Usa o mapa universal para busca de código de cliente para código de produto
            const productCode = universalClientCodeToProductCodeMap[clientProductCodeInput];
            const productInfo = productDatabase[productCode];

            if (productInfo) {
                mappedProductCodeDisplay.innerText = productCode; // Exibe o código PROD
                productDescriptionDisplay.innerText = `${productInfo.description}`;
                productDescriptionDisplay.style.color = '#374151';
                productValueDisplay.innerText = `R$ ${productInfo.tableValue.toFixed(2).replace('.', ',')}`;
                
                calculateTotalM3HK();
                checkMoqLiveHK();
            } else {
                productDescriptionDisplay.innerText = 'Cód Prod Cliente não encontrado.';
                productDescriptionDisplay.style.color = '#dc2626';
            }
        }

        function calculateTotalM3HK() {
            const clientProductCode = document.getElementById('clientProductCodeHK').value.trim().toUpperCase();
            const productCode = universalClientCodeToProductCodeMap[clientProductCode];
            const productInfo = productDatabase[productCode];
            const quantity = parseInt(document.getElementById('productQuantityHK').value);
            const totalM3Display = document.getElementById('totalM3DisplayHK');

            if (productInfo && !isNaN(quantity) && quantity > 0) {
                const totalM3 = productInfo.cubageUnit * quantity;
                totalM3Display.innerText = `${totalM3.toFixed(2).replace('.', ',')} m³`;
            } else {
                totalM3Display.innerText = '0.00 m³';
            }
        }

        function checkMoqLiveHK() {
            const clientProductCode = document.getElementById('clientProductCodeHK').value.trim().toUpperCase();
            const productCode = universalClientCodeToProductCodeMap[clientProductCode];
            const productQuantity = parseInt(document.getElementById('productQuantityHK').value);
            const moqFeedbackDiv = document.getElementById('moqLiveFeedbackHK');

            const productInfo = productDatabase[productCode];

            if (!productInfo) {
                moqFeedbackDiv.innerText = 'Por favor, insira um código de produto válido.';
                moqFeedbackDiv.className = 'moq-feedback-error';
                return;
            }

            if (isNaN(productQuantity) || productQuantity <= 0) {
                moqFeedbackDiv.innerText = '';
                moqFeedbackDiv.className = 'text-xs mt-1';
                return;
            }

            const moq = productInfo.moq;

            if (productQuantity < moq) {
                moqFeedbackDiv.innerText = `⚠️ Quantidade (${productQuantity}) abaixo do MOQ mínimo (${moq}). Este item será cancelado se não for ajustado.`;
                moqFeedbackDiv.className = 'moq-feedback-error';
            } else {
                moqFeedbackDiv.innerText = `✅ Quantidade (${productQuantity}) atende ao MOQ mínimo (${moq}).`;
                moqFeedbackDiv.className = 'moq-feedback-ok';
            }
        }

        function addProductHK() {
            const clientProductCode = document.getElementById('clientProductCodeHK').value.trim().toUpperCase();
            const productCode = universalClientCodeToProductCodeMap[clientProductCode];
            const quantity = parseInt(document.getElementById('productQuantityHK').value);
            const productInfo = productDatabase[productCode];

            if (!productInfo) {
                displayAddProductMessage('Erro: Código de produto cliente inválido.', 'error', 'hongkong');
                return;
            }

            if (isNaN(quantity) || quantity <= 0) {
                displayAddProductMessage('Erro: Por favor, insira uma quantidade válida para o produto.', 'error', 'hongkong');
                return;
            }

            if (quantity < productInfo.moq) {
                displayAddProductMessage(`Erro: Quantidade (${quantity}) abaixo do MOQ mínimo (${productInfo.moq}).`, 'error', 'hongkong');
                return;
            }

            // Calcula M3 total para o produto adicionado
            const totalM3 = (productInfo.cubageUnit * quantity).toFixed(2);
            // Calcula o valor total para o produto adicionado (usando tableValue para exibição)
            const totalValue = (productInfo.tableValue * quantity).toFixed(2);


            // Verifica se o produto já está na lista, se sim, atualiza a quantidade e M3
            const existingProductIndex = hongKongProducts.findIndex(p => p.code === productCode);
            if (existingProductIndex > -1) {
                hongKongProducts[existingProductIndex].quantity += quantity;
                hongKongProducts[existingProductIndex].totalM3 = (parseFloat(hongKongProducts[existingProductIndex].totalM3) + parseFloat(totalM3)).toFixed(2);
                hongKongProducts[existingProductIndex].totalValue = (parseFloat(hongKongProducts[existingProductIndex].totalValue) + parseFloat(totalValue)).toFixed(2);
                displayAddProductMessage(`Quantidade de "${productInfo.description}" atualizada para ${hongKongProducts[existingProductIndex].quantity}.`, 'success', 'hongkong');
            } else {
                hongKongProducts.push({
                    clientCode: clientProductCode, // Este é o código SKU
                    code: productCode, // Este é o código PROD
                    name: productInfo.description,
                    quantity: quantity,
                    moq: productInfo.moq,
                    unitPrice: productInfo.unitPrice, // Este é o preço unitário de aquisição
                    tableValue: productInfo.tableValue, // Este é o preço da tabela para exibição
                    cubageUnit: productInfo.cubageUnit,
                    totalM3: totalM3,
                    totalValue: totalValue,
                    supplier: productInfo.supplier // Adiciona o fornecedor do produto
                });
                displayAddProductMessage(`"${productInfo.description}" adicionado com sucesso.`, 'success', 'hongkong');
            }

            renderHongKongProductList();
            // Limpa os campos de entrada após adicionar
            document.getElementById('clientProductCodeHK').value = '';
            document.getElementById('mappedProductCodeDisplayHK').innerText = '--';
            document.getElementById('productDescriptionDisplayHK').innerText = '--';
            document.getElementById('productQuantityHK').value = '1';
            document.getElementById('productValueHK').innerText = 'R$ 0,00';
            document.getElementById('totalM3DisplayHK').innerText = '0.00 m³';
            document.getElementById('moqLiveFeedbackHK').innerText = '';
        }

        function removeProductHK(index) {
            hongKongProducts.splice(index, 1);
            renderHongKongProductList();
            displayAddProductMessage('Produto removido.', 'info', 'hongkong');
        }

        function renderHongKongProductList() {
            const listDiv = document.getElementById('productListHK');
            listDiv.innerHTML = '<h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados na Solicitação:</h3>';
            if (hongKongProducts.length === 0) {
                listDiv.innerHTML += '<div id="noProductsAddedHK" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>';
                return;
            }

            // Cria uma tabela para os produtos adicionados
            let tableHtml = `<table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Cód Cliente</th>
                                        <th>Cód Produto</th>
                                        <th>Descrição</th>
                                        <th>Qtd. Solicitada</th>
                                        <th>Valor Unit.</th>
                                        <th>Valor Total</th>
                                        <th>M³ Total</th>
                                        <th>Fornecedor</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            hongKongProducts.forEach((product, index) => {
                // Para usuários 'client', exiba apenas o código do fornecedor
                const displaySupplierInfo = userRole === 'client' && product.supplier
                    ? getOrGenerateSupplierCode(product.supplier)
                    : (product.supplier || 'N/A');

                tableHtml += `
                    <tr>
                        <td>${product.clientCode}</td>
                        <td>${product.code}</td>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>R$ ${parseFloat(product.tableValue).toFixed(2).replace('.', ',')}</td>
                        <td>R$ ${parseFloat(product.totalValue).toFixed(2).replace('.', ',')}</td>
                        <td>${parseFloat(product.totalM3).toFixed(2).replace('.', ',')} m³</td>
                        <td>${displaySupplierInfo}</td> <!-- Exibe apenas o código do fornecedor para cliente -->
                        <td><button onclick="removeProductHK(${index})" class="text-red-500 hover:text-red-700 font-bold text-sm">Remover</button></td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            listDiv.innerHTML += tableHtml;
        }

        function submitHongKongForm() {
            if (hongKongProducts.length === 0) {
                showMessage('Erro', 'Por favor, adicione pelo menos um produto antes de enviar a solicitação.', 'error');
                return;
            }

            // Gera o ID da solicitação principal (SOL-XXX)
            currentParentOrderId = `SOL-${nextParentRequestCounter.toString().padStart(3, '0')}`;
            nextParentRequestCounter++; // Incrementa para a próxima solicitação

            let moqValidationResultDiv = document.getElementById('moqValidationResult');
            moqValidationResultDiv.innerHTML = '<h3 class="font-semibold text-gray-700 mb-2">Validação de MOQ:</h3>';

            let validProductsAfterMoq = [];
            let allItemsCancelled = true; // Assume que todos os itens serão cancelados inicialmente

            hongKongProducts.forEach(product => {
                if (product.quantity < product.moq) { // Usa product.moq das informações do produto armazenadas
                    moqValidationResultDiv.innerHTML += `<p class="error-message">🚫 O item "${product.name}" (Qtd: ${product.quantity}) não atende ao MOQ mínimo de ${product.moq}. Este item será cancelado do pedido.</p>`;
                } else {
                    moqValidationResultDiv.innerHTML += `<p class="text-green-700">✅ O item "${product.name}" (Qtd: ${product.quantity}) atende ao MOQ mínimo (${product.moq}).</p>`;
                    validProductsAfterMoq.push(product);
                    allItemsCancelled = false; // Se pelo menos um item for válido, define como falso
                }
            });

            hongKongProducts = validProductsAfterMoq; // Atualiza a lista global apenas com produtos válidos

            const hkSummaryButtonsDiv = document.getElementById('hkSummaryButtons');
            const generatePoButton = hkSummaryButtonsDiv.querySelector('button:last-child'); // O botão 'Salvar Solicitação'

            if (hongKongProducts.length === 0) { // Verifica o comprimento após a validação de MOQ para ver se há produtos válidos restantes
                moqValidationResultDiv.innerHTML += `<p class="error-message mt-4">Todos os itens foram cancelados devido à falha no MOQ. Por favor, utilize o botão "Voltar e Ajustar" para corrigir sua solicitação.</p>`;
                generatePoButton.classList.add('hidden'); // Esconde o botão de gerar PO
                showScreen('hongKongSummaryScreen');
                return; // Impede a continuação do fluxo se todos os itens foram cancelados
            } else {
                generatePoButton.classList.remove('hidden'); // Garante que o botão de gerar PO esteja visível
            }


            // Agrupar produtos por fornecedor
            simulatedSupplierOrders = hongKongProducts.reduce((acc, product) => {
                const supplierName = product.supplier;
                if (!acc[supplierName]) {
                    acc[supplierName] = {
                        id: `PED-${nextPurchaseOrderIdCounter.toString().padStart(3, '0')}`,
                        parentOrderId: currentParentOrderId, // Atribui o ID da solicitação pai
                        supplier: supplierName,
                        supplierCode: getOrGenerateSupplierCode(supplierName),
                        date: new Date().toISOString().slice(0, 10), // Data atual
                        products: [],
                        newSupplierPriceTotal: 0,
                        currentInternalPriceTotal: 0,
                        overallApprovalStatus: 'Pendente' // Status inicial para POs individuais
                    };
                    nextPurchaseOrderIdCounter++; // Incrementa o contador para o próximo PED-XXX
                }
                const productWithSimulatedPrices = { ...product }; // Cria uma cópia para não modificar o original
                
                // Simular um "currentInternalUnitPrice" para cada produto
                // O valor interno será o valor da tabela (tableValue) + um pequeno delta (entre 0 e 5)
                productWithSimulatedPrices.currentInternalUnitPrice = (product.tableValue + Math.random() * 5).toFixed(2);

                // Simular um "newSupplierUnitPrice" que é um pouco menor que o unitPrice original
                // Simula que o fornecedor externo sempre dará um preço melhor
                productWithSimulatedPrices.newSupplierUnitPrice = (product.unitPrice * (1 + (Math.random() * 0.05))).toFixed(2); // Ajuste de até 5% acima do preço de aquisição

                acc[supplierName].products.push(productWithSimulatedPrices);
                // Calcula o total de M3 e Valor Total para o resumo, usando o `newSupplierUnitPrice`
                acc[supplierName].newSupplierPriceTotal = (parseFloat(acc[supplierName].newSupplierPriceTotal) + (parseFloat(productWithSimulatedPrices.newSupplierUnitPrice) * product.quantity)).toFixed(2);
                acc[supplierName].currentInternalPriceTotal = (parseFloat(acc[supplierName].currentInternalPriceTotal) + (parseFloat(productWithSimulatedPrices.currentInternalUnitPrice) * product.quantity)).toFixed(2);

                return acc;
            }, {});

            renderSupplierSplitResult();
            showScreen('hongKongSummaryScreen');
        }

        // Simula o processamento do arquivo CSV e adiciona produtos
        function handleFileUpload(filial) {
            let fileInput;
            let pasteArea;
            if (filial === 'hongkong') {
                fileInput = document.getElementById('fileUploadHK');
                pasteArea = document.getElementById('pasteCodesHK');
            } else { // 'colombia'
                fileInput = document.getElementById('fileUploadCOL');
                pasteArea = document.getElementById('pasteCodesCOL');
            }

            const file = fileInput.files[0];
            if (!file) {
                displayAddProductMessage('Por favor, selecione um arquivo CSV.', 'error', filial);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                parseAndAddProducts(text, filial);
            };
            reader.readAsText(file);
        }

        function processPastedCodes(filial) {
            let pasteArea;
            if (filial === 'hongkong') {
                pasteArea = document.getElementById('pasteCodesHK');
            } else { // 'colombia'
                pasteArea = document.getElementById('pasteCodesCOL');
            }
            const text = pasteArea.value;
            if (!text.trim()) {
                displayAddProductMessage('Nenhum código para processar. Cole os códigos na caixa de texto.', 'error', filial);
                return;
            }
            parseAndAddProducts(text, filial);
        }

        // Função auxiliar para processar códigos (reutilizável para upload e colar)
        function parseAndAddProducts(text, filial) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            let productsAddedCount = 0;
            let productsSkippedCount = 0;
            const messages = [];

            lines.forEach(line => {
                const parts = line.split(',').map(part => part.trim());
                let clientCode, productCode, quantity;

                // Adaptação para diferentes formatos:
                // CODIGO_CLIENTE,CODIGO_PRODUTO,QUANTIDADE
                // CODIGO_UNICO,QUANTIDADE (onde CODIGO_UNICO pode ser clientCode ou productCode)
                if (parts.length === 3) {
                    clientCode = parts[0].toUpperCase();
                    productCode = parts[1].toUpperCase();
                    quantity = parseInt(parts[2]);
                } else if (parts.length === 2) {
                    const tempCode = parts[0].toUpperCase();
                    quantity = parseInt(parts[1]);

                    // Tenta mapear primeiro como clientCode, depois como productCode
                    if (universalClientCodeToProductCodeMap[tempCode]) {
                        clientCode = tempCode;
                        productCode = universalClientCodeToProductCodeMap[tempCode];
                    } else if (productDatabase[tempCode]) {
                        productCode = tempCode;
                        clientCode = productDatabase[tempCode].clientCode || ''; // Pega o clientCode se existir
                    } else {
                        messages.push(`Erro: Código "${tempCode}" não reconhecido.`);
                        productsSkippedCount++;
                        return;
                    }
                } else {
                    messages.push(`Erro: Formato de linha inválido: "${line}".`);
                    productsSkippedCount++;
                    return;
                }

                const productInfo = productDatabase[productCode];

                if (!productInfo) {
                    messages.push(`Erro: Produto com código "${productCode}" não encontrado.`);
                    productsSkippedCount++;
                    return;
                }

                if (isNaN(quantity) || quantity <= 0) {
                    messages.push(`Erro: Quantidade inválida para o produto "${productCode}".`);
                    productsSkippedCount++;
                    return;
                }

                // For Hong Kong, check MOQ. For Colombia, check simulated stock.
                if (filial === 'hongkong') {
                    if (quantity < productInfo.moq) {
                        messages.push(`Erro: Quantidade (${quantity}) para "${productInfo.description}" abaixo do MOQ mínimo (${productInfo.moq}). Este item será cancelado.`);
                        productsSkippedCount++;
                        return;
                    }
                } else if (filial === 'colombia') {
                    if (quantity > productInfo.simulatedStock) {
                        messages.push(`Erro: Quantidade (${quantity}) para "${productInfo.description}" excede o estoque disponível (${productInfo.simulatedStock}).`);
                        productsSkippedCount++;
                        return;
                    }
                }


                const totalM3 = (productInfo.cubageUnit * quantity).toFixed(2);
                const totalValue = (productInfo.tableValue * quantity).toFixed(2);

                let productList = (filial === 'hongkong') ? hongKongProducts : colombiaProducts;

                const existingProductIndex = productList.findIndex(p => p.code === productCode);
                if (existingProductIndex > -1) {
                    productList[existingProductIndex].quantity += quantity;
                    productList[existingProductIndex].totalM3 = (parseFloat(productList[existingProductIndex].totalM3) + parseFloat(totalM3)).toFixed(2);
                    productList[existingProductIndex].totalValue = (parseFloat(productList[existingProductIndex].totalValue) + parseFloat(totalValue)).toFixed(2);
                    messages.push(`Quantidade de "${productInfo.description}" atualizada para ${productList[existingProductIndex].quantity}.`);
                } else {
                    productList.push({
                        clientCode: clientCode,
                        code: productCode,
                        name: productInfo.description,
                        quantity: quantity,
                        moq: productInfo.moq,
                        unitPrice: productInfo.unitPrice,
                        tableValue: productInfo.tableValue,
                        cubageUnit: productInfo.cubageUnit,
                        totalM3: totalM3,
                        totalValue: totalValue,
                        supplier: productInfo.supplier,
                        simulatedStock: productInfo.simulatedStock // Add stock for Colombia
                    });
                    productsAddedCount++;
                }
            });

            if (filial === 'hongkong') {
                renderHongKongProductList();
            } else { // 'colombia'
                renderColombiaProductList();
            }

            let finalMessage = '';
            let messageType = 'info';
            if (productsAddedCount > 0) {
                finalMessage += `${productsAddedCount} produto(s) adicionado(s).`;
                messageType = 'success';
            }
            if (productsSkippedCount > 0) {
                finalMessage += ` ${productsSkippedCount} produto(s) ignorado(s) devido a erros.`;
                messageType = productsAddedCount > 0 ? 'info' : 'error'; // Se adicionou algo, é info, senão erro
            }
            if (messages.length > 0) {
                messages.forEach(msg => console.log(msg)); // Log all individual messages for debugging
            }
            displayAddProductMessage(finalMessage || 'Nenhum produto processado.', messageType, filial);
        }

        function displayFileName(fileInputId, fileNameDisplayId) {
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameDisplayId);
            if (fileInput.files.length > 0) {
                fileNameDisplay.innerText = fileInput.files[0].name;
            } else {
                fileNameDisplay.innerText = 'Nenhum arquivo selecionado';
            }
        }

        // Função para simular o download de um modelo de planilha
        function downloadSpreadsheetModel() {
            const csvContent = "data:text/csv;charset=utf-8,CODIGO_CLIENTE,CODIGO_PRODUTO,QUANTIDADE\nSKU-001,PROD001,10\nSKU-003,PROD003,5\nSKU-005,,2\n";
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "modelo_planilha_pedido.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link); // Clean up
            showMessage('Download', 'O download do modelo de planilha foi iniciado.', 'info');
        }


        function renderSupplierSplitResult() {
            const resultDiv = document.getElementById('supplierSplitResult');
            resultDiv.innerHTML = '<h2 class="text-2xl font-bold text-gray-800 mb-4">Divisão da Solicitação por Fornecedor (Requisições de Compra - POs)</h2>';

            for (const supplierName in simulatedSupplierOrders) {
                const po = simulatedSupplierOrders[supplierName];
                const poDiv = document.createElement('div');
                poDiv.className = 'bg-white p-6 rounded-lg shadow-md mb-6 border border-gray-200';

                // Calcula o custo total e a diferença percentual
                const totalExternalCost = parseFloat(po.newSupplierPriceTotal);
                const totalInternalCost = parseFloat(po.currentInternalPriceTotal);
                const absoluteDifference = totalExternalCost - totalInternalCost;
                const percentageDifference = ((totalInternalCost === 0) ? 0 : (absoluteDifference / totalInternalCost) * 100).toFixed(2); // Avoid division by zero
                
                let differenceClass = '';
                let differenceText = '';

                if (absoluteDifference > 0) {
                    differenceClass = 'price-difference-positive';
                    differenceText = `(+R$ ${absoluteDifference.toFixed(2).replace('.', ',')} / +${percentageDifference}%)`;
                } else if (absoluteDifference < 0) {
                    differenceClass = 'price-difference-negative';
                    differenceText = `(-R$ ${Math.abs(absoluteDifference).toFixed(2).replace('.', ',')} / ${percentageDifference}%)`;
                } else {
                    differenceClass = '';
                    differenceText = '(Sem diferença)';
                }


                poDiv.innerHTML = `
                    <h3 class="font-semibold text-lg mb-2">PO Nº ${po.id} para Fornecedor: <span class="text-blue-700">${po.supplierCode} - ${po.supplier}</span></h3>
                    <p class="text-gray-600 mb-1">ID Solicitação Principal: <strong>${po.parentOrderId}</strong></p>
                    <p class="text-gray-600 mb-1">Data Geração: ${po.date}</p>
                    <p class="text-gray-600 mb-1">Valor Total Custo Fornecedor (Estimado): <strong>R$ ${totalExternalCost.toFixed(2).replace('.', ',')}</strong></p>
                    <p class="text-gray-600 mb-4">Valor Total Custo Interno (Estimado): <strong>R$ ${totalInternalCost.toFixed(2).replace('.', ',')}</strong> <span class="${differenceClass}">${differenceText}</span></p>
                    <h4 class="font-semibold text-md mb-2">Produtos:</h4>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cód Produto</th>
                                    <th>Descrição</th>
                                    <th>Qtd.</th>
                                    <th>Valor Unit. Interno</th>
                                    <th>Valor Unit. Fornecedor (Atual)</th>
                                    <th>M³ Total Item</th>
                                    <th>Status Aprovação</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${po.products.map(p => `
                                    <tr>
                                        <td>${p.code}</td>
                                        <td>${p.name}</td>
                                        <td>${p.quantity}</td>
                                        <td>R$ ${parseFloat(p.currentInternalUnitPrice).toFixed(2).replace('.', ',')}</td>
                                        <td>R$ ${parseFloat(p.newSupplierUnitPrice).toFixed(2).replace('.', ',')}</td>
                                        <td>${(p.cubageUnit * p.quantity).toFixed(2).replace('.', ',')} m³</td>
                                        <td class="product-approval-status ${p.approvalStatus}">${p.approvalStatus}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                resultDiv.appendChild(poDiv);
            }
        }

        function generatePO() {
            if (Object.keys(simulatedSupplierOrders).length === 0) {
                showMessage('Erro', 'Nenhum pedido de compra para gerar.', 'error');
                return;
            }

            // Adiciona as POs geradas ao array global 'generatedPurchaseOrders'
            for (const supplierName in simulatedSupplierOrders) {
                const po = simulatedSupplierOrders[supplierName];
                // Verifica se já existe um pedido com o mesmo ID para evitar duplicação em simulações
                const existingPoIndex = generatedPurchaseOrders.findIndex(existingPo => existingPo.id === po.id);
                if (existingPoIndex === -1) {
                    generatedPurchaseOrders.push(po);
                } else {
                    // Update existing PO if it's regenerated (e.g., after adjustments)
                    generatedPurchaseOrders[existingPoIndex] = po;
                }
            }

            // Atualiza o status dos pedidos originais para "Aguardando Aprovação"
            // Isso precisa ser feito para cada orderId individual que faz parte do parentOrderId
            const clientOrderNumberHK = document.getElementById('clientOrderNumberHK').value.trim();

            hongKongProducts.forEach(product => {
                const orderToUpdate = orders.find(o => 
                    o.parentOrderId === currentParentOrderId && 
                    o.supplier === product.supplier &&
                    o.products.some(p => p.code === product.code) // Check if the product is part of this order
                );
                if (orderToUpdate) {
                    orderToUpdate.status = 'Aguardando Aprovação';
                    orderToUpdate.lastUpdateDate = new Date().toISOString().slice(0, 10);
                    // Adicionar o número do pedido do cliente, se houver
                    if (clientOrderNumberHK) {
                        orderToUpdate.clientOrderNumber = clientOrderNumberHK;
                    }
                    // Adicionar o cliente (prototipo)
                    orderToUpdate.clientFlag = currentUserClientName;
                }
            });


            // Exibe os detalhes da primeira PO gerada (apenas para simulação)
            const firstPoKey = Object.keys(simulatedSupplierOrders)[0];
            const firstPo = simulatedSupplierOrders[firstPoKey];

            const poDetailsDiv = document.getElementById('poDetails');
            poDetailsDiv.innerHTML = `
                <p class="font-semibold text-lg mb-2">PO Nº: <span class="text-blue-700">${firstPo.id}</span></p>
                <p class="mb-1">ID Solicitação Principal: <strong>${firstPo.parentOrderId}</strong></p>
                <p class="mb-1">Fornecedor: <strong>${firstPo.supplierCode} - ${firstPo.supplier}</strong></p>
                <p class="mb-1">Data Geração: <strong>${firstPo.date}</strong></p>
                <p class="mb-1">Valor Total Estimado: <strong>R$ ${firstPo.newSupplierPriceTotal.replace('.', ',')}</strong></p>
                <p class="mt-4">Detalhes completos disponíveis na Central de Compras.</p>
            `;

            showScreen('purchaseOrderScreen');
            // Reset hongKongProducts and simulatedSupplierOrders after generating PO
            hongKongProducts = [];
            simulatedSupplierOrders = {};

            // Synchronize after new POs are generated and orders are potentially updated
            synchronizeOrdersAndPOs();
        }

        // --- Lógica do Fluxo Colômbia ---
        function updateProductDetailsOnClientCodeChangeCOL() {
            const clientProductCodeInput = document.getElementById('clientProductCodeCOL').value.trim().toUpperCase();
            const productCodeDisplay = document.getElementById('productCodeCOLDisplay');
            const productDescriptionDisplay = document.getElementById('productDescriptionDisplayCOL');
            const productStockDisplay = document.getElementById('productStockCOL');
            const valorUnitDisplay = document.getElementById('valorUnitCOLDisplay');

            // Reseta os campos de exibição
            productCodeDisplay.innerText = '--';
            productDescriptionDisplay.innerText = '--';
            productStockDisplay.innerText = '--';
            productStockDisplay.style.color = ''; // Reset color
            valorUnitDisplay.innerText = 'R$ 0,00';

            // Usa o mapa universal para busca de código de cliente para código de produto
            const productCode = universalClientCodeToProductCodeMap[clientProductCodeInput];
            const productInfo = productDatabase[productCode];

            if (productInfo) {
                productCodeDisplay.innerText = productCode;
                productDescriptionDisplay.innerText = productInfo.description;
                productDescriptionDisplay.style.color = '#374151';
                productStockDisplay.innerText = productInfo.simulatedStock;
                valorUnitDisplay.innerText = `R$ ${productInfo.tableValue.toFixed(2).replace('.', ',')}`;

                // Altera a cor do estoque com base na quantidade
                if (productInfo.simulatedStock > 0) {
                    productStockDisplay.innerText = 'Sim';
                    productStockDisplay.style.color = '#16a34a'; // Verde para estoque ok
                } else {
                    productStockDisplay.innerText = 'Não';
                    productStockDisplay.style.color = '#dc2626'; // Vermelho para estoque zero
                }
            } else {
                productDescriptionDisplay.innerText = 'Cód Prod Cliente não encontrado.';
                productDescriptionDisplay.style.color = '#dc2626';
            }
        }

            function updateTotalValueCOL() {
            const clientProductCode = document.getElementById('clientProductCodeCOL').value.trim().toUpperCase();
            const productCode = universalClientCodeToProductCodeMap[clientProductCode];
            const productInfo = productDatabase[productCode];
            const quantity = parseInt(document.getElementById('productQuantityCOL').value);
            const valorTotalDisplay = document.getElementById('valorTotalCOLDisplay');
            if (productInfo && !isNaN(quantity) && quantity > 0) {
                const total = productInfo.tableValue * quantity;
                valorTotalDisplay.innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
            } else {
                valorTotalDisplay.innerText = 'R$ 0,00';            }        }


        function addProductCOL() {
            const clientProductCode = document.getElementById('clientProductCodeCOL').value.trim().toUpperCase();
            const productCode = universalClientCodeToProductCodeMap[clientProductCode];
            const quantity = parseInt(document.getElementById('productQuantityCOL').value);
            const productInfo = productDatabase[productCode];

            if (!productInfo) {
                displayAddProductMessage('Erro: Código de produto cliente inválido.', 'error', 'colombia');
                return;
            }

            if (isNaN(quantity) || quantity <= 0) {
                displayAddProductMessage('Erro: Por favor, insira uma quantidade válida para o produto.', 'error', 'colombia');
                return;
            }


            const totalValue = (productInfo.tableValue * quantity).toFixed(2);

            const existingProductIndex = colombiaProducts.findIndex(p => p.code === productCode);
            if (existingProductIndex > -1) {
                colombiaProducts[existingProductIndex].quantity += quantity;
                colombiaProducts[existingProductIndex].totalValue = (parseFloat(colombiaProducts[existingProductIndex].totalValue) + parseFloat(totalValue)).toFixed(2);
                displayAddProductMessage(`Quantidade de "${productInfo.description}" atualizada para ${colombiaProducts[existingProductIndex].quantity}.`, 'success', 'colombia');
            } else {
                colombiaProducts.push({
                    clientCode: clientProductCode,
                    code: productCode,
                    name: productInfo.description,
                    quantity: quantity,
                    unitPrice: productInfo.unitPrice,
                    tableValue: productInfo.tableValue,
                    simulatedStock: productInfo.simulatedStock,
                    totalValue: totalValue,
                    supplier: productInfo.supplier // Adiciona o fornecedor do produto
                });
                displayAddProductMessage(`"${productInfo.description}" adicionado com sucesso.`, 'success', 'colombia');
            }

            renderColombiaProductList();
            // Limpa os campos de entrada após adicionar
            document.getElementById('clientProductCodeCOL').value = '';
            document.getElementById('productCodeCOLDisplay').innerText = '--';
            document.getElementById('productDescriptionDisplayCOL').innerText = '--';
            document.getElementById('productStockCOL').innerText = '--';
            document.getElementById('productStockCOL').style.color = '';
            document.getElementById('productQuantityCOL').value = '1';
            document.getElementById('valorUnitCOLDisplay').innerText = 'R$ 0,00';
        }

        function removeProductCOL(index) {
            colombiaProducts.splice(index, 1);
            renderColombiaProductList();
            displayAddProductMessage('Produto removido.', 'info', 'colombia');
        }

        function renderColombiaProductList() {
            const listDiv = document.getElementById('productListCOL');
            listDiv.innerHTML = '<h3 class="font-semibold text-gray-700 mb-2">Produtos Adicionados na Solicitação:</h3>';
            if (colombiaProducts.length === 0) {
                listDiv.innerHTML += '<div id="noProductsAddedCOL" class="text-gray-500 text-center py-4">Nenhum produto adicionado ainda.</div>';
                return;
            }

let tableHtml = `<table class="data-table">
                    <thead>
                        <tr>
                            <th>Cód Cliente</th>
                            <th>Cód Produto</th>
                            <th>Descrição</th>
                            <th>Qtd. Solicitada</th>
                            <th>Estoque</th>
                            <th>Valor Unit.</th>
                            <th>Valor Total</th>
                            <th>Fornecedor</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody>`;
colombiaProducts.forEach((product, index) => {
    // Para usuários 'client', exiba apenas o código do fornecedor
    const displaySupplierInfo = userRole === 'client' && product.supplier
        ? getOrGenerateSupplierCode(product.supplier)
        : (product.supplier || 'N/A');

    // Novo: Exibir "Sim" ou "Não" para estoque
    const estoqueSimNao = product.simulatedStock > 0
        ? '<span style="color:#16a34a;font-weight:bold;">Sim</span>'
        : '<span style="color:#dc2626;font-weight:bold;">Não</span>';

    tableHtml += `
        <tr>
            <td>${product.clientCode}</td>
            <td>${product.code}</td>
            <td>${product.name}</td>
            <td>${product.quantity}</td>
            <td>${estoqueSimNao}</td>
            <td>R$ ${parseFloat(product.tableValue).toFixed(2).replace('.', ',')}</td>
            <td>R$ ${parseFloat(product.totalValue).toFixed(2).replace('.', ',')}</td>
            <td>${displaySupplierInfo}</td>
            <td><button onclick="removeProductCOL(${index})" class="text-red-500 hover:text-red-700 font-bold text-sm">Remover</button></td>
        </tr>
    `;
});
tableHtml += `</tbody></table>`;
listDiv.innerHTML += tableHtml;
        }

        function submitColombiaForm() {
            if (colombiaProducts.length === 0) {
                showMessage('Erro', 'Por favor, adicione pelo menos um produto antes de enviar a solicitação.', 'error');
                return;
            }

            // Simulação de envio para o SAP e faturamento
            const totalValue = colombiaProducts.reduce((sum, product) => sum + parseFloat(product.totalValue), 0);
            const clientOrderNumberCOL = document.getElementById('clientOrderNumberCOL').value.trim();

            // Gera um novo orderId para cada submissão (PED-XXX)
            const newOrderId = `PED-${nextPurchaseOrderIdCounter.toString().padStart(3, '0')}`;
            nextPurchaseOrderIdCounter++; // Incrementa o contador para o próximo

            // Gera um novo parentOrderId para a Colômbia
            currentParentOrderId = `SOL-${nextParentRequestCounter.toString().padStart(3, '0')}`;
            nextParentRequestCounter++;

            // Cria um novo objeto de pedido para adicionar à lista 'orders'
            const newOrder = {
                orderId: newOrderId,
                parentOrderId: currentParentOrderId,
                clientFlag: currentUserClientName,
                originCountry: 'Colômbia',
                totalValue: totalValue,
                status: 'Em Separação', // Início do fluxo Colômbia
                requestDate: new Date().toISOString().slice(0, 10),
                lastUpdateDate: new Date().toISOString().slice(0, 10),
                supplier: colombiaProducts[0].supplier, // Assume o fornecedor do primeiro produto
                products: colombiaProducts.map(p => ({ ...p })) // Copia os produtos
            };
            orders.push(newOrder);

            // Also add to generatedPurchaseOrders if it's a PO that needs tracking in purchasing center
            // For Colombia, let's assume it directly goes to a fulfilled state or needs no purchasing tracking
            // unless explicit user stories are added for it. For now, it ends with invoicing.
            // If needed, we can add a new PO here with 'Finalizado' status.
            /*
            generatedPurchaseOrders.push({
                parentOrderId: newOrder.parentOrderId,
                id: newOrder.orderId,
                supplier: newOrder.supplier,
                supplierCode: getOrGenerateSupplierCode(newOrder.supplier),
                date: newOrder.requestDate,
                products: newOrder.products.map(p => ({
                    code: p.code,
                    name: p.name,
                    quantity: p.quantity,
                    unitPrice: p.unitPrice,
                    currentInternalUnitPrice: p.tableValue, // Use tableValue as internal reference
                    newSupplierUnitPrice: p.unitPrice, // For Colombia, assume unitPrice is supplier price
                    approvalStatus: 'Aprovado' // Colombia flow might imply direct approval/fulfillment
                })),
                newSupplierPriceTotal: newOrder.totalValue.toFixed(2),
                currentInternalPriceTotal: newOrder.totalValue.toFixed(2),
                overallApprovalStatus: 'Finalizado' // Directly to final status for Colombia
            });
            */


            // Exibe os detalhes da Nota Fiscal
            document.getElementById('nfeNumber').innerText = `NF-${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-001`;
            document.getElementById('nfeValue').innerText = `R$ ${totalValue.toFixed(2).replace('.', ',')}`;

            // Conteúdo simulado do PDF da NF-e
            document.getElementById('nfePdfContent').innerText = `
                NOTA FISCAL ELETRÔNICA (NF-e)
                ----------------------------------------------------
                Número da NF-e: NF-${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}-001
                Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}
                Valor Total: R$ ${totalValue.toFixed(2).replace('.', ',')}

                Emitente:
                TOTVS S.A.
                CNPJ: XX.XXX.XXX/XXXX-XX
                Endereço: Rua do Faturamento, 123
                Cidade: São Paulo - SP

                Destinatário:
                ${currentUserClientName}
                CNPJ/CPF: YY.YYY.YYY/YYYY-YY
                Endereço: Rua da Entrega, 456
                Cidade: Bogotá - Colômbia

                Produtos:
                ${colombiaProducts.map(p => `- ${p.name} (Qtd: ${p.quantity}, Valor Unit: R$ ${parseFloat(p.tableValue).toFixed(2).replace('.', ',')}, Total: R$ ${parseFloat(p.totalValue).toFixed(2).replace('.', ',')})`).join('\n')}

                Observações: Documento emitido eletronicamente.
                ----------------------------------------------------
            `;
            
            showScreen('colombiaInvoiceScreen');
            colombiaProducts = []; // Limpar produtos após submissão

            synchronizeOrdersAndPOs(); // Synchronize after new orders are generated
        }

        function showNfePdf() {
            const pdfViewer = document.getElementById('nfePdfViewer');
            pdfViewer.classList.remove('hidden');
        }

        // --- Lógica da Central de Compras (Purchasing Center) ---
        function renderPurchasingCenterTables() {
            const negotiationTbody = document.querySelector('#negotiationTable tbody');
            const negotiationInProgressTbody = document.querySelector('#negotiationInProgressTable tbody');
            const renatoActionsTbody = document.querySelector('#renatoActionsTable tbody');
            const aprovadoGerenciaTbody = document.querySelector('#aprovadoGerenciaTable tbody'); // NEW

            negotiationTbody.innerHTML = '';
            negotiationInProgressTbody.innerHTML = '';
            renatoActionsTbody.innerHTML = '';
            aprovadoGerenciaTbody.innerHTML = ''; // Clear for new tab

            // Filter for "Novas Solicitações" (Overall status is 'Pendente')
            const novasSolicitacoesPOs = generatedPurchaseOrders.filter(po => po.overallApprovalStatus === 'Pendente');

            if (novasSolicitacoesPOs.length === 0) {
                negotiationTbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhuma nova solicitação de compra no momento.</td></tr>`;
            } else {
                novasSolicitacoesPOs.forEach(po => {
                    const row = document.createElement('tr');
                    const displaySupplierInfo = getOrGenerateSupplierCode(po.supplier);
                    const orderInMainList = orders.find(o => o.orderId === po.id);
                    const creationDate = orderInMainList ? orderInMainList.requestDate : po.date; // Use original requestDate if available
                    let statusIndicatorClass = 'yellow'; // Pendente

                    row.innerHTML = `
                        <td>${po.parentOrderId ? po.parentOrderId : 'N/A'}</td>
                        <td>${po.id}</td>
                        <td>${displaySupplierInfo}</td>
                        <td>R$ ${parseFloat(po.newSupplierPriceTotal).toFixed(2).replace('.', ',')}</td>
                        <td>${creationDate}</td>
                        <td><span class="status-indicator ${statusIndicatorClass}"></span>${po.overallApprovalStatus}</td>
                        <td>
                            <button onclick="viewPurchasingOrderDetails('${po.id}', 'novasSolicitacoes')" class="btn btn-primary btn-sm">Iniciar Negociação</button>
                        </td>
                    `;
                    negotiationTbody.appendChild(row);
                });
            }

            // Filter for "Negociações em Andamento" (Overall status is 'Negociado')
            const negotiationInProgressPOs = generatedPurchaseOrders.filter(po => po.overallApprovalStatus === 'Negociado');

            if (negotiationInProgressPOs.length === 0) {
                negotiationInProgressTbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhuma negociação em andamento no momento.</td></tr>`;
            } else {
                negotiationInProgressPOs.forEach(po => {
                    const row = document.createElement('tr');
                    const displaySupplierInfo = getOrGenerateSupplierCode(po.supplier);
                    const orderInMainList = orders.find(o => o.orderId === po.id);
                    const lastUpdateDate = orderInMainList ? orderInMainList.lastUpdateDate : po.date; // Use lastUpdateDate if available
                    let statusIndicatorClass = 'purple'; // Negociado

                    row.innerHTML = `
                        <td>${po.parentOrderId ? po.parentOrderId : 'N/A'}</td>
                        <td>${po.id}</td>
                        <td>${displaySupplierInfo}</td>
                        <td>R$ ${parseFloat(po.newSupplierPriceTotal).toFixed(2).replace('.', ',')}</td>
                        <td>${lastUpdateDate}</td>
                        <td><span class="status-indicator ${statusIndicatorClass}"></span>${po.overallApprovalStatus}</td>
                        <td>
                            <button onclick="viewPurchasingOrderDetails('${po.id}', 'negociacoesEmAndamento')" class="btn btn-primary btn-sm">Continuar Negociação</button>
                        </td>
                    `;
                    negotiationInProgressTbody.appendChild(row);
                });
            }

            // Filter for "Ações do Renato" (Overall status is 'Rejeitado' or 'Aguardando Aprovação' or 'Em Negociação' if it returns from Renato as re-negotiate)
            const renatoActionsPOs = generatedPurchaseOrders.filter(po =>
                po.overallApprovalStatus === 'Aguardando Aprovação' || po.overallApprovalStatus === 'Rejeitado' // Renato also sees rejected for awareness
            );

            if (renatoActionsPOs.length === 0) {
                renatoActionsTbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Nenhum pedido aguardando ação do Renato.</td></tr>`;
            } else {
                renatoActionsPOs.forEach(po => {
                    const row = document.createElement('tr');
                    const displaySupplierInfo = getOrGenerateSupplierCode(po.supplier);
                    const orderInMainList = orders.find(o => o.orderId === po.id);
                    const clientName = orderInMainList ? orderInMainList.clientFlag : 'N/A'; // Get client name from main order list
                    const lastUpdateDate = orderInMainList ? orderInMainList.lastUpdateDate : po.date;

                    let statusIndicatorClass = '';
                    if (po.overallApprovalStatus === 'Rejeitado') statusIndicatorClass = 'red';
                    else if (po.overallApprovalStatus === 'Aguardando Aprovação') statusIndicatorClass = 'yellow';
                    else statusIndicatorClass = 'blue'; // Fallback for 'Em Negociação' from Renato

                    row.innerHTML = `
                        <td>${po.parentOrderId ? po.parentOrderId : 'N/A'}</td>
                        <td>${po.id}</td>
                        <td>${clientName}</td> <!-- Display client name -->
                        <td>${displaySupplierInfo}</td>
                        <td>R$ ${parseFloat(po.newSupplierPriceTotal).toFixed(2).replace('.', ',')}</td>
                        <td>${lastUpdateDate}</td>
                        <td><span class="status-indicator ${statusIndicatorClass}"></span>${po.overallApprovalStatus}</td>
                        <td>
                            <button onclick="viewDetailedApproval('${po.id}')" class="btn btn-primary btn-sm">Analisar</button>
                        </td>
                    `;
                    renatoActionsTbody.appendChild(row);
                });
            }

            // NEW: Filter for "Aprovado Gerencia" (Overall status is 'Aprovado')
            const aprovadoGerenciaPOs = generatedPurchaseOrders.filter(po =>
                po.overallApprovalStatus === 'Aprovado'
            );

            if (aprovadoGerenciaPOs.length === 0) {
                aprovadoGerenciaTbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhum pedido aprovado pela gerência aguardando finalização de Compras no momento.</td></tr>`;
            } else {
                aprovadoGerenciaPOs.forEach(po => {
                    const row = document.createElement('tr');
                    const displaySupplierInfo = getOrGenerateSupplierCode(po.supplier);
                    const orderInMainList = orders.find(o => o.orderId === po.id);
                    const lastUpdateDate = orderInMainList ? orderInMainList.lastUpdateDate : po.date; // Assuming approval date is last update

                    let statusIndicatorClass = 'green'; // Always green for 'Aprovado'

                    row.innerHTML = `
                        <td>${po.parentOrderId ? po.parentOrderId : 'N/A'}</td>
                        <td>${po.id}</td>
                        <td>${displaySupplierInfo}</td>
                        <td>R$ ${parseFloat(po.newSupplierPriceTotal).toFixed(2).replace('.', ',')}</td>
                        <td>${lastUpdateDate}</td>
                        <td><span class="status-indicator ${statusIndicatorClass}"></span>${po.overallApprovalStatus}</td>
                        <td>
                            <button onclick="viewPurchasingOrderDetails('${po.id}', 'aprovadoGerencia')" class="btn btn-primary btn-sm">Finalizar Processo</button>
                        </td>
                    `;
                    aprovadoGerenciaTbody.appendChild(row);
                });
            }
        }

        function viewPurchasingOrderDetails(poId, sourceTab) {
            currentPurchasingPO = generatedPurchaseOrders.find(po => po.id === poId);
            if (!currentPurchasingPO) {
                showMessage('Erro', 'Detalhes do pedido de compra não encontrados.', 'error');
                return;
            }

            document.getElementById('purchasingCurrentOrderId').innerText = currentPurchasingPO.id;
            document.getElementById('purchasingDetailOrderId').innerText = currentPurchasingPO.id;
            document.getElementById('purchasingDetailParentOrderId').innerText = currentPurchasingPO.parentOrderId ? currentPurchasingPO.parentOrderId : 'N/A';
            document.getElementById('purchasingDetailSupplier').innerText = `${currentPurchasingPO.supplierCode} - ${currentPurchasingPO.supplier}`;
            document.getElementById('purchasingDetailStatus').innerText = currentPurchasingPO.overallApprovalStatus;
            document.getElementById('purchasingDetailDate').innerText = currentPurchasingPO.date;

            const productsTableBody = document.getElementById('purchasingOrderProductsTableBody');
            productsTableBody.innerHTML = ''; // Limpa as linhas existentes

            currentPurchasingPO.products.forEach(product => {
                const row = document.createElement('tr');
                // Ensure newSupplierUnitPrice is treated as a string for display and parsing
                const newSupplierUnitPrice = parseFloat(product.newSupplierUnitPrice || 0).toFixed(2).replace('.', ',');
                
                // Add an input field for "Novo Valor Unit." that is editable only if not 'Finalizado' or 'Aprovado'
                const isEditable = currentPurchasingPO.overallApprovalStatus !== 'Aprovado' && currentPurchasingPO.overallApprovalStatus !== 'Finalizado';
                const inputHtml = isEditable ? 
                    `<input type="number" step="0.01" value="${parseFloat(product.newSupplierUnitPrice).toFixed(2)}"
                            oninput="updateProductNewPrice('${product.code}', this.value)"
                            class="product-quantity-input !w-full !text-right">` :
                    `R$ ${newSupplierUnitPrice}`;

                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${product.quantity}</td>
                    <td>R$ ${parseFloat(product.currentInternalUnitPrice).toFixed(2).replace('.', ',')}</td>
                    <td>R$ ${newSupplierUnitPrice}</td>
                    <td>${inputHtml}</td>
                    <td class="product-approval-status ${product.approvalStatus}">${product.approvalStatus}</td>
                `;
                productsTableBody.appendChild(row);
            });

            // Change button text based on the source tab
            const saveBtn = document.getElementById('savePurchasingNegotiationBtn');
            if (currentPurchasingPO.overallApprovalStatus === 'Negociado' || currentPurchasingPO.overallApprovalStatus === 'Aguardando Aprovação' || currentPurchasingPO.overallApprovalStatus === 'Rejeitado') { // Renato also can send it for re-negotiation
                saveBtn.innerText = 'Solicitar Aprovação';
            } else if (currentPurchasingPO.overallApprovalStatus === 'Aprovado') { // New tab
                saveBtn.innerText = 'Finalizar Processo';
            }
            else { // novasSolicitacoes (default: Pendente)
                saveBtn.innerText = 'Salvar Negociação';
            }
            showScreen('purchasingOrderDetailsScreen');
        }

        // Function to update the new supplier price for a product
        function updateProductNewPrice(productCode, newValue) {
            const product = currentPurchasingPO.products.find(p => p.code === productCode);
            if (product) {
                product.newSupplierUnitPrice = parseFloat(newValue).toFixed(2);
                // Re-calculate the overall total for the current PO
                currentPurchasingPO.newSupplierPriceTotal = currentPurchasingPO.products.reduce((sum, p) =>
                    sum + (parseFloat(p.newSupplierUnitPrice) * p.quantity), 0
                ).toFixed(2);
            }
        }

        function handlePurchasingAction() {
            const saveBtn = document.getElementById('savePurchasingNegotiationBtn');
            const currentAction = saveBtn.innerText;

            if (!currentPurchasingPO) {
                showMessage('Erro', 'Nenhum pedido de compra selecionado para ação.', 'error');
                return;
            }

            if (currentAction === 'Salvar Negociação') {
                currentPurchasingPO.overallApprovalStatus = 'Negociado'; // Compras saved negotiation
                showMessage('Sucesso', `Negociação para o pedido ${currentPurchasingPO.id} salva com sucesso! O pedido está agora em "Negociações em Andamento".`, 'success');
            } else if (currentAction === 'Solicitar Aprovação') {
                currentPurchasingPO.overallApprovalStatus = 'Aguardando Aprovação'; // Compras requested approval from Renato
                showMessage('Sucesso', `Solicitação de aprovação para o pedido ${currentPurchasingPO.id} enviada ao Renato.`, 'success');
            } else if (currentAction === 'Finalizar Processo') { // NEW: Finalize process from "Aprovado Gerencia" tab
                currentPurchasingPO.overallApprovalStatus = 'Finalizado'; // Mark as finalized by Compras
                showMessage('Sucesso', `Processo para o pedido ${currentPurchasingPO.id} finalizado por Compras.`, 'success');
                // Update the main order status to 'Finalizado' if it was 'Aprovado'
                const orderInMainList = orders.find(o => o.orderId === currentPurchasingPO.id);
                if (orderInMainList && orderInMainList.status === 'Aprovado') { // Only if it was already approved
                    orderInMainList.status = 'Finalizado';
                }
            }

            // Update main orders list with the new status
            const mainOrderIndex = orders.findIndex(order => order.orderId === currentPurchasingPO.id);
            if (mainOrderIndex !== -1) {
                orders[mainOrderIndex].status = currentPurchasingPO.overallApprovalStatus;
                orders[mainOrderIndex].lastUpdateDate = new Date().toISOString().slice(0, 10);
            }
            backToPurchasingCenter(); // Return to purchasing center
        }


        // Function to generate a simulated PO PDF
        function generatePOPDF() {
            if (!currentPurchasingPO) {
                showMessage('Erro', 'Nenhum pedido de compra selecionado para gerar PDF.', 'error');
                return;
            }

            const poPdfContentDiv = document.getElementById('poPdfContent');
            const poPdfViewerDiv = document.getElementById('poPdfViewer');

            let productListHtml = currentPurchasingPO.products.map(p => `
                - ${p.name} (${p.code})
                  Quantidade: ${p.quantity}
                  Valor Unit. Interno: R$ ${parseFloat(p.currentInternalUnitPrice).toFixed(2).replace('.', ',')}
                  Valor Unit. Fornecedor: R$ ${parseFloat(p.newSupplierUnitPrice).toFixed(2).replace('.', ',')}
                  Status Aprovação: ${p.approvalStatus}
            `).join('\n\n');

            poPdfContentDiv.innerText = `
                PURCHASE ORDER (PO)
                ----------------------------------------------------
                PO Nº: ${currentPurchasingPO.id}
                ID Solicitação Principal: ${currentPurchasingPO.parentOrderId || 'N/A'}
                Data de Emissão: ${currentPurchasingPO.date}

                Fornecedor:
                ${currentPurchasingPO.supplierCode} - ${currentPurchasingPO.supplier}
                Endereço: [Endereço do Fornecedor]
                Cidade: [Cidade do Fornecedor]

                Produtos:
                ${productListHtml}

                Valor Total Estimado (Fornecedor): R$ ${parseFloat(currentPurchasingPO.newSupplierPriceTotal).toFixed(2).replace('.', ',')}
                Valor Total Interno Estimado: R$ ${parseFloat(currentPurchasingPO.currentInternalPriceTotal).toFixed(2).replace('.', ',')}
                
                Status de Aprovação Geral: ${currentPurchasingPO.overallApprovalStatus}

                Observações: Documento gerado automaticamente.
                ----------------------------------------------------
            `;
            poPdfViewerDiv.classList.remove('hidden');
        }

        // --- Lógica da Aprovação do Renato (Gerência) ---
        function simulateRenatoApprovalScreen() {
            showScreen('renatoApprovalScreen');
            renderPendingRenatoApprovalList();
        }

        function renderPendingRenatoApprovalList() {
            const tbody = document.getElementById('pendingOrdersTableBody');
            tbody.innerHTML = ''; // Limpa o corpo da tabela

            // Filtra POs que estão 'Aguardando Aprovação' ou 'Rejeitado' (para Renato revisar novamente)
            const pendingForRenato = generatedPurchaseOrders.filter(po =>
                po.overallApprovalStatus === 'Aguardando Aprovação' || po.overallApprovalStatus === 'Rejeitado'
            ).sort((a, b) => {
                // Sort by date, then by PO ID
                if (a.date > b.date) return 1;
                if (a.date < b.date) return -1;
                return a.id.localeCompare(b.id);
            });


            if (pendingForRenato.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Nenhum pedido aguardando aprovação gerencial.</td></tr>`;
                return;
            }

            pendingForRenato.forEach(po => {
                const row = document.createElement('tr');
                const displaySupplierInfo = getOrGenerateSupplierCode(po.supplier);
                const orderInMainList = orders.find(o => o.orderId === po.id);
                const clientName = orderInMainList ? orderInMainList.clientFlag : 'N/A'; // Get client name from main order list
                const lastUpdateDate = orderInMainList ? orderInMainList.lastUpdateDate : po.date;

                let statusIndicatorClass = '';
                if (po.overallApprovalStatus === 'Rejeitado') statusIndicatorClass = 'red';
                else if (po.overallApprovalStatus === 'Aguardando Aprovação') statusIndicatorClass = 'yellow';
                else statusIndicatorClass = 'blue'; // Fallback for 'Em Negociação' from Renato (though it shouldn't be here)

                row.innerHTML = `
                    <td>${po.parentOrderId ? po.parentOrderId : 'N/A'}</td>
                    <td>${po.id}</td>
                    <td>${clientName}</td> <!-- Display client name -->
                    <td>${displaySupplierInfo}</td>
                    <td>R$ ${parseFloat(po.newSupplierPriceTotal).toFixed(2).replace('.', ',')}</td>
                    <td>${po.date}</td>
                    <td>${lastUpdateDate}</td>
                    <td>
                        <button onclick="viewDetailedApproval('${po.id}')" class="btn btn-primary btn-sm">Analisar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


                function viewDetailedApproval(poId) {
                    // Mostra a tela de loading
                    document.getElementById('analysisLoadingScreen').classList.remove('hidden');

                    // Simula o cálculo (exemplo: 2 segundos)
                    setTimeout(() => {
                        document.getElementById('analysisLoadingScreen').classList.add('hidden');

                        // --- CÓDIGO ORIGINAL DA FUNÇÃO ABAIXO ---
                        currentViewingPO = generatedPurchaseOrders.find(po => po.id === poId);
                        if (!currentViewingPO) {
                            showMessage('Erro', 'Detalhes do pedido de compra não encontrados.', 'error');
                            return;
                        }

                        document.getElementById('currentDetailedParentOrderIdDisplay').innerText = currentViewingPO.parentOrderId || currentViewingPO.id;
                        document.getElementById('pendingOrdersList').classList.add('hidden');
                        document.getElementById('detailedApprovalView').classList.remove('hidden');

                        renderSupplierApprovalCards();
                        updateGlobalDifferenceSummary();
                        checkApprovalButtonsState();
                    }, 2000); // 2000ms = 2 segundos
                }

        function backToPendingOrdersList() {
            document.getElementById('detailedApprovalView').classList.add('hidden');
            document.getElementById('pendingOrdersList').classList.remove('hidden');
            renderPendingRenatoApprovalList(); // Re-render the list to reflect any changes
        }

function renderSupplierApprovalCards() {
    const cardsDiv = document.getElementById('supplierApprovalCards');
    cardsDiv.innerHTML = '';

    // This function now expects currentViewingPO to be a single PO object
    const po = currentViewingPO;
    const card = document.createElement('div');
    card.className = 'supplier-summary-card';

    const totalExternalCost = parseFloat(po.newSupplierPriceTotal);
    const totalInternalCost = parseFloat(po.currentInternalPriceTotal);
    const absoluteDifference = totalExternalCost - totalInternalCost;
    const percentageDifference = ((totalInternalCost === 0) ? 0 : (absoluteDifference / totalInternalCost) * 100).toFixed(2); // Avoid division by zero
    
    let differenceClass = '';
    let differenceText = '';

    if (absoluteDifference > 0) {
        differenceClass = 'price-difference-positive';
        differenceText = `(+R$ ${absoluteDifference.toFixed(2).replace('.', ',')} / +${percentageDifference}%)`;
    } else if (absoluteDifference < 0) {
        differenceClass = 'price-difference-negative';
        differenceText = `(-R$ ${Math.abs(absoluteDifference).toFixed(2).replace('.', ',')} / ${percentageDifference}%)`;
    } else {
        differenceClass = '';
        differenceText = '(Sem diferença)';
    }

    // Determine overall status indicator for the card
    let cardStatusEmoji = '';
    if (po.overallApprovalStatus === 'Aguardando Aprovação') {
        cardStatusEmoji = '🟡'; // Pending
    } else if (po.overallApprovalStatus === 'Aprovado') {
        cardStatusEmoji = '🟢'; // Approved
    } else if (po.overallApprovalStatus === 'Rejeitado') {
        cardStatusEmoji = '🔴'; // Rejected
    } else if (po.overallApprovalStatus === 'Negociado') {
        cardStatusEmoji = '🟣'; // Negotiated (Compras is still working)
    } else if (po.overallApprovalStatus === 'Finalizado') {
        cardStatusEmoji = '✅'; // Finalizado
    }

    card.innerHTML = `
        <span class="supplier-status-indicator">${cardStatusEmoji}</span>
        <h3 class="font-semibold text-lg mb-2">PO Nº ${po.id} para Fornecedor: <span class="text-blue-700">${po.supplierCode} - ${po.supplier}</span></h3>
        <p class="text-gray-600 mb-1">ID Solicitação Principal: <strong>${po.parentOrderId}</strong></p>
        <p class="text-gray-600 mb-1">Data Geração: ${po.date}</p>
        <p class="text-gray-600 mb-1">Valor Total Custo Fornecedor (Estimado): <strong>R$ ${totalExternalCost.toFixed(2).replace('.', ',')}</strong></p>
        <p class="text-gray-600 mb-4">Valor Total Custo Interno (Estimado): <strong>R$ ${totalInternalCost.toFixed(2).replace('.', ',')}</strong> <span class="${differenceClass}">${differenceText}</span></p>
        <h4 class="font-semibold text-md mb-2">Detalhes dos Produtos:</h4>
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Cód Produto</th>
                        <th>Descrição</th>
                        <th>Qtd.</th>
                        <th>Valor Unit. Interno</th>
                        <th>Valor Unit. Fornecedor</th>
                        <th>Dif</th>
                        <th>Valor Total Interno</th>
                        <th>Valor Total Fornecedor</th>
                        <th>Status Aprovação</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    ${po.products.map((p, pIndex) => {
                        const diff = parseFloat(p.newSupplierUnitPrice) - parseFloat(p.currentInternalUnitPrice);
                        const percent = parseFloat(p.currentInternalUnitPrice) === 0
                            ? 0
                            : (diff / parseFloat(p.currentInternalUnitPrice)) * 100;
                        const diffClass = diff > 0 ? 'price-difference-positive' : (diff < 0 ? 'price-difference-negative' : '');
                        const diffText = diff > 0
                            ? `+R$ ${diff.toFixed(2).replace('.', ',')} (+${percent.toFixed(2)}%)`
                            : diff < 0
                                ? `-R$ ${Math.abs(diff).toFixed(2).replace('.', ',')} (${percent.toFixed(2)}%)`
                                : 'R$ 0,00 (0,00%)';
                        const totalInterno = parseFloat(p.currentInternalUnitPrice) * p.quantity;
                        const totalFornecedor = parseFloat(p.newSupplierUnitPrice) * p.quantity;
                        return `
                            <tr>
                                <td>${p.code}</td>
                                <td>${p.name}</td>
                                <td>${p.quantity}</td>
                                <td>R$ ${parseFloat(p.currentInternalUnitPrice).toFixed(2).replace('.', ',')}</td>
                                <td>R$ ${parseFloat(p.newSupplierUnitPrice).toFixed(2).replace('.', ',')}</td>
                                <td><span class="${diffClass}">${diffText}</span></td>
                                <td>R$ ${totalInterno.toFixed(2).replace('.', ',')}</td>
                                <td>R$ ${totalFornecedor.toFixed(2).replace('.', ',')}</td>
                                <td class="product-approval-status ${p.approvalStatus}">${p.approvalStatus}</td>
                                <td>
                                    <div class="approval-buttons-group">
                                        <button class="btn btn-sm btn-approve ${p.approvalStatus === 'Aprovado' ? 'selected' : ''}"
                                                onclick="setProductApprovalStatus('${po.id}', '${p.code}', 'Aprovado')">Aprovar</button>
                                        <button class="btn btn-sm btn-negotiate ${p.approvalStatus === 'Negociar' ? 'selected' : ''}"
                                                onclick="setProductApprovalStatus('${po.id}', '${p.code}', 'Negociar')">Negociar</button>
                                        <button class="btn btn-sm btn-reject ${p.approvalStatus === 'Rejeitado' ? 'selected' : ''}"
                                                onclick="setProductApprovalStatus('${po.id}', '${p.code}', 'Rejeitar')">Rejeitar</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    cardsDiv.appendChild(card);
}

        function setProductApprovalStatus(poId, productCode, status) {
            const po = generatedPurchaseOrders.find(p => p.id === poId);
            if (po) {
                const product = po.products.find(prod => prod.code === productCode);
                if (product) {
                    product.approvalStatus = status;
                    renderSupplierApprovalCards(); // Re-render to update UI
                    checkApprovalButtonsState(); // Check if global buttons can be enabled
                }
            }
        }

        function checkApprovalButtonsState() {
            const saveApprovalBtn = document.getElementById('saveApprovalBtn');
            const finalizeApprovalBtn = document.getElementById('finalizeApprovalBtn');

            // All products in the current PO must have a status other than 'Pendente'
            const allProductsReviewed = currentViewingPO.products.every(p => p.approvalStatus !== 'Pendente');

            if (allProductsReviewed) {
                saveApprovalBtn.classList.remove('hidden');
                saveApprovalBtn.disabled = false;
                finalizeApprovalBtn.classList.remove('hidden');
                finalizeApprovalBtn.disabled = false;
            } else {
                saveApprovalBtn.classList.add('hidden'); // Hide Save button if not all reviewed
                saveApprovalBtn.disabled = true;
                finalizeApprovalBtn.classList.add('hidden');
                finalizeApprovalBtn.disabled = true;
            }
        }

        function updateGlobalDifferenceSummary() {
            const globalDifferenceSummaryDiv = document.getElementById('globalDifferenceSummary');
            const globalDifferenceValueSpan = document.getElementById('globalDifferenceValue');

            let totalApprovedDifference = 0;
            let totalNegotiateDifference = 0;
            let totalRejectedDifference = 0;

            currentViewingPO.products.forEach(product => {
                const currentInternalPrice = parseFloat(product.currentInternalUnitPrice);
                const newSupplierPrice = parseFloat(product.newSupplierUnitPrice);
                const difference = (newSupplierPrice - currentInternalPrice) * product.quantity;

                if (product.approvalStatus === 'Aprovado') {
                    totalApprovedDifference += difference;
                } else if (product.approvalStatus === 'Negociar') {
                    totalNegotiateDifference += difference;
                } else if (product.approvalStatus === 'Rejeitado') {
                    totalRejectedDifference += difference;
                }
            });

            const overallDifference = totalApprovedDifference + totalNegotiateDifference + totalRejectedDifference;

            let differenceText = '';
            let differenceClass = '';

            if (overallDifference > 0) {
                differenceText = `Custo Maior: R$ ${overallDifference.toFixed(2).replace('.', ',')}`;
                differenceClass = 'price-difference-positive';
            } else if (overallDifference < 0) {
                differenceText = `Economia: R$ ${Math.abs(overallDifference).toFixed(2).replace('.', ',')}`;
                differenceClass = 'price-difference-negative';
            } else {
                differenceText = `Sem alteração de custo: R$ ${overallDifference.toFixed(2).replace('.', ',')}`;
                differenceClass = '';
            }

            globalDifferenceValueSpan.innerText = differenceText;
            globalDifferenceValueSpan.className = differenceClass;
            globalDifferenceSummaryDiv.classList.remove('hidden');
        }

        function saveApprovalDecisions() {
            // This function now just saves the current status of the products within currentViewingPO
            // The actual overall status update will happen in finalizeApproval
            showMessage('Sucesso', 'Decisões de aprovação salvas temporariamente. Finalize para aplicar as alterações.', 'success');
        }

        function displayRenatoFinalSummary() {
            if (!currentViewingPO) {
                showMessage('Erro', 'Nenhum pedido selecionado para finalizar aprovação.', 'error');
                return;
            }

            // Check if all products have a status other than 'Pendente'
            const allProductsReviewed = currentViewingPO.products.every(p => p.approvalStatus !== 'Pendente');
            if (!allProductsReviewed) {
                showMessage('Atenção', 'Por favor, defina o status (Aprovar, Negociar ou Rejeitar) para TODOS os produtos antes de finalizar.', 'warning');
                return;
            }

            let approvedCount = 0;
            let negotiateCount = 0;
            let rejectedCount = 0;
            let totalProducts = currentViewingPO.products.length;

            currentViewingPO.products.forEach(p => {
                if (p.approvalStatus === 'Aprovado') approvedCount++;
                else if (p.approvalStatus === 'Negociar') negotiateCount++;
                else if (p.approvalStatus === 'Rejeitado') rejectedCount++;
            });

            let finalTitle = '';
            let finalMessage = '';
            let finalDetailsHtml = '';

            if (approvedCount === totalProducts) {
                currentViewingPO.overallApprovalStatus = 'Aprovado';
                finalTitle = 'Aprovação Concluída!';
                finalMessage = `Todos os ${totalProducts} produtos do pedido ${currentViewingPO.id} foram APROVADOS pela Gerência.`;
                finalDetailsHtml = `<p>O pedido foi aprovado e agora o processo segue para a equipe de Compras.</p>`;
            } else if (rejectedCount === totalProducts) {
                currentViewingPO.overallApprovalStatus = 'Rejeitado';
                finalTitle = 'Pedido Rejeitado';
                finalMessage = `Todos os ${totalProducts} produtos do pedido ${currentViewingPO.id} foram REJEITADOS pela Gerência.`;
                finalDetailsHtml = `<p>O pedido foi rejeitado e o processo será encerrado.</p>`;
            } else if (negotiateCount > 0 || rejectedCount > 0) { // Mixed status or all for negotiation/rejection
                currentViewingPO.overallApprovalStatus = 'Em Negociação'; // Send back to 'Em Negociação' status for Compras
                finalTitle = 'Aprovação com Pendências';
                finalMessage = `O pedido ${currentViewingPO.id} foi parcialmente aprovado ou possui itens para renegociação/rejeição.`;
                finalDetailsHtml = `
                    <p>${approvedCount} produto(s) aprovado(s).</p>
                    <p>${negotiateCount} produto(s) para renegociação.</p>
                    <p>${rejectedCount} produto(s) rejeitado(s).</p>
                    <p class="mt-4">O pedido retornará para a Central de Compras para que as renegociações e/ou rejeições sejam tratadas.</p>
                `;
            } else {
                // This case should ideally not happen if all products are reviewed.
                // It means there's an unforeseen state or an issue with how statuses are set.
                showMessage('Erro', 'Status de aprovação inconsistente. Por favor, verifique e tente novamente.', 'error');
                return;
            }

            // Atualiza o status do pedido principal (PED-XXX) na lista 'orders'
            const orderInMainList = orders.find(o => o.orderId === currentViewingPO.id);
            if (orderInMainList) {
                orderInMainList.status = currentViewingPO.overallApprovalStatus;
                orderInMainList.lastUpdateDate = new Date().toISOString().slice(0, 10);
            }

            document.getElementById('hongKongFinalTitle').innerText = finalTitle;
            document.getElementById('hongKongFinalMessage').innerText = finalMessage;
            document.getElementById('finalDetailsHK').innerHTML = finalDetailsHtml;

            showScreen('hongKongFinalScreen');

            // Reset currentViewingPO after finalizing
            currentViewingPO = null;

            synchronizeOrdersAndPOs(); // Synchronize after Renato's actions
        }


        // --- Sincronização e Inicialização ---
        function synchronizeOrdersAndPOs() {
            // Este loop garante que os status dos pedidos na lista 'orders' (visão do cliente)
            // estejam correlacionados com os status dos POs na lista 'generatedPurchaseOrders' (visão de compras/gerência).
            orders.forEach(order => {
                const correspondingPO = generatedPurchaseOrders.find(po => po.id === order.orderId);
                if (correspondingPO) {
                    // Atualiza o status do pedido do cliente com base no status geral da PO
                    order.status = correspondingPO.overallApprovalStatus;
                    order.lastUpdateDate = new Date().toISOString().slice(0, 10);

                    // Se a PO estiver "Aprovado", o pedido do cliente pode ir para "Em Produção"
                    if (correspondingPO.overallApprovalStatus === 'Aprovado' && order.originCountry === 'Hong Kong') {
                        order.status = 'Em Produção';
                    }
                    // Se a PO estiver "Negociado", o pedido do cliente deve refletir "Em Negociação"
                    else if (correspondingPO.overallApprovalStatus === 'Negociado') {
                        order.status = 'Em Negociação';
                    }
                     // If PO is "Finalizado" (by Compras), the client's order status updates accordingly
                    else if (correspondingPO.overallApprovalStatus === 'Finalizado') {
                        order.status = 'Finalizado';
                    }
                }
            });
            // Opcionalmente, renderizar novamente as tabelas para refletir as alterações
            if (currentScreen === 'orderCenterScreen') {
                renderOrdersTable();
            } else if (currentScreen === 'purchasingCenterScreen') {
                renderPurchasingCenterTables();
            }
        }


        // --- Collapsible sections (common function) ---
        function toggleCollapsible(headerElement, contentId) {
            const content = document.getElementById(contentId);
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                headerElement.classList.add('open');
            } else {
                content.classList.add('hidden');
                headerElement.classList.remove('open');
            }
        }

        // --- Product Catalog Modal (common function) ---
        let currentFilialForCatalog = '';

        function openProductCatalogModal(filial) {
            currentFilialForCatalog = filial;
            const productCatalogList = document.getElementById('productCatalogList');
            productCatalogList.innerHTML = ''; // Clear previous list

            let tableHtml = `<table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Cód Prod Cliente</th>
                                        <th>Cód Produto</th>
                                        <th>Descrição</th>
                                        <th>Preço Unit.</th>
                                        ${filial === 'hongkong' ? '<th>MOQ</th><th>M³ Unit.</th>' : '<th>Estoque</th>'}
                                        <th>Linha</th>
                                    </tr>
                                </thead>
                                <tbody>`;

            for (const code in productDatabase) {
                const product = productDatabase[code];
                // Ensure product.tableValue is defined before calling toFixed()
                const displayPrice = product.tableValue !== undefined && product.tableValue !== null
                    ? product.tableValue.toFixed(2).replace('.', ',')
                    : 'N/A'; // Or some default value

                tableHtml += `
                    <tr onclick="selectProductFromCatalog('${product.clientCode}', '${filial}')">
                        <td class="product-code-display">${product.clientCode}</td>
                        <td class="product-code-display">${product.code}</td>
                        <td class="product-description-display">${product.description}</td>
                        <td>R$ ${displayPrice}</td>
                        ${filial === 'hongkong' ? `<td>${product.moq}</td><td>${product.cubageUnit.toFixed(3).replace('.', ',')}</td>` : `<td style="color: ${product.simulatedStock === 0 ? '#dc2626' : (product.simulatedStock < 10 ? '#eab308' : '#16a34a')}; font-weight: bold;">${product.simulatedStock}</td>`}
                        <td class="product-line-display">${product.productLine}</td>
                    </tr>
                `;
            }
            tableHtml += `</tbody></table>`;
            productCatalogList.innerHTML = tableHtml;

            document.getElementById('productCatalogSearchInput').value = ''; // Clear search
            document.getElementById('productCatalogModal').classList.remove('hidden');
        }

        function filterProductCatalog() {
            const searchTerm = document.getElementById('productCatalogSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#productCatalogList tbody tr');

            rows.forEach(row => {
                const clientCode = row.children[0].innerText.toLowerCase();
                const productCode = row.children[1].innerText.toLowerCase();
                const description = row.children[2].innerText.toLowerCase();

                if (clientCode.includes(searchTerm) || productCode.includes(searchTerm) || description.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function selectProductFromCatalog(clientProductCode, filial) {
            if (filial === 'hongkong') {
                document.getElementById('clientProductCodeHK').value = clientProductCode;
                updateProductDetailsOnClientCodeChangeHK();
            } else { // 'colombia'
                document.getElementById('clientProductCodeCOL').value = clientProductCode;
                updateProductDetailsOnClientCodeChangeCOL();
            }
            closeProductCatalogModal();
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Populate supplier filter with existing data on load
            orders.forEach(order => {
                if (order.supplier) {
                    getOrGenerateSupplierCode(order.supplier);
                }
            });
            // Define os contadores iniciais com base nos dados atuais
            const maxSolId = orders.reduce((max, order) => {
                const solNum = order.parentOrderId && typeof order.parentOrderId === 'string'
                               ? parseInt(order.parentOrderId.replace('SOL-', ''))
                               : 0;
                return isNaN(solNum) ? max : Math.max(max, solNum);
            }, 0);
            nextParentRequestCounter = maxSolId + 1;

            const maxPedId = orders.reduce((max, order) => {
                const pedNum = order.orderId && typeof order.orderId === 'string'
                               ? parseInt(order.orderId.replace('PED-', ''))
                               : 0;
                return isNaN(pedNum) ? max : Math.max(max, pedNum);
            }, 0);
            nextPurchaseOrderIdCounter = maxPedId + 1;
            
            showScreen('loginScreen');

            // Adiciona o event listener para o botão de login
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.addEventListener('click', login);
            } else {
                console.error("Botão de login não encontrado.");
            }
        });
    </script>
</body>
</html>
