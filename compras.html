<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Fluig - Central de Compras</title>
    <!-- Link para o arquivo CSS externo -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- Central de Compras - Página Principal do Compras -->
    <div id="purchasingCenterScreen" class="page active">
        <header class="header">
            <div class="header-left">
                <h1>Central de Compras</h1>
            </div>
            <div class="header-right">
                <span class="header-icon" onclick="showScreenInfo()"><i class="icon-question"></i></span>
                <span class="header-icon" onclick="openFlowchartModal()"><i class="icon-flow"></i></span> <!-- Botão Fluxo -->
                <button class="btn-secondary" id="purchasingLogoutButton">Sair (Logout)</button>
            </div>
        </header>

        <div class="container">
            <div class="filters">
                <div class="filter-group">
                    <label for="poSupplierFilter">Fornecedor:</label>
                    <select id="poSupplierFilter" onchange="renderPurchasingCenterTables()">
                        <option value="Todos">Todos</option>
                        <!-- Opções de fornecedor serão populadas via JS -->
                    </select>
                </div>
                <div class="filter-group">
                    <label for="poOriginCountryFilter">País Origem:</label>
                    <select id="poOriginCountryFilter" onchange="renderPurchasingCenterTables()">
                        <option value="Todos">Todos</option>
                        <!-- Opções de país de origem serão populadas via JS -->
                    </select>
                </div>
                <div class="filter-group search-group">
                    <label for="poSearch">Buscar por Nº PO ou ID Solicitação:</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="poSearch" placeholder="Buscar por Nº PO ou ID Solicitação">
                        <button class="search-icon-btn" onclick="renderPurchasingCenterTables()"><i class="icon-search"></i></button>
                    </div>
                </div>
            </div>

            <div class="tab-buttons" id="purchasingTabButtons">
                <button class="tab-button active" onclick="switchPurchasingTab('newRequests')">Novas Solicitações</button>
                <button class="tab-button" onclick="switchPurchasingTab('negotiationsInProgress')">Negociações em Andamento</button>
                <button class="tab-button" onclick="switchPurchasingTab('pendingManagement')">Pendente Gerência</button>
                <button class="tab-button" onclick="switchPurchasingTab('approvedManagement')">Aprovado Gerência</button>
            </div>

            <div id="newRequestsTab" class="tab-content active">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID SOLICITAÇÃO PRINCIPAL</th>
                                <th>Nº PO</th>
                                <th>FORNECEDOR (CÓDIGO)</th>
                                <th>PAÍS ORIGEM</th>
                                <th>VALOR TOTAL (FORNECEDOR)</th>
                                <th>STATUS DA PO</th>
                                <th>DATA GERAÇÃO</th>
                                <th>AÇÃO</th>
                            </tr>
                        </thead>
                        <tbody id="newRequestsTableBody">
                            <!-- New Requests POs will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="negotiationsInProgressTab" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID SOLICITAÇÃO PRINCIPAL</th>
                                <th>Nº PO</th>
                                <th>FORNECEDOR (CÓDIGO)</th>
                                <th>PAÍS ORIGEM</th>
                                <th>VALOR TOTAL (FORNECEDOR)</th>
                                <th>STATUS DA PO</th>
                                <th>DATA GERAÇÃO</th>
                                <th>AÇÃO</th>
                            </tr>
                        </thead>
                        <tbody id="negotiationsInProgressTableBody">
                            <!-- Negotiations In Progress POs will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="pendingManagementTab" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID SOLICITAÇÃO PRINCIPAL</th>
                                <th>Nº PO</th>
                                <th>FORNECEDOR (CÓDIGO)</th>
                                <th>PAÍS ORIGEM</th>
                                <th>VALOR TOTAL (FORNECEDOR)</th>
                                <th>STATUS DA PO</th>
                                <th>DATA GERAÇÃO</th>
                                <th>AÇÃO</th>
                            </tr>
                        </thead>
                        <tbody id="pendingManagementTableBody">
                            <!-- Pending Management POs will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="approvedManagementTab" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID SOLICITAÇÃO PRINCIPAL</th>
                                <th>Nº PO</th>
                                <th>FORNECEDOR (CÓDIGO)</th>
                                <th>PAÍS ORIGEM</th>
                                <th>VALOR TOTAL (FORNECEDOR)</th>
                                <th>STATUS DA PO</th>
                                <th>DATA GERAÇÃO</th>
                                <th>STATUS FINAL</th>
                            </tr>
                        </thead>
                        <tbody id="approvedManagementTableBody">
                            <!-- Approved/Rejected POs will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Detalhes do Pedido de Compra (PO) -->
    <div id="purchaseOrderDetailsScreen" class="page">
        <header class="header">
            <div class="header-left">
                <h1>Detalhes do Pedido de Compra (PO) <span id="currentPoId"></span></h1>
            </div>
            <div class="header-right">
                <span class="header-icon" onclick="showScreenInfo()"><i class="icon-question"></i></span>
                <span class="header-icon" onclick="openFlowchartModal()"><i class="icon-flow"></i></span> <!-- Botão Fluxo -->
            </div>
        </header>
        <div class="container">
            <div class="form-section">
                <h2 class="text-xl font-semibold mb-4">Informações Gerais da PO</h2>
                <div class="details-grid">
                    <div class="detail-row">
                        <div class="detail-label">Nº PO:</div>
                        <div class="detail-value" id="poDetailId"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ID Solicitação Principal:</div>
                        <div class="detail-value" id="poDetailParentOrderId"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Fornecedor:</div>
                        <div class="detail-value" id="poDetailSupplier"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">País de Origem:</div>
                        <div class="detail-value" id="poDetailOriginCountry"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Valor Total (Fornecedor):</div>
                        <div class="detail-value" id="poDetailNewSupplierPriceTotal"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Valor Total (Interno):</div>
                        <div class="detail-value" id="poDetailCurrentInternalPriceTotal"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status Geral da PO:</div>
                        <div class="detail-value" id="poDetailOverallApprovalStatus"></div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Data de Geração:</div>
                        <div class="detail-value" id="poDetailDate"></div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="text-xl font-semibold mb-4">Produtos na PO</h2>
                <div class="table-container">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Cód Produto</th>
                                <th>Descrição</th>
                                <th>Qtd.</th>
                                <th>Valor Unit. Interno</th>
                                <th>Valor Unit. Fornecedor (Atual)</th>
                                <th>Status Aprovação Item</th>
                            </tr>
                        </thead>
                        <tbody id="poDetailsProductsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-section" id="negotiationSection">
                <h2 class="text-xl font-semibold mb-4">Negociação de Preços (Apenas Hong Kong)</h2>
                <div class="input-group">
                    <label for="negotiationNotes">Notas da Negociação:</label>
                    <textarea id="negotiationNotes" rows="4" placeholder="Adicione notas sobre a negociação aqui..."></textarea>
                </div>
                <div class="form-actions">
                    <button class="btn-primary" onclick="finalizeNegotiation()">Finalizar Negociação</button>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn-secondary" onclick="backToPurchasingCenter()">Voltar para Central de Compras</button>
                <button class="btn-primary" onclick="generatePOPDF(currentPurchasingPO.id)">Gerar PDF da PO</button>
            </div>
        </div>
    </div>

    <!-- Modais Globais (usados por várias telas) -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="messageModalCloseBtn">&times;</button>
            <h3 id="messageModalTitle"></h3>
            <div id="messageModalContent"></div>
            <div class="modal-actions">
                <button class="btn-primary" id="messageModalConfirmBtn">OK</button>
                <button class="btn-secondary" id="messageModalCancelBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="poPdfViewer" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('poPdfViewer').classList.remove('active');">&times;</button>
            <h3>Visualizar PDF da PO</h3>
            <pre id="poPdfContent" class="whitespace-pre-wrap"></pre>
            <div class="modal-actions">
                <button class="btn-primary" onclick="document.getElementById('poPdfViewer').classList.remove('active');">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Flowchart Modal Structure -->
    <div id="flowchartModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeFlowchartModal()">&times;</span>
            <img id="flowchartImage" src="https://raw.githubusercontent.com/SamuelJuniorrr/importexport/refs/heads/main/fluxograma.png" alt="Fluxograma do Processo">
        </div>
    </div>

    <!-- Link para o arquivo JavaScript externo -->
    <script src="script.js"></script>
    <script>
        let currentPurchasingTab = 'newRequests'; // Adiciona uma variável para controlar a aba ativa

        /**
         * Exibe informações sobre a tela atual para o usuário de Compras.
         */
        function showScreenInfo() {
            let info = '';
            switch (currentScreen) {
                case 'purchasingCenterScreen':
                    info = `
                        <h2 style="font-size:1.3rem; font-weight:bold; margin-bottom:10px;">🛒 Central de Compras</h2>
                        <p>Bem-vindo à <b>Central de Compras</b>! Aqui você gerencia as Ordens de Compra (POs) e as negociações com fornecedores.</p>
                        <hr style="margin:16px 0;">
                        <h3 style="font-size:1.1rem; font-weight:bold;">🔍 Busca e Filtros</h3>
                        <ul style="margin-bottom:10px;">
                        <li>Filtre POs por <b>Fornecedor</b> (código) ou <b>País de Origem</b>.</li>
                        <li>Utilize a busca rápida por número da PO ou ID da Solicitação Principal.</li>
                        </ul>
                        <h3 style="font-size:1.1rem; font-weight:bold;">📋 Visualização das POs</h3>
                        <ul style="margin-bottom:10px;">
                        <li>Veja todas as POs em uma tabela detalhada.</li>
                        <li>Clique em <b>Ver Detalhes</b> para acessar informações completas e iniciar negociações.</li>
                        </ul>
                        <h3 style="font-size:1.1rem; font-weight:bold;">📊 Negociação</h3>
                        <ul style="margin-bottom:10px;">
                        <li>Para POs de Hong Kong, você pode simular a negociação de preços e finalizar o processo.</li>
                        <li>POs da Colômbia são processadas automaticamente via SAP.</li>
                        </ul>
                        <hr style="margin:16px 0;">
                        <p style="font-size:0.95rem;">Se precisar de ajuda, clique novamente neste ícone ou consulte o manual do usuário.</p>
                    `;
                    break;
                case 'purchaseOrderDetailsScreen':
                    info = `
                        <h2 style="font-size:1.3rem; font-weight:bold; margin-bottom:10px;">📄 Detalhes da PO</h2>
                        <p>Visualize os detalhes de uma Ordem de Compra (PO) e gerencie a negociação.</p>
                        <hr style="margin:16px 0;">
                        <ul style="margin-bottom:10px;">
                        <li><b>Informações Gerais:</b> Dados básicos da PO, valores internos e do fornecedor.</li>
                        <li><b>Produtos na PO:</b> Lista de itens, quantidades e status de aprovação individual.</li>
                        <li><b>Negociação de Preços:</b> (Apenas para Hong Kong) Adicione notas e finalize a negociação.</li>
                        <li><b>Gerar PDF:</b> Crie um PDF simulado da PO para documentação.</li>
                        </ul>
                        <hr style="margin:16px 0;">
                        <p style="font-size:0.95rem;"><b>Dica:</b> O status de aprovação de cada item é atualizado após a negociação ou aprovação gerencial.</p>
                    `;
                    break;
                default:
                    info = '<p>Esta tela faz parte do fluxo do portal. Para mais informações, consulte o manual ou o suporte.</p>';
            }
            showMessage('Informações da Tela', info, 'info');
        }

        /**
         * Retorna à Central de Compras.
         */
        function backToPurchasingCenter() {
            showScreen('purchasingCenterScreen');
            renderPurchasingCenterTables(); // Re-renderiza a tabela de POs
        }

        /**
         * Alterna entre as abas da Central de Compras.
         * @param {string} tabType - O tipo da aba a ser ativada ('newRequests', 'negotiationsInProgress', 'pendingManagement', 'approvedManagement').
         */
        function switchPurchasingTab(tabType) {
            const newRequestsTabContent = document.getElementById('newRequestsTab');
            const negotiationsInProgressTabContent = document.getElementById('negotiationsInProgressTab');
            const pendingManagementTabContent = document.getElementById('pendingManagementTab');
            const approvedManagementTabContent = document.getElementById('approvedManagementTab');
            const tabButtonsContainer = document.getElementById('purchasingTabButtons');

            newRequestsTabContent.classList.remove('active');
            negotiationsInProgressTabContent.classList.remove('active');
            pendingManagementTabContent.classList.remove('active');
            approvedManagementTabContent.classList.remove('active');

            Array.from(tabButtonsContainer.children).forEach(button => {
                button.classList.remove('active');
            });

            currentPurchasingTab = tabType; // Atualiza a aba ativa

            if (tabType === 'newRequests') {
                newRequestsTabContent.classList.add('active');
                tabButtonsContainer.children[0].classList.add('active');
            } else if (tabType === 'negotiationsInProgress') {
                negotiationsInProgressTabContent.classList.add('active');
                tabButtonsContainer.children[1].classList.add('active');
            } else if (tabType === 'pendingManagement') {
                pendingManagementTabContent.classList.add('active');
                tabButtonsContainer.children[2].classList.add('active');
            } else if (tabType === 'approvedManagement') {
                approvedManagementTabContent.classList.add('active');
                tabButtonsContainer.children[3].classList.add('active');
            }
            renderPurchasingCenterTables(); // Re-renderiza as tabelas após a troca de aba
        }

        /**
         * Renderiza as tabelas da Central de Compras, aplicando filtros e separando por abas.
         */
        function renderPurchasingCenterTables() {
            const newRequestsTbody = document.getElementById('newRequestsTableBody');
            const negotiationsInProgressTbody = document.getElementById('negotiationsInProgressTableBody');
            const pendingManagementTbody = document.getElementById('pendingManagementTableBody');
            const approvedManagementTbody = document.getElementById('approvedManagementTableBody');

            // Limpa todas as tabelas antes de renderizar
            newRequestsTbody.innerHTML = '';
            negotiationsInProgressTbody.innerHTML = '';
            pendingManagementTbody.innerHTML = '';
            approvedManagementTbody.innerHTML = '';

            const supplierFilterCode = document.getElementById('poSupplierFilter').value;
            const originCountryFilter = document.getElementById('poOriginCountryFilter').value;
            const searchInput = document.getElementById('poSearch').value.toLowerCase();

            // Filtra as POs com base nos filtros globais
            const filteredPOs = generatedPurchaseOrders.filter(po => {
                const matchesSupplier = supplierFilterCode === 'Todos' || po.supplierCode === supplierFilterCode;
                const matchesOriginCountry = originCountryFilter === 'Todos' || po.originCountry === originCountryFilter;
                const matchesSearch = searchInput === '' ||
                                      po.id.toLowerCase().includes(searchInput) ||
                                      (po.parentOrderId && po.parentOrderId.toLowerCase().includes(searchInput));
                return matchesSupplier && matchesOriginCountry && matchesSearch;
            });

            // Separa as POs por categoria de aba
            const newRequestsPOs = filteredPOs.filter(po => po.overallApprovalStatus === 'Pendente');
            const negotiationsInProgressPOs = filteredPOs.filter(po => po.overallApprovalStatus === 'Negociado');
            const pendingManagementPOs = filteredPOs.filter(po => po.overallApprovalStatus === 'Aguardando Aprovação');
            const approvedManagementPOs = filteredPOs.filter(po => ['Aprovado', 'Rejeitado', 'Finalizado'].includes(po.overallApprovalStatus));

            // Função auxiliar para renderizar uma tabela
            const renderTable = (tbodyElement, poList, isApprovedRejectedTab = false) => {
                if (poList.length === 0) {
                    tbodyElement.innerHTML = `<tr><td colspan="${isApprovedRejectedTab ? 9 : 8}" class="text-center py-4 text-gray-500">Nenhuma PO encontrada.</td></tr>`;
                    return;
                }

                poList.forEach(po => {
                    const row = document.createElement('tr');
                    let statusIndicatorClass = '';
                    switch (po.overallApprovalStatus) {
                        case 'Pendente':
                            statusIndicatorClass = 'yellow';
                            break;
                        case 'Negociado':
                            statusIndicatorClass = 'purple';
                            break;
                        case 'Aguardando Aprovação':
                            statusIndicatorClass = 'yellow';
                            break;
                        case 'Aprovado':
                        case 'Finalizado':
                            statusIndicatorClass = 'green';
                            break;
                        case 'Rejeitado':
                            statusIndicatorClass = 'red';
                            break;
                        default:
                            statusIndicatorClass = 'gray';
                    }

                    let actionColumnHtml = '';
                    if (isApprovedRejectedTab) {
                        actionColumnHtml = `<td>${po.overallApprovalStatus}</td>`;
                    } else {
                        actionColumnHtml = `<td><button class="btn-primary" onclick="viewPurchaseOrderDetails('${po.id}')">Ver Detalhes</button></td>`;
                    }

                    row.innerHTML = `
                        <td>${po.parentOrderId || 'N/A'}</td>
                        <td>${po.id}</td>
                        <td>${po.supplierCode} - ${po.supplier}</td>
                        <td>${po.originCountry}</td>
                        <td>R$ ${parseFloat(po.newSupplierPriceTotal).toFixed(2).replace('.', ',')}</td>
                        <td><span class="status-indicator ${statusIndicatorClass}"></span>${po.overallApprovalStatus}</td>
                        <td>${po.date}</td>
                        ${actionColumnHtml}
                    `;
                    tbodyElement.appendChild(row);
                });
            };

            // Renderiza as tabelas com base na aba ativa
            if (currentPurchasingTab === 'newRequests') {
                renderTable(newRequestsTbody, newRequestsPOs);
            } else if (currentPurchasingTab === 'negotiationsInProgress') {
                renderTable(negotiationsInProgressTbody, negotiationsInProgressPOs);
            } else if (currentPurchasingTab === 'pendingManagement') {
                renderTable(pendingManagementTbody, pendingManagementPOs);
            } else if (currentPurchasingTab === 'approvedManagement') {
                renderTable(approvedManagementTbody, approvedManagementPOs, true); // Passa true para a aba de aprovados/rejeitados
            }
        }

        /**
         * Exibe os detalhes de uma Ordem de Compra (PO) específica.
         * @param {string} poId - O ID da PO a ser visualizada.
         */
        function viewPurchaseOrderDetails(poId) {
            currentPurchasingPO = generatedPurchaseOrders.find(po => po.id === poId);
            if (!currentPurchasingPO) {
                showMessage('Erro', 'Detalhes da PO não encontrados.', 'error');
                return;
            }

            document.getElementById('currentPoId').innerText = currentPurchasingPO.id;
            document.getElementById('poDetailId').innerText = currentPurchasingPO.id;
            document.getElementById('poDetailParentOrderId').innerText = currentPurchasingPO.parentOrderId || 'N/A';
            document.getElementById('poDetailSupplier').innerText = `${currentPurchasingPO.supplierCode} - ${currentPurchasingPO.supplier}`;
            document.getElementById('poDetailOriginCountry').innerText = currentPurchasingPO.originCountry;
            document.getElementById('poDetailNewSupplierPriceTotal').innerText = `R$ ${parseFloat(currentPurchasingPO.newSupplierPriceTotal).toFixed(2).replace('.', ',')}`;
            document.getElementById('poDetailCurrentInternalPriceTotal').innerText = `R$ ${parseFloat(currentPurchasingPO.currentInternalPriceTotal).toFixed(2).replace('.', ',')}`;
            document.getElementById('poDetailOverallApprovalStatus').innerText = currentPurchasingPO.overallApprovalStatus;
            document.getElementById('poDetailDate').innerText = currentPurchasingPO.date;

            const productsTableBody = document.getElementById('poDetailsProductsTableBody');
            productsTableBody.innerHTML = '';

            currentPurchasingPO.products.forEach(product => {
                const row = document.createElement('tr');
                const internalPrice = parseFloat(product.currentInternalUnitPrice);
                const supplierPrice = parseFloat(product.newSupplierUnitPrice);
                let priceClass = '';
                if (supplierPrice > internalPrice) {
                    priceClass = 'price-difference-positive';
                } else if (supplierPrice < internalPrice) {
                    priceClass = 'price-difference-negative';
                }

                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${product.quantity}</td>
                    <td>R$ ${internalPrice.toFixed(2).replace('.', ',')}</td>
                    <td class="${priceClass}">R$ ${supplierPrice.toFixed(2).replace('.', ',')}</td>
                    <td>${product.approvalStatus}</td>
                `;
                productsTableBody.appendChild(row);
            });

            // Gerencia a visibilidade da seção de negociação
            const negotiationSection = document.getElementById('negotiationSection');
            if (currentPurchasingPO.originCountry === 'Hong Kong' && currentPurchasingPO.overallApprovalStatus === 'Pendente') {
                negotiationSection.classList.remove('hidden');
            } else {
                negotiationSection.classList.add('hidden');
            }

            showScreen('purchaseOrderDetailsScreen');
        }

        /**
         * Simula a negociação de uma PO de Hong Kong.
         * Esta função atualiza o status da PO para 'Negociado' e simula novas condições.
         */
        function finalizeNegotiation() {
            if (!currentPurchasingPO || currentPurchasingPO.originCountry !== 'Hong Kong' || currentPurchasingPO.overallApprovalStatus !== 'Pendente') {
                showMessage('Erro', 'Esta PO não pode ser negociada neste momento.', 'error');
                return;
            }

            const negotiationNotes = document.getElementById('negotiationNotes').value.trim();
            if (!negotiationNotes) {
                showMessage('Atenção', 'Por favor, adicione algumas notas de negociação antes de finalizar.', 'warning');
                return;
            }

            // Simula uma nova negociação de preços para cada produto
            currentPurchasingPO.products.forEach(product => {
                const currentSupplierPrice = parseFloat(product.newSupplierUnitPrice);
                // Simula uma leve redução ou manutenção do preço do fornecedor
                product.newSupplierUnitPrice = (currentSupplierPrice * (1 - (Math.random() * 0.02))).toFixed(2); // Reduz em até 2%
                product.approvalStatus = 'Negociado'; // Atualiza o status do item
            });

            // Recalcula o valor total da PO com base nos novos preços
            currentPurchasingPO.newSupplierPriceTotal = currentPurchasingPO.products.reduce((sum, p) => sum + (parseFloat(p.newSupplierUnitPrice) * p.quantity), 0).toFixed(2);
            currentPurchasingPO.overallApprovalStatus = 'Negociado'; // Atualiza o status geral da PO
            currentPurchasingPO.negotiationNotes = negotiationNotes; // Salva as notas
            currentPurchasingPO.lastUpdateDate = new Date().toISOString().slice(0, 10); // Atualiza a data de modificação

            showMessage('Negociação Finalizada', `A PO ${currentPurchasingPO.id} foi marcada como 'Negociado'. Agora precisa ser enviada para aprovação do Gestor.`, 'success', () => {
                // Atualiza a exibição dos detalhes da PO
                viewPurchaseOrderDetails(currentPurchasingPO.id);
                synchronizeOrdersAndPOs(); // Sincroniza os dados globais
            });
        }

        /**
         * Simula a geração de um PDF para a PO.
         * @param {string} poId - O ID da PO para a qual gerar o PDF.
         */
        function generatePOPDF(poId) {
            const po = generatedPurchaseOrders.find(p => p.id === poId);
            if (!po) {
                showMessage('Erro', 'PO não encontrada para gerar PDF.', 'error');
                return;
            }

            let pdfContent = `
                --- ORDEM DE COMPRA (PO) ---
                Nº PO: ${po.id}
                ID Solicitação Principal: ${po.parentOrderId || 'N/A'}
                Fornecedor: ${po.supplierCode} - ${po.supplier}
                País de Origem: ${po.originCountry}
                Data de Geração: ${po.date}
                Status Geral da PO: ${po.overallApprovalStatus}
                Valor Total (Fornecedor): R$ ${parseFloat(po.newSupplierPriceTotal).toFixed(2).replace('.', ',')}
                Valor Total (Interno): R$ ${parseFloat(po.currentInternalPriceTotal).toFixed(2).replace('.', ',')}
                Cubagem Total: ${po.totalCubage} m³

                --- PRODUTOS ---
                ${po.products.map(p => `
                - Cód Produto: ${p.code}
                  Descrição: ${p.name}
                  Quantidade: ${p.quantity}
                  Valor Unit. Interno: R$ ${parseFloat(p.currentInternalUnitPrice).toFixed(2).replace('.', ',')}
                  Valor Unit. Fornecedor: R$ ${parseFloat(p.newSupplierUnitPrice).toFixed(2).replace('.', ',')}
                  Status Aprovação: ${p.approvalStatus}
                `).join('\n')}

                --- NOTAS DE NEGOCIAÇÃO ---
                ${po.negotiationNotes || 'Nenhuma nota de negociação.'}

                --------------------------
                Documento gerado em: ${new Date().toLocaleString('pt-BR')}
            `;

            document.getElementById('poPdfContent').innerText = pdfContent;
            document.getElementById('poPdfViewer').classList.add('active');
        }

        /**
         * Popula o filtro de fornecedores na tela da Central de Compras.
         */
        function populatePurchasingSupplierFilter() {
            const supplierFilterSelect = document.getElementById('poSupplierFilter');
            supplierFilterSelect.innerHTML = '<option value="Todos">Todos</option>'; // Opção padrão

            const uniqueSupplierCodes = new Set();
            generatedPurchaseOrders.forEach(po => {
                if (po.supplierCode) {
                    uniqueSupplierCodes.add(po.supplierCode);
                }
            });

            Array.from(uniqueSupplierCodes).sort().forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.innerText = `${code} - ${getSupplierNameFromCode(code)}`;
                supplierFilterSelect.appendChild(option);
            });
        }

        /**
         * Popula o filtro de país de origem na tela da Central de Compras.
         */
        function populatePurchasingOriginCountryFilter() {
            const originCountryFilterSelect = document.getElementById('poOriginCountryFilter');
            originCountryFilterSelect.innerHTML = '<option value="Todos">Todos</option>'; // Opção padrão

            const uniqueCountries = new Set();
            generatedPurchaseOrders.forEach(po => {
                if (po.originCountry) {
                    uniqueCountries.add(po.originCountry);
                }
            });

            Array.from(uniqueCountries).sort().forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.innerText = country;
                originCountryFilterSelect.appendChild(option);
            });
        }

        // Inicialização da página de compras
        document.addEventListener('DOMContentLoaded', () => {
            // Popula os filtros ao carregar a página
            populatePurchasingSupplierFilter();
            populatePurchasingOriginCountryFilter();
            switchPurchasingTab('newRequests'); // Ativa a aba "Novas Solicitações" por padrão
            renderPurchasingCenterTables(); // Renderiza a tabela de POs inicialmente

            // Adiciona event listener para o botão de logout
            const purchasingLogoutButton = document.getElementById('purchasingLogoutButton');
            if (purchasingLogoutButton) {
                purchasingLogoutButton.addEventListener('click', logout);
            }
        });
    </script>
</body>
</html>
